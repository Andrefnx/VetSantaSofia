{% load static %}

<!-- Sidebar Custom -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<!-- Script inline para aplicar estado antes de renderizar -->
<script>
(function() {
    var savedState = localStorage.getItem('sidebarState');
    if (savedState === 'collapsed') {
        document.documentElement.classList.add('sidebar-is-collapsed');
    }
})();
</script>

<div class="vet-sidebar" id="vetSidebar">
    <div class="vet-sidebar-header">
        <a href="{% url 'dashboard:dashboard' %}" class="vet-sidebar-logo">
            <img src="{% static 'img/logo.png' %}" alt="VetSantaSofia" height="40" />
        </a>
        <div class="vet-sidebar-toggle-container">
            <button class="vet-toggle-btn" id="sidebarToggleBtn" onclick="toggleVetSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>

    <div class="vet-sidebar-wrapper">
        <div class="vet-sidebar-content">

            <div class="vet-user-info">
                                        <span class="vet-user-name">{{ user.nombre }} {{ user.apellido }}</span>
                </div>
            <ul class="vet-nav-menu">

                <!-- DASHBOARD -->
                <li class="vet-nav-item {% if request.resolver_match.namespace == 'dashboard' %}active{% endif %}">
                    <a href="{% url 'dashboard:dashboard' %}" class="vet-nav-link">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>

                {% if user.is_superuser or user.is_staff or user.rol == 'recepcion' or user.rol == 'administracion' %}
                <!-- CAJA -->
                <li class="vet-nav-item {% if request.resolver_match.namespace == 'caja' %}active{% endif %}">
                    <a href="{% url 'caja:cashregister' %}" class="vet-nav-link">
                        <i class="bi bi-bag-check-fill"></i>
                        <span>Caja</span>
                    </a>
                </li>
                {% endif %}

                <li class="vet-nav-section">
                    <h4 class="vet-nav-section-title">Clínica</h4>
                </li>

                <!-- AGENDA -->
                <li class="vet-nav-item {% if request.resolver_match.namespace == 'agenda' %}active{% endif %}">
                    <a href="{% url 'agenda:agenda' %}" class="vet-nav-link">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Agenda</span>
                    </a>
                </li>

                <!-- PACIENTES -->
                <li class="vet-nav-item {% if request.resolver_match.namespace == 'pacientes' %}active{% endif %}">
                    <a href="{% url 'pacientes:pacientes' %}" class="vet-nav-link">
                        <i class="fas fa-paw"></i>
                        <span>Pacientes</span>
                    </a>
                </li>

                <li class="vet-nav-section">
                    <h4 class="vet-nav-section-title">Administración</h4>
                </li>

                <!-- INVENTARIO -->
                <li class="vet-nav-item {% if request.resolver_match.namespace == 'inventario' %}active{% endif %}">
                    <a href="{% url 'inventario:inventario' %}" class="vet-nav-link">
                        <i class="bi bi-box-seam"></i>
                        <span>Inventario</span>
                    </a>
                </li>

                <!-- SERVICIOS -->
                <li class="vet-nav-item {% if request.resolver_match.namespace == 'servicios' %}active{% endif %}">
                    <a href="{% url 'servicios:servicios' %}" class="vet-nav-link">
                        <i class="bi bi-prescription2"></i>
                        <span>Servicios</span>
                    </a>
                </li>

                <!-- REPORTES (Colapsable) -->
                <li class="vet-nav-item {% if request.resolver_match.namespace == 'reportes' %}active{% endif %}">
                    <a href="#reportesSubmenu" class="vet-nav-link" data-bs-toggle="collapse" aria-expanded="{% if request.resolver_match.namespace == 'reportes' %}true{% else %}false{% endif %}">
                        <i class="fas fa-chart-line"></i>
                        <span>Reportes</span>
                    </a>
                </li>
                <ul class="collapse vet-nav-submenu {% if request.resolver_match.namespace == 'reportes' %}show{% endif %}" id="reportesSubmenu">
                    <li class="vet-nav-item">
                        <a href="{% url 'reportes:inventario' %}" class="vet-nav-link vet-nav-sublink">
                            <i class="bi bi-box-seam"></i>
                            <span>Inventario</span>
                        </a>
                    </li>
                    <li class="vet-nav-item">
                        <a href="{% url 'reportes:caja' %}" class="vet-nav-link vet-nav-sublink">
                            <i class="bi bi-cash-stack"></i>
                            <span>Caja / Ventas</span>
                        </a>
                    </li>
                    <li class="vet-nav-item">
                        <a href="{% url 'reportes:clinica' %}" class="vet-nav-link vet-nav-sublink">
                            <i class="fas fa-notes-medical"></i>
                            <span>Clínica</span>
                        </a>
                    </li>
                    <li class="vet-nav-item">
                        <a href="{% url 'reportes:hospitalizacion' %}" class="vet-nav-link vet-nav-sublink">
                            <i class="fas fa-hospital"></i>
                            <span>Hospitalización</span>
                        </a>
                    </li>
                    <li class="vet-nav-item">
                        <a href="{% url 'reportes:servicios' %}" class="vet-nav-link vet-nav-sublink">
                            <i class="bi bi-prescription2"></i>
                            <span>Servicios</span>
                        </a>
                    </li>
                </ul>

            </ul>
            
            <!-- Usuario y Logout -->
            <div class="vet-sidebar-user">
                <div class="vet-sidebar-divider"></div>
                
                <a href="#" onclick="event.preventDefault(); document.getElementById('sidebar-logout-form').submit();" class="vet-logout-link">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </a>
                <form id="sidebar-logout-form" method="POST" action="{% url 'logout' %}" style="display: none;">
                    {% csrf_token %}
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Custom para Sidebar -->
<script>
function toggleVetSidebar() {
    const sidebar = document.getElementById('vetSidebar');
    const mainPanel = document.querySelector('.main-panel');
    const html = document.documentElement;
    const isMobile = window.innerWidth <= 991;
    
    if (isMobile) {
        // En mobile: toggle entre colapsada (70px) y expandida (260px)
        sidebar.classList.toggle('mobile-open');
    } else {
        // En desktop: comportamiento normal
        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            if (mainPanel) mainPanel.classList.remove('sidebar-collapsed');
            html.classList.remove('sidebar-is-collapsed');
            localStorage.setItem('sidebarState', 'expanded');
        } else {
            sidebar.classList.add('collapsed');
            if (mainPanel) mainPanel.classList.add('sidebar-collapsed');
            html.classList.add('sidebar-is-collapsed');
            localStorage.setItem('sidebarState', 'collapsed');
        }
    }
}

// Restaurar estado del sidebar cuando el DOM esté listo
(function() {
    const sidebar = document.getElementById('vetSidebar');
    const mainPanel = document.querySelector('.main-panel');
    const savedState = localStorage.getItem('sidebarState');
    const isMobile = window.innerWidth <= 991;
    
    if (isMobile) {
        // En mobile: empezar colapsada (sin clase mobile-open)
        sidebar.classList.remove('mobile-open');
    } else {
        // En desktop: restaurar estado guardado
        if (savedState === 'collapsed') {
            sidebar.classList.add('collapsed');
            if (mainPanel) {
                mainPanel.classList.add('sidebar-collapsed');
            }
        } else {
            sidebar.classList.remove('collapsed');
            if (mainPanel) {
                mainPanel.classList.remove('sidebar-collapsed');
            }
        }
    }
})();

// Manejar cambios de tamaño de ventana
window.addEventListener('resize', function() {
    const sidebar = document.getElementById('vetSidebar');
    const mainPanel = document.querySelector('.main-panel');
    const isMobile = window.innerWidth <= 991;
    
    if (isMobile) {
        // Limpiar clases de desktop
        sidebar.classList.remove('collapsed');
        if (mainPanel) {
            mainPanel.classList.remove('sidebar-collapsed');
        }
    } else {
        // Limpiar clases de mobile
        sidebar.classList.remove('mobile-open');
        // Restaurar estado guardado
        const savedState = localStorage.getItem('sidebarState');
        if (savedState === 'collapsed') {
            sidebar.classList.add('collapsed');
            if (mainPanel) {
                mainPanel.classList.add('sidebar-collapsed');
            }
        }
    }
});
</script>
<!-- End Sidebar Custom -->