================================================================================
ANÃLISIS DIAGNÃ“STICO: APP AGENDA
================================================================================
Proyecto: VetSantaSofia
Fecha: 15 de diciembre de 2025
Modo: Solo anÃ¡lisis - Sin modificaciones

================================================================================
1. MODELOS - ARQUITECTURA Y ROL FUNCIONAL
================================================================================

1.1. HorarioFijoVeterinario
----------------------------
UbicaciÃ³n: agenda/models.py (lÃ­neas 40-82)

DefiniciÃ³n:
Modelo que define el horario fijo semanal de cada veterinario. Define bloques 
horarios que se repiten cada semana (Lunes a Domingo).

Campos principales:
- veterinario: FK a CustomUser (limit_choices_to={'rol': 'veterinario'})
- dia_semana: IntegerField con choices (0=Lunes, 6=Domingo)
- hora_inicio / hora_fin: TimeField
- activo: BooleanField para activar/desactivar temporalmente
- notas: TextField opcional

Restricciones:
- unique_together: ['veterinario', 'dia_semana', 'hora_inicio']
- ValidaciÃ³n: hora_inicio < hora_fin

Rol funcional real:
âœ“ Plantilla: Define horario base que se repite semanalmente
âœ“ Generador: Usado para generar DisponibilidadBloquesDia automÃ¡ticamente
âœ“ ValidaciÃ³n: Verifica disponibilidad al crear citas
âœ“ ConfiguraciÃ³n: Permite al admin configurar horarios recurrentes

Vistas que lo usan:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vista                            â”‚ FunciÃ³n                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ crear_cita()                     â”‚ Valida que veterinario tenga     â”‚
â”‚                                  â”‚ horario para ese dÃ­a             â”‚
â”‚ obtener_horario_semanal()        â”‚ Lee horario semanal completo     â”‚
â”‚ guardar_horario_semanal()        â”‚ Crea/actualiza horario semanal   â”‚
â”‚ regenerar_disponibilidades()     â”‚ Regenera disponibilidad diaria   â”‚
â”‚ horarios_fijos()                 â”‚ Lista horarios del veterinario   â”‚
â”‚ crear/editar/eliminar_horario()  â”‚ CRUD de horarios fijos           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dependencias de otras apps:
- cuentas.CustomUser (FK veterinario)

RelaciÃ³n con otros modelos de agenda:
- HorarioFijoVeterinario â†’ genera â†’ DisponibilidadBloquesDia (automÃ¡tico)
- HorarioFijoVeterinario â†’ valida â†’ Cita (al crear)

Estado: âœ… ACTIVO - Utilizado para configuraciÃ³n de horarios recurrentes


1.2. DisponibilidadVeterinario
-------------------------------
UbicaciÃ³n: agenda/models.py (lÃ­neas 84-145)

DefiniciÃ³n:
Modelo para gestionar excepciones al horario fijo. Permite definir vacaciones,
licencias, ausencias y disponibilidades extra para fechas especÃ­ficas.

Campos principales:
- veterinario: FK a CustomUser (limit_choices_to={'rol': 'veterinario'})
- fecha: DateField (fecha especÃ­fica de la excepciÃ³n)
- hora_inicio / hora_fin: TimeField
- tipo: CharField con choices:
  * vacaciones
  * licencia
  * ausencia
  * disponible_extra
- notas: TextField opcional

Validaciones:
- hora_inicio < hora_fin
- No solapamiento de disponibilidades para mismo veterinario en misma fecha

Rol funcional real:
âœ“ Excepciones: Sobrescribe horario fijo para fechas especÃ­ficas
âœ“ Ausencias: Marca dÃ­as no laborables (vacaciones, licencias)
âœ“ Disponibilidad extra: Permite agregar horarios fuera del horario fijo
âœ“ ValidaciÃ³n: Bloquea creaciÃ³n de citas en fechas marcadas como ausencia

Vistas que lo usan:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vista                       â”‚ FunciÃ³n                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ crear_cita()                â”‚ Valida que no haya ausencia        â”‚
â”‚ disponibilidad_mes()        â”‚ Lista excepciones del mes          â”‚
â”‚ disponibilidad_dia()        â”‚ Lista excepciones del dÃ­a          â”‚
â”‚ crear_disponibilidad()      â”‚ Crea nueva excepciÃ³n               â”‚
â”‚ editar_disponibilidad()     â”‚ Modifica excepciÃ³n                 â”‚
â”‚ eliminar_disponibilidad()   â”‚ Elimina excepciÃ³n                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dependencias:
- cuentas.CustomUser (FK veterinario)

Uso REAL:
- Se consulta en crear_cita() para validar que no hay ausencias
- GestiÃ³n manual desde la interfaz de agenda
- NO se genera automÃ¡ticamente

Estado: âœ… ACTIVO - Usado para excepciones y ausencias


1.3. DisponibilidadBloquesDia
------------------------------
UbicaciÃ³n: agenda/models.py (lÃ­neas 147-210)

DefiniciÃ³n:
Disponibilidad diaria basada en bloques de 15 minutos. Representa la 
disponibilidad REAL de un veterinario para un dÃ­a especÃ­fico.

Campos principales:
- veterinario: FK a CustomUser (limit_choices_to={'rol': 'veterinario'})
- fecha: DateField
- trabaja: BooleanField (si trabaja ese dÃ­a)
- rangos: JSONField - Lista de dicts {"start_block": int, "end_block": int}
  * Cada bloque representa 15 minutos (0-96 bloques por dÃ­a)
- notas: TextField opcional

Restricciones:
- unique_together: ['veterinario', 'fecha']
- ValidaciÃ³n de rangos: 0 <= start_block < end_block <= 96
- Auto-merge de rangos solapados

Rol funcional real:
âœ“ Disponibilidad real: Almacena disponibilidad granular por dÃ­a
âœ“ Sistema de bloques: Divide dÃ­a en 96 bloques de 15 minutos
âœ“ GeneraciÃ³n automÃ¡tica: Se crea desde HorarioFijoVeterinario
âœ“ ValidaciÃ³n granular: Valida citas bloque por bloque

Vistas que lo usan:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vista                            â”‚ FunciÃ³n                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ agenda_bloques_dia()             â”‚ Obtiene bloques disponibles      â”‚
â”‚ agendar_cita_por_bloques()       â”‚ Agenda en bloques especÃ­ficos    â”‚
â”‚ guardar_horario_semanal()        â”‚ Genera para 8 semanas            â”‚
â”‚ regenerar_disponibilidades()     â”‚ Regenera desde horario fijo      â”‚
â”‚ _build_day_blocks()              â”‚ Construye vista de 96 bloques    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GeneraciÃ³n automÃ¡tica:
- FunciÃ³n: _generar_disponibilidades_desde_horario_semanal()
- Origen: HorarioFijoVeterinario
- Alcance: Genera para prÃ³ximas 8 semanas
- ActualizaciÃ³n: Solo si notas indican generaciÃ³n automÃ¡tica

Dependencias:
- cuentas.CustomUser (FK veterinario)

Estado: âœ… ACTIVO - Sistema de bloques para agenda granular


1.4. Cita
----------
UbicaciÃ³n: agenda/models.py (lÃ­neas 212-365)

DefiniciÃ³n:
Modelo central para gestiÃ³n de citas veterinarias. Almacena agendamiento de
pacientes con veterinarios para servicios especÃ­ficos.

Campos principales:
- paciente: FK a Paciente (CASCADE)
- veterinario: FK a CustomUser (SET_NULL, limit_choices_to={'rol': 'veterinario'})
- servicio: FK a Servicio (SET_NULL, opcional)
- fecha: DateField
- hora_inicio / hora_fin: TimeField
- start_block / end_block: PositiveSmallIntegerField (Ã­ndices de bloques)
- tipo: CharField con choices:
  * consulta, vacunacion, cirugia, control, emergencia, peluqueria, otro
- estado: CharField con choices:
  * pendiente, confirmada, en_curso, completada, cancelada, no_asistio
- motivo: TextField
- notas: TextField opcional
- recordatorio_enviado: BooleanField

Restricciones:
- unique_together: ['veterinario', 'fecha', 'hora_inicio']
- ValidaciÃ³n compleja en clean():
  * SincronizaciÃ³n automÃ¡tica de bloques desde hora_inicio y servicio.duracion
  * CÃ¡lculo automÃ¡tico de hora_fin desde bloques o servicio
  * ValidaciÃ³n de disponibilidad en DisponibilidadBloquesDia
  * ValidaciÃ³n de no solapamiento con otras citas

Property calculada:
- duracion_minutos: Calcula duraciÃ³n desde horas o desde servicio

Rol funcional real:
âœ“ Agendamiento: Reserva horario veterinario-paciente
âœ“ Flujo operativo: Rastrea estado de la cita (pendiente â†’ en_curso â†’ completada)
âœ“ IntegraciÃ³n clÃ­nica: Se vincula con Consulta al iniciar atenciÃ³n
âœ“ ValidaciÃ³n: Garantiza no solapamientos y respeta disponibilidad
âœ“ Reportes: Fuente para estadÃ­sticas de agenda

Vistas que lo usan:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vista                        â”‚ FunciÃ³n                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ agenda()                     â”‚ Vista principal de agenda          â”‚
â”‚ citas_dia()                  â”‚ Lista citas de un dÃ­a              â”‚
â”‚ crear_cita()                 â”‚ Crea nueva cita con validaciÃ³n     â”‚
â”‚ editar_cita()                â”‚ Modifica cita existente            â”‚
â”‚ eliminar_cita()              â”‚ Elimina cita                       â”‚
â”‚ iniciar_cita()               â”‚ Cambia estado a 'en_curso'         â”‚
â”‚ agenda_bloques_dia()         â”‚ Muestra citas en vista de bloques  â”‚
â”‚ agendar_cita_por_bloques()   â”‚ Agenda por bloques especÃ­ficos     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dependencias de otras apps:

â–¸ ForeignKey DESDE Cita:
  1. pacientes.Paciente â†’ cita.paciente (CASCADE)
  2. cuentas.CustomUser â†’ cita.veterinario (SET_NULL)
  3. servicios.Servicio â†’ cita.servicio (SET_NULL, opcional)

â–¸ Usado POR otras apps:
  1. clinica.views.historial_medico()
     - Lee citas del paciente para mostrar en historial
     - IntegraciÃ³n: Al crear Consulta, marca cita como 'completada'
     
  2. clinica.views.crear_consulta() / editar_consulta()
     - Recibe cita_id opcional
     - Si existe cita, actualiza estado a 'completada'
     
  3. pacientes.views.perfil_paciente()
     - Muestra citas prÃ³ximas del paciente
     
  4. dashboard.views.dashboard_administracion()
     - EstadÃ­sticas de citas del dÃ­a
     - Conteo de pacientes atendidos (citas completadas)
     
  5. dashboard.views.dashboard_veterinario()
     - Citas del dÃ­a para el veterinario logueado
     
  6. dashboard.views.obtener_citas_dia()
     - API para obtener citas de un dÃ­a especÃ­fico

Impacto en operaciones crÃ­ticas:
âœ“ Agenda: Es el modelo CENTRAL de agendamiento
âœ“ ClÃ­nica: Se vincula con Consulta, NO hay dependencia dura
âœ“ Reportes: Fuente de verdad para estadÃ­sticas de atenciÃ³n

Estado: âœ… ACTIVO Y CRÃTICO - Centro del sistema de agendamiento

================================================================================
2. FUNCIONES AUXILIARES
================================================================================

2.1. time_to_block_index(value: time) -> int
---------------------------------------------
Convierte una hora (time) a Ã­ndice de bloque de 15 minutos (0-95).
- Ejemplo: 09:00 â†’ bloque 36 (9*60/15)
- Validaciones: mÃºltiplo de 15, rango 0-1440 minutos

2.2. block_index_to_time(index: int) -> time
---------------------------------------------
Convierte Ã­ndice de bloque (0-96) a hora.
- Ejemplo: bloque 36 â†’ 09:00
- Caso lÃ­mite: bloque 96 â†’ 23:59 (fin del dÃ­a)

2.3. _build_day_blocks(availability, citas_qs, fecha)
------------------------------------------------------
Construye lista de 96 bloques con estados:
- 'unavailable': veterinario no trabaja
- 'available': veterinario disponible
- 'occupied': bloque ocupado por cita

Retorna JSON con informaciÃ³n completa de cada bloque.

2.4. _generar_disponibilidades_desde_horario_semanal(vet, semanas)
-------------------------------------------------------------------
Genera DisponibilidadBloquesDia para un veterinario:
- Lee HorarioFijoVeterinario
- Genera para prÃ³ximas 'semanas' semanas
- Solo actualiza registros generados automÃ¡ticamente

================================================================================
3. USO REAL EN EL SISTEMA
================================================================================

3.1. DÃ³nde se CREA
------------------

â–¸ HorarioFijoVeterinario
  - Manualmente: guardar_horario_semanal() - Admin configura horario semanal
  - Manualmente: crear_horario_fijo() - Crear horario individual

â–¸ DisponibilidadVeterinario
  - Manualmente: crear_disponibilidad() - Admin crea excepciÃ³n (vacaciones, etc.)

â–¸ DisponibilidadBloquesDia
  - AutomÃ¡ticamente: _generar_disponibilidades_desde_horario_semanal()
    * Trigger: Al guardar HorarioFijoVeterinario
    * Trigger: Al llamar regenerar_disponibilidades_veterinario()

â–¸ Cita
  - Manualmente: crear_cita() - Usuario agenda cita desde interfaz
  - Manualmente: agendar_cita_por_bloques() - Agenda usando vista de bloques


3.2. DÃ³nde se EDITA
-------------------

â–¸ HorarioFijoVeterinario
  - editar_horario_fijo() - Modifica horario especÃ­fico
  - guardar_horario_semanal() - Reemplaza todos los horarios del veterinario

â–¸ DisponibilidadVeterinario
  - editar_disponibilidad() - Modifica excepciÃ³n

â–¸ DisponibilidadBloquesDia
  - AutomÃ¡ticamente: Al regenerar desde horario semanal
  - LÃ³gica: Solo actualiza si notas indican generaciÃ³n automÃ¡tica

â–¸ Cita
  - editar_cita() - Modifica cualquier campo de la cita
  - iniciar_cita() - Cambia estado a 'en_curso'
  - Desde clinica: Al crear/editar Consulta, marca cita como 'completada'


3.3. DÃ³nde se LEE/USA
---------------------

â–¸ Lectura desde agenda:
  - agenda() - Vista principal, lista veterinarios y prepara contexto
  - citas_dia() - Obtiene citas de un dÃ­a especÃ­fico
  - agenda_bloques_dia() - Vista de bloques con disponibilidad y citas

â–¸ Lectura desde clinica:
  - historial_medico() - Muestra citas pasadas del paciente
  - crear_consulta() - Obtiene cita_id para marcar como completada
  - Flujo: Cita.estado = 'en_curso' â†’ crear Consulta â†’ Cita.estado = 'completada'

â–¸ Lectura desde pacientes:
  - perfil_paciente() - Muestra prÃ³ximas citas del paciente

â–¸ Lectura desde dashboard:
  - dashboard_administracion() - Citas del dÃ­a, estadÃ­sticas
  - dashboard_veterinario() - Citas del veterinario logueado
  - obtener_citas_dia() - API para calendario


3.4. Signals y lÃ³gica implÃ­cita
--------------------------------

âš  NO EXISTEN signals.py ni services.py en la app agenda

LÃ³gica implÃ­cita:
- Validaciones en clean() de modelos (ejecutadas en save())
- GeneraciÃ³n automÃ¡tica en _generar_disponibilidades_desde_horario_semanal()
  * Llamada desde guardar_horario_semanal()
  * Llamada desde regenerar_disponibilidades_veterinario()

IntegraciÃ³n con clinica:
- NO hay signal automÃ¡tico
- IntegraciÃ³n MANUAL: clinica.views actualiza Cita.estado al crear Consulta
- CÃ³digo explÃ­cito en clinica/views.py lÃ­neas 337-345

================================================================================
4. SOLAPAMIENTOS Y DUPLICACIÃ“N
================================================================================

4.1. Solapamiento con otros modelos
------------------------------------

âš  Posible duplicaciÃ³n de concepto: DisponibilidadVeterinario vs DisponibilidadBloquesDia

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DisponibilidadVeterinario      â”‚ DisponibilidadBloquesDia         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Excepciones al horario fijo    â”‚ Disponibilidad granular diaria   â”‚
â”‚ GestiÃ³n manual                 â”‚ GeneraciÃ³n automÃ¡tica            â”‚
â”‚ Tipos: vacaciones, ausencia    â”‚ Bloques de 15 minutos            â”‚
â”‚ hora_inicio/fin (simple)       â”‚ rangos JSON (complejo)           â”‚
â”‚ Usado en validaciÃ³n bÃ¡sica     â”‚ Usado en sistema de bloques      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â¿Son redundantes?
NO - Tienen propÃ³sitos diferentes:
- DisponibilidadVeterinario: Excepciones simples (vacaciones, licencias)
- DisponibilidadBloquesDia: Sistema granular para agenda por bloques

Pero hay SOLAPAMIENTO funcional:
- Ambos pueden representar "veterinario no disponible en fecha X"
- DisponibilidadVeterinario se valida en crear_cita()
- DisponibilidadBloquesDia se valida en Cita.clean()

âš  Potencial inconsistencia si no estÃ¡n sincronizados


4.2. Â¿Legacy o Activo?
----------------------

Estado de cada modelo:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Modelo                         â”‚ Estado  â”‚ Evidencia            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HorarioFijoVeterinario         â”‚ âœ… ACTIVOâ”‚ CRUD completo, usado â”‚
â”‚ DisponibilidadVeterinario      â”‚ âœ… ACTIVOâ”‚ CRUD, validaciones   â”‚
â”‚ DisponibilidadBloquesDia       â”‚ âœ… ACTIVOâ”‚ Sistema de bloques   â”‚
â”‚ Cita                           â”‚ âœ… ACTIVOâ”‚ Centro de agenda     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Todos los modelos estÃ¡n ACTIVOS y en uso.

Templates activos:
- agenda/agenda.html - Interfaz principal de agenda
- MÃºltiples JS: agenda-sistema.js, agenda_bloques.js

Admin activo:
- Todos los modelos registrados en admin.py
- CRUD completo desde Django Admin

================================================================================
5. RIESGO Y CLASIFICACIÃ“N
================================================================================

Nivel de criticidad: ğŸ”´ CRÃTICA

5.1. JustificaciÃ³n
------------------

â–¸ Impacto en operaciones
  - Agenda: Sin estos modelos, NO hay sistema de agendamiento
  - ClÃ­nica: Consultas referencian citas (integraciÃ³n fuerte)
  - Reportes: Dashboard depende de estadÃ­sticas de citas

â–¸ Dependencias tÃ©cnicas

  CustomUser (veterinario)
     â†“ FK
  HorarioFijoVeterinario
     â†“ genera
  DisponibilidadBloquesDia
     â†“ valida
  Cita â† FK â† Paciente
     â†“ FK â† Servicio
  Consulta (clinica)

â–¸ Flujo operativo crÃ­tico:
  1. Admin configura HorarioFijoVeterinario
  2. Sistema genera DisponibilidadBloquesDia
  3. Usuario agenda Cita (valida disponibilidad)
  4. Veterinario inicia Cita (estado â†’ 'en_curso')
  5. Veterinario crea Consulta (marca Cita como 'completada')
  6. Dashboard reporta estadÃ­sticas desde Cita

Eliminar app agenda causarÃ­a:
âœ— PÃ©rdida total del sistema de agendamiento
âœ— Ruptura de flujo operativo (no hay forma de agendar pacientes)
âœ— PÃ©rdida de trazabilidad (no se sabe quiÃ©n atendiÃ³ a quiÃ©n)
âœ— Dashboard sin datos de citas
âœ— ClÃ­nica pierde referencia a cita (pero tolerarÃ­a SET_NULL)

â–¸ ProtecciÃ³n existente:
  âœ“ Cita.paciente = CASCADE (si eliminas paciente, elimina sus citas)
  âœ“ Cita.veterinario = SET_NULL (tolera eliminaciÃ³n de veterinario)
  âœ“ Cita.servicio = SET_NULL (tolera eliminaciÃ³n de servicio)
  âš  Clinica.Consulta NO tiene FK a Cita (solo referencia vÃ­a cita_id en request)


5.2. Sensibilidad a cambios
----------------------------

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OperaciÃ³n                      â”‚ Riesgoâ”‚ RazÃ³n                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Agregar campo a Cita           â”‚ ğŸŸ¢ Bajoâ”‚ Solo migraciÃ³n      â”‚
â”‚ Cambiar estado de cita         â”‚ ğŸŸ¢ Bajoâ”‚ Flujo bien definido â”‚
â”‚ Modificar horario fijo         â”‚ ğŸŸ  Medioâ”‚ Regenerar disponib. â”‚
â”‚ Eliminar cita                  â”‚ ğŸŸ  Medioâ”‚ Puede romper flujo  â”‚
â”‚ Cambiar sistema de bloques     â”‚ ğŸ”´ Altoâ”‚ Afecta validaciones â”‚
â”‚ Eliminar DisponibilidadBloques â”‚ ğŸ”´ Altoâ”‚ Rompe sistema       â”‚
â”‚ Eliminar modelo Cita           â”‚ ğŸ”´ CRÃTICOâ”‚ Colapsa agenda    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


5.3. Puntos crÃ­ticos
--------------------

âš  CRÃTICO 1: SincronizaciÃ³n entre DisponibilidadVeterinario y DisponibilidadBloquesDia
  - Si hay excepciÃ³n (vacaciones) pero bloques generados, puede haber inconsistencia
  - ValidaciÃ³n en crear_cita() usa DisponibilidadVeterinario
  - ValidaciÃ³n en Cita.clean() usa DisponibilidadBloquesDia

âš  CRÃTICO 2: IntegraciÃ³n manual con clinica
  - NO hay FK directo Consulta â†’ Cita
  - ActualizaciÃ³n de estado es manual (puede olvidarse)
  - Si falla actualizaciÃ³n, cita queda en 'en_curso' eternamente

âš  CRÃTICO 3: CÃ¡lculo de bloques en clean()
  - LÃ³gica compleja en Cita.clean()
  - SincronizaciÃ³n automÃ¡tica start_block/end_block desde hora_inicio
  - Si falla validaciÃ³n, mensaje puede ser confuso

âš  MEDIO 4: GeneraciÃ³n automÃ¡tica de disponibilidades
  - Solo actualiza registros con notas especÃ­ficas
  - Si admin modifica manual, puede perderse en regeneraciÃ³n

================================================================================
6. CONCLUSIÃ“N Y RECOMENDACIONES
================================================================================

6.1. Veredicto: MANTENER - CRÃTICA
-----------------------------------

Razones:
1. Modelo CENTRAL del sistema: Sin agenda, no hay operaciÃ³n clÃ­nica
2. IntegraciÃ³n profunda: clinica, pacientes, dashboard dependen de ella
3. Arquitectura sofisticada: Sistema de bloques bien implementado
4. Sin redundancia real: Cada modelo tiene propÃ³sito especÃ­fico
5. Activo y necesario: Usado diariamente en operaciones

La app agenda es IRREMPLAZABLE en el sistema actual.


6.2. Calidad tÃ©cnica: ğŸŸ¢ BUENA (con Ã¡reas de mejora)
-----------------------------------------------------

Fortalezas:
âœ“ Validaciones robustas en clean()
âœ“ Sistema de bloques granular (15 min)
âœ“ GeneraciÃ³n automÃ¡tica de disponibilidades
âœ“ Ãndices de BD bien configurados
âœ“ Unique constraints apropiados
âœ“ Permisos por rol (veterinario vs admin)

Debilidades detectadas:
âš  SincronizaciÃ³n manual con clinica (no automÃ¡tica)
âš  Posible inconsistencia entre DisponibilidadVeterinario y DisponibilidadBloquesDia
âš  LÃ³gica compleja en clean() puede ser difÃ­cil de mantener
âš  No hay flag 'eliminado' (eliminaciÃ³n fÃ­sica)


6.3. RefactorizaciÃ³n futura (solo anÃ¡lisis)
--------------------------------------------

Si en el futuro se considerara mejorar:

â–¸ Problema 1: IntegraciÃ³n manual con clinica
  Estado actual: clinica.views actualiza Cita.estado manualmente
  
  EvaluaciÃ³n futura:
  - Considerar signal post_save en Consulta para actualizar Cita
  - O agregar FK Consulta â†’ Cita (OneToOneField opcional)
  - O mantener actual (explÃ­cito es mejor que implÃ­cito)

â–¸ Problema 2: SincronizaciÃ³n de disponibilidades
  Estado actual: Dos modelos pueden representar "no disponible"
  
  EvaluaciÃ³n futura:
  - Al crear DisponibilidadVeterinario (ausencia), actualizar DisponibilidadBloquesDia
  - O unificar en un solo modelo con tipos
  - O documentar claramente que son sistemas independientes

â–¸ Problema 3: EliminaciÃ³n fÃ­sica de citas
  Estado actual: cita.delete() elimina fÃ­sicamente
  
  EvaluaciÃ³n futura:
  - Agregar campo 'activo' o 'cancelado_definitivo'
  - Mantener registro histÃ³rico
  - O mantener actual si no se requiere auditorÃ­a estricta

â–¸ Problema 4: Campos start_block/end_block
  Estado actual: Se calculan automÃ¡ticamente en clean()
  
  EvaluaciÃ³n futura:
  - PodrÃ­an ser @property calculadas dinÃ¡micamente
  - O mantener actual para mejor performance en queries


6.4. DocumentaciÃ³n recomendada
-------------------------------

Para desarrolladores:
- Cita.clean() sincroniza automÃ¡ticamente bloques desde hora_inicio
- HorarioFijoVeterinario genera DisponibilidadBloquesDia para 8 semanas
- DisponibilidadVeterinario NO actualiza DisponibilidadBloquesDia automÃ¡ticamente
- Al crear Consulta, actualizar manualmente Cita.estado = 'completada'
- Sistema de bloques: 96 bloques de 15 min por dÃ­a (0-95)

Para usuarios:
- Configurar horario semanal primero (HorarioFijoVeterinario)
- Sistema genera disponibilidades automÃ¡ticamente
- Para excepciones, usar DisponibilidadVeterinario
- Citas validan disponibilidad automÃ¡ticamente
- Estado de cita refleja progreso de atenciÃ³n

================================================================================
RESUMEN EJECUTIVO
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Aspecto           â”‚ EvaluaciÃ³n                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Estado            â”‚ âœ… Activo, crÃ­tico, usado diariamente        â”‚
â”‚ Criticidad        â”‚ ğŸ”´ CRÃTICA - Centro del sistema operativo    â”‚
â”‚ DuplicaciÃ³n       â”‚ âœ… Sin duplicaciÃ³n significativa             â”‚
â”‚ Calidad tÃ©cnica   â”‚ ğŸŸ¢ Buena, con validaciones robustas          â”‚
â”‚ Arquitectura      â”‚ ğŸŸ¢ Bien diseÃ±ada, sistema de bloques sÃ³lido  â”‚
â”‚ Integraciones     â”‚ ğŸŸ  Manual con clinica, funciona pero mejorableâ”‚
â”‚ Riesgo eliminar   â”‚ ğŸ”´ CRÃTICO - Colapsa operaciÃ³n               â”‚
â”‚ RecomendaciÃ³n     â”‚ MANTENER - NO TOCAR                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Modelos por criticidad:
- Cita: ğŸ”´ CRÃTICA ABSOLUTA - Centro de agendamiento
- HorarioFijoVeterinario: ğŸ”´ CRÃTICA - ConfiguraciÃ³n base
- DisponibilidadBloquesDia: ğŸ”´ CRÃTICA - Sistema de bloques
- DisponibilidadVeterinario: ğŸŸ  IMPORTANTE - Excepciones

Relaciones crÃ­ticas:
- Cita â†’ Paciente (CASCADE) ğŸ”´
- Cita â†’ Veterinario (SET_NULL) ğŸŸ 
- Cita â†’ Servicio (SET_NULL) ğŸŸ¢
- IntegraciÃ³n con clinica.Consulta (manual) ğŸŸ 

AcciÃ³n: NO TOCAR. App fundamental para operaciÃ³n diaria.

================================================================================
DEPENDENCIAS EXTERNAS (apps que usan agenda)
================================================================================

1. clinica
   - Importa: Cita
   - FunciÃ³n: Marca cita como completada al crear Consulta
   - Impacto: ALTO - Flujo operativo depende de esto
   - Tipo: IntegraciÃ³n manual (explÃ­cita)

2. pacientes
   - Importa: Cita
   - FunciÃ³n: Muestra prÃ³ximas citas en perfil
   - Impacto: MEDIO - UI informativa
   - Tipo: Solo lectura

3. dashboard
   - Importa: Cita
   - FunciÃ³n: EstadÃ­sticas y reportes
   - Impacto: ALTO - MÃ©tricas operativas
   - Tipo: Solo lectura

4. cuentas
   - Usada por: HorarioFijoVeterinario, DisponibilidadVeterinario, DisponibilidadBloquesDia, Cita
   - FunciÃ³n: FK a CustomUser (veterinarios)
   - Impacto: CRÃTICO - No funciona sin veterinarios
   - Tipo: Dependencia fundamental

5. servicios
   - Usada por: Cita
   - FunciÃ³n: FK opcional para asociar servicio
   - Impacto: MEDIO - Opcional pero Ãºtil
   - Tipo: Referencia enriquecedora

6. pacientes
   - Usada por: Cita
   - FunciÃ³n: FK a Paciente (quien recibe atenciÃ³n)
   - Impacto: CRÃTICO - No hay cita sin paciente
   - Tipo: Dependencia fundamental

================================================================================
FIN DEL ANÃLISIS DIAGNÃ“STICO
================================================================================
