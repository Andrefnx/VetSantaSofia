================================================================================
                    ANÃLISIS DE LA APP "CUENTAS"
================================================================================
Fecha: 15 de Diciembre de 2025
Sistema: VetSantaSofia - Sistema de GestiÃ³n Veterinaria
================================================================================

================================================================================
1. MODELOS DE LA APP
================================================================================

MODELO: CustomUser (Modelo Principal)
--------------------------------------
Archivo: cuentas/models.py

DESCRIPCIÃ“N:
Modelo de autenticaciÃ³n customizado que extiende AbstractBaseUser y 
PermissionsMixin. Reemplaza completamente al modelo User de Django estÃ¡ndar. 
Es el nÃºcleo del sistema de usuarios y personal de la clÃ­nica.

CAMPOS PRINCIPALES:
- rut (CharField, unique) - Campo de login principal
- username (CharField, unique, auto-generado) - Generado automÃ¡ticamente desde RUT sin guiones
- nombre, apellido (CharField)
- correo (EmailField, unique)
- telefono, direccion (CharField, opcional)
- tipo_contrato (CharField, opcional)
- rol (CharField, choices) - VALORES: 'administracion', 'veterinario', 'recepcion'
- is_staff, is_active, is_superuser (BooleanField) - Permisos Django
- date_joined (DateTimeField)

MANAGER PERSONALIZADO: CustomUserManager
- Normaliza RUT automÃ¡ticamente (elimina puntos, espacios, agrega guiÃ³n)
- Genera username automÃ¡tico desde RUT
- Implementa create_user() y create_superuser()

PROPIEDADES/MÃ‰TODOS:
- nombre_completo (property) - Retorna nombre + apellido
- get_rol_display_custom() - Retorna "AdministraciÃ³n" para superusuarios
- save() - Override para normalizar RUT y generar username antes de guardar

================================================================================
2. USO REAL DEL MODELO
================================================================================

DÃ“NDE SE CREAN LOS REGISTROS
-----------------------------

1. VIA ADMIN DE DJANGO
   - cuentas/admin.py - CustomUserAdmin registrado
   - Permite crear/editar usuarios desde /admin/cuentas/customuser/

2. VIA REGISTRO PÃšBLICO
   - login/views.py lÃ­nea 159-171 - funciÃ³n register_view()
   - Endpoint: /register/
   - Crea usuarios con User.objects.create_user()
   - Asigna is_staff=True si tipo_contrato='administracion'

3. VIA COMMAND MANAGEMENT
   - cuentas/management/commands/generar_usernames.py
   - Comando: python manage.py generar_usernames
   - Genera usernames para usuarios existentes sin username

DÃ“NDE SE EDITAN LOS REGISTROS
------------------------------

1. ADMIN DE DJANGO
   - EdiciÃ³n completa de campos, permisos, grupos
   
2. VISTA DE VETERINARIOS (NO IMPLEMENTADA completamente)
   - clinica/templates/veterinarios/veterinarios.html
   - Tiene modales HTML para editar pero SIN backend conectado
   - Funciones JS: abrirModalNuevoVeterinario(), switchToEditModeVeterinario()
   - ESTADO: NO IMPLEMENTADAS

DÃ“NDE SE LEEN/CONSULTAN LOS REGISTROS
--------------------------------------

A. AUTENTICACIÃ“N Y LOGIN
   - login/views.py - login_view() 
     * Busca usuario por RUT (normalizado)
     * Verifica password con user.check_password()
   
   - cuentas/auth_backend.py - RUTAuthBackend
   - cuentas/backends.py - RutBackend
     * Backend de autenticaciÃ³n que busca por RUT normalizado

B. AGENDA (referencias a veterinarios)
   - agenda/views.py lÃ­neas 77-83
     * CustomUser.objects.filter(rol='veterinario', is_active=True)
     * Filtra solo veterinarios para asignar citas
     * Si el usuario logueado es veterinario (no admin), solo ve su propia agenda

   - agenda/models.py
     * HorarioFijoVeterinario.veterinario (FK a CustomUser, limit_choices_to={'rol': 'veterinario'})
     * DisponibilidadVeterinario.veterinario (FK a CustomUser, limit_choices_to={'rol': 'veterinario'})
     * DisponibilidadBloquesDia.veterinario (FK a CustomUser, limit_choices_to={'rol': 'veterinario'})
     * Cita.veterinario (FK a CustomUser, limit_choices_to={'rol': 'veterinario'})

C. CLÃNICA (asignaciÃ³n de consultas, cirugÃ­as, hospitalizaciones)
   - clinica/views.py
     * LÃ­nea 86: CustomUser.objects.filter(rol='veterinario') - Para ficha de paciente
     * LÃ­nea 508-529: Estrategia de fallback para obtener veterinarios:
       1. Primero filtra por rol='veterinario'
       2. Si no hay, excluye admin/recepciÃ³n
       3. Si aÃºn no hay, usa todos los usuarios
     * LÃ­nea 641: Endpoint API /clinica/api/veterinarios/ - Retorna JSON de veterinarios

   - clinica/models.py
     * Consulta.veterinario (FK a AUTH_USER_MODEL)
     * Hospitalizacion.veterinario (FK a AUTH_USER_MODEL)
     * Cirugia.veterinario_cirujano (FK a AUTH_USER_MODEL, related_name='cirugias_realizadas')
     * RegistroDiario.veterinario (FK a AUTH_USER_MODEL)
     * InsumoConsulta.confirmado_por (FK a AUTH_USER_MODEL)
     * InsumoCirugia.confirmado_por (FK a AUTH_USER_MODEL)
     * InsumoHospitalizacion.confirmado_por (FK a AUTH_USER_MODEL)

D. PACIENTES
   - pacientes/views.py lÃ­nea 185
     * CustomUser.objects.filter(rol='veterinario') - Para dropdown de veterinarios

   - pacientes/models.py lÃ­nea 7
     * User = get_user_model() - Referencia indirecta a CustomUser

E. CAJA
   - caja/models.py
     * Caja.usuario (FK a AUTH_USER_MODEL, on_delete=CASCADE)
     * Cobro.usuario (FK a AUTH_USER_MODEL, on_delete=PROTECT)

   - caja/views.py
     * LÃ­neas 21, 58: Control de acceso por rol:
       if not (request.user.is_superuser or request.user.is_staff or 
               request.user.rol in ['recepcion', 'administracion'])

F. INVENTARIO
   - inventario/models.py lÃ­nea 67
     * Insumo.usuario_ultimo_movimiento (FK a AUTH_USER_MODEL, SET_NULL)

   - inventario/views.py lÃ­nea 20
     * Control de acceso: if request.user.rol not in ['administracion', 'veterinario']

G. DASHBOARD
   - dashboard/views.py lÃ­neas 47-54
     * Busca veterinario activo: CustomUser.objects.filter(rol='veterinario', is_active=True).first()
     * Verifica si usuario es admin: usuario.rol == 'administracion' or usuario.is_superuser

H. SCRIPTS DE INICIALIZACIÃ“N
   - agenda/management/commands/inicializar_horarios.py
   - agenda/management/commands/regenerar_disponibilidades.py
   - agenda/management/commands/inicializar_agenda.py
   - Todos importan from cuentas.models import CustomUser para obtener veterinarios

================================================================================
3. SOLAPAMIENTO CON OTRAS APPS
================================================================================

CONCLUSIÃ“N: NO HAY SOLAPAMIENTO

VERIFICACIÃ“N:
- NO existe otro modelo de Usuario o Personal en el sistema
- NO existe modelo "Veterinario" separado
- NO existe modelo "Empleado" o "Staff" en otra app
- La app gestion tiene modelos legacy (Cliente, Mascota, Consulta) pero NO tiene modelo de usuarios
- La app hospital tiene Hospitalizacion pero referencia a pacientes.Paciente, no a usuarios

ES EL ÃšNICO MODELO DE USUARIOS DEL SISTEMA

CustomUser es el modelo central de autenticaciÃ³n y personal. Todas las apps que 
necesitan referenciar usuarios utilizan:
- settings.AUTH_USER_MODEL en ForeignKeys
- get_user_model() para importar dinÃ¡micamente
- from cuentas.models import CustomUser directamente

================================================================================
4. NIVEL DE RIESGO
================================================================================

ğŸ”´ CRÃTICA - NO TOCAR

RAZONES:

1. ES EL AUTH_USER_MODEL DEL PROYECTO
   - Definido en veteriaria/settings.py lÃ­nea 158: AUTH_USER_MODEL = 'cuentas.CustomUser'
   - NO SE PUEDE cambiar sin migraciÃ³n extremadamente compleja y riesgosa

2. SISTEMA DE AUTENTICACIÃ“N COMPLETO DEPENDE DE ELLA
   - 2 backends personalizados de autenticaciÃ³n
   - Login por RUT en lugar de username/email
   - Sistema de permisos Django integrado

3. MÃšLTIPLES FOREIGNKEYS EN TODA LA BASE DE DATOS
   - agenda: 4 modelos (HorarioFijoVeterinario, DisponibilidadVeterinario, DisponibilidadBloquesDia, Cita)
   - clinica: 7 modelos (Consulta, Hospitalizacion, Cirugia, RegistroDiario, InsumoConsulta, InsumoCirugia, InsumoHospitalizacion)
   - caja: 2 modelos (Caja, Cobro)
   - inventario: 1 modelo (Insumo)
   - Total: 14+ modelos con ForeignKey a CustomUser

4. CONTROL DE ACCESO BASADO EN CAMPO rol
   - Toda la lÃ³gica de permisos usa request.user.rol en lugar de grupos Django
   - Cambiar estructura requerirÃ­a refactorizar decenas de vistas

5. MIGRACIONES EXISTENTES DEPENDEN DE ELLA
   - MÃºltiples migraciones en todas las apps referencian settings.AUTH_USER_MODEL
   - Es el modelo base de la migraciÃ³n inicial (0001_initial.py)

================================================================================
5. DEPENDENCIAS CRÃTICAS CON OTRAS APPS
================================================================================

Apps que DEPENDEN crÃ­ticamente de cuentas.CustomUser:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ App         â”‚ Nivel Dependencia  â”‚ Modelos Afectados â”‚ Tipo de Uso      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ agenda      â”‚ ğŸ”´ CRÃTICA        â”‚ 4 modelos         â”‚ FK, filtros rol  â”‚
â”‚ clinica     â”‚ ğŸ”´ CRÃTICA        â”‚ 7 modelos         â”‚ FK, API, control â”‚
â”‚ caja        â”‚ ğŸ”´ CRÃTICA        â”‚ 2 modelos         â”‚ FK CASCADE/PROT  â”‚
â”‚ login       â”‚ ğŸ”´ CRÃTICA        â”‚ -                 â”‚ Auth, registro   â”‚
â”‚ dashboard   â”‚ ğŸŸ  ALTA           â”‚ -                 â”‚ Filtros por rol  â”‚
â”‚ pacientes   â”‚ ğŸŸ  ALTA           â”‚ -                 â”‚ Dropdowns vets   â”‚
â”‚ inventario  â”‚ ğŸŸ¡ MEDIA          â”‚ 1 modelo          â”‚ FK SET_NULL      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
6. CAMPOS O MODELOS POCO USADOS
================================================================================

CAMPOS CON USO LIMITADO:

1. tipo_contrato
   - Solo usado en registro (login/views.py)
   - Se asigna pero raramente se consulta
   - Parece redundante con el campo rol

2. direccion
   - Campo opcional
   - Solo se captura en registro
   - No se usa en ninguna vista o lÃ³gica de negocio

3. telefono
   - Campo opcional
   - Se captura pero no se usa en vistas
   - No se muestra en interfaces de usuario

CAMPOS SUBUTILIZADOS PERO IMPORTANTES:

- is_staff y is_superuser
  * Usados en control de acceso pero no de forma consistente
  * En algunos lugares se verifica is_superuser, en otros rol == 'administracion'
  * Genera inconsistencias en permisos

================================================================================
7. PROBLEMAS DETECTADOS
================================================================================

A. VISTA DE VETERINARIOS NO FUNCIONAL
   - clinica/templates/veterinarios/veterinarios.html
   - Tiene interfaz completa con modales CRUD
   - NO tiene endpoints backend para:
     * Crear veterinario
     * Editar veterinario
     * Eliminar veterinario
     * Listar veterinarios (usa datos hardcodeados en HTML)

B. INCONSISTENCIA EN AUTENTICACIÃ“N
   - 2 backends diferentes:
     * cuentas.auth_backend.RUTAuthBackend
     * cuentas.backends.RutBackend
   - veteriaria/settings.py lÃ­nea 170-173 define ambos

C. ESTRATEGIA DE FALLBACK FRÃGIL
   - clinica/views.py lÃ­neas 517-529
   - Si no hay veterinarios con rol='veterinario', usa TODOS los usuarios
   - Esto puede causar asignaciÃ³n incorrecta de citas/consultas

D. CONTROL DE ACCESO NO ESTANDARIZADO
   - Mezcla de is_staff, is_superuser y rol
   - No usa grupos de Django (groups)
   - Dificulta mantenimiento y auditorÃ­a de permisos

================================================================================
8. DATOS DE USO
================================================================================

Campos del modelo CustomUser usados en el sistema:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Campo          â”‚ Uso                        â”‚ Frecuencia  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ rut            â”‚ Login, identificaciÃ³n      â”‚ ğŸ”´ MUY ALTO â”‚
â”‚ username       â”‚ Backend auth, internal     â”‚ ğŸŸ  ALTO     â”‚
â”‚ nombre         â”‚ Display en UI, dropdowns   â”‚ ğŸ”´ MUY ALTO â”‚
â”‚ apellido       â”‚ Display en UI, dropdowns   â”‚ ğŸ”´ MUY ALTO â”‚
â”‚ correo         â”‚ Registro, validaciÃ³n       â”‚ ğŸŸ  ALTO     â”‚
â”‚ rol            â”‚ Control de acceso, filtros â”‚ ğŸ”´ MUY ALTO â”‚
â”‚ is_staff       â”‚ Permisos Django admin      â”‚ ğŸŸ¡ MEDIO    â”‚
â”‚ is_superuser   â”‚ Permisos mÃ¡ximos           â”‚ ğŸŸ¡ MEDIO    â”‚
â”‚ is_active      â”‚ Filtro de usuarios         â”‚ ğŸŸ  ALTO     â”‚
â”‚ telefono       â”‚ Opcional, poco usado       â”‚ ğŸŸ¢ BAJO     â”‚
â”‚ direccion      â”‚ Opcional, poco usado       â”‚ ğŸŸ¢ BAJO     â”‚
â”‚ tipo_contrato  â”‚ Registro, redundante       â”‚ ğŸŸ¢ BAJO     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
9. CONCLUSIÃ“N DE LA APP
================================================================================

ESTADO ACTUAL:
La app cuentas es EL PILAR CENTRAL del sistema. Es el modelo de autenticaciÃ³n 
customizado que reemplaza al User estÃ¡ndar de Django.

Â¿DEBE QUEDARSE TAL CUAL?
âœ… SÃ - Debe quedarse con su estructura actual porque:
- Es el AUTH_USER_MODEL del proyecto
- Tiene migraciones aplicadas en producciÃ³n
- 14+ modelos dependen de ella con ForeignKeys
- Cambiar esto requerirÃ­a recrear toda la base de datos

Â¿DEBE REFACTORIZARSE EN EL FUTURO?
ğŸŸ  SÃ, PERO CON CUIDADO - Solo refactorizaciones menores:

CANDIDATOS PARA MEJORA (sin tocar modelo):
1. Consolidar backends de autenticaciÃ³n (eliminar duplicado)
2. Estandarizar control de acceso (usar solo rol o migrar a grupos Django)
3. Implementar endpoints backend para CRUD de veterinarios
4. Agregar Ã­ndices en campo rol para mejorar performance
5. Documentar claramente uso de is_staff vs rol

NO HACER:
âŒ Renombrar el modelo
âŒ Cambiar AUTH_USER_MODEL
âŒ Eliminar campos (pueden tener datos en producciÃ³n)
âŒ Cambiar tipo de campos existentes
âŒ Eliminar la app

Â¿PUEDE ELIMINARSE?
âŒ ABSOLUTAMENTE NO
- Es imposible eliminar el modelo de autenticaciÃ³n
- Django requiere un modelo User
- Toda la lÃ³gica de login, permisos y sesiones depende de Ã©l
- Eliminarla romperÃ­a completamente el sistema

================================================================================
10. RECOMENDACIONES FINALES
================================================================================

PRIORIDAD ALTA - Para implementar PRONTO:
1. âœ… Implementar backend para CRUD de veterinarios en /clinica/
2. âœ… Consolidar backends de autenticaciÃ³n (elegir uno solo)
3. âœ… Documentar uso de roles vs permisos Django
4. âœ… Agregar Ã­ndice en campo rol:
   indexes = [models.Index(fields=['rol'])]

PRIORIDAD MEDIA - Para planificar:
1. Evaluar migraciÃ³n de campo rol a Django Groups
2. Unificar control de acceso en decoradores/mixins reutilizables
3. Eliminar campos telefono, direccion o darles uso real
4. Decidir si tipo_contrato debe eliminarse o usarse mÃ¡s

PRIORIDAD BAJA - Consideraciones futuras:
1. Agregar modelo VeterinarioProfile con especialidades, horarios preferidos, etc.
2. Implementar sistema de permisos granular (ej: permisos por tipo de consulta)
3. Agregar auditorÃ­a de cambios en usuarios (logs de modificaciones)

================================================================================
11. RESUMEN EJECUTIVO
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Aspecto             â”‚ EvaluaciÃ³n                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nivel de Riesgo     â”‚ ğŸ”´ CRÃTICA - NO TOCAR                     â”‚
â”‚ Dependencias        â”‚ 14+ modelos en 7 apps                      â”‚
â”‚ Solapamiento        â”‚ âœ… Ninguno (es Ãºnico)                      â”‚
â”‚ Estado              â”‚ ğŸŸ¢ Funcional pero con deuda tÃ©cnica menor  â”‚
â”‚ AcciÃ³n recomendada  â”‚ ğŸ› ï¸ Mantener + refactorizar vistas        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VEREDICTO FINAL:
La app cuentas debe mantenerse intacta a nivel de modelo. Solo se deben hacer 
mejoras en las vistas, endpoints de API y lÃ³gica de control de acceso, SIN 
tocar la estructura del modelo CustomUser.

================================================================================
FIN DEL ANÃLISIS
================================================================================
