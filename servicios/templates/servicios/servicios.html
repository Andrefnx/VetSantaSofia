{% extends "partials/base_table.html" %}
{% load static %}

{% block title %}Servicios Veterinarios{% endblock %}

{% block extra_css %}
<style>
.tabs-estado {
    display: flex;
    gap: 0;
    border-bottom: 2px solid #e0e0e0;
}

.tab-estado {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    transition: all 0.3s ease;
}

.tab-estado:hover {
    color: #0b4d2d;
    background: rgba(105, 192, 135, 0.1);
}

.tab-estado.active {
    color: #0b4d2d;
    border-bottom-color: #69c087;
    background: rgba(105, 192, 135, 0.1);
}

.tab-estado i {
    margin-right: 0.5rem;
}
</style>
{% endblock %}

{% block table_title %}
<i class="fas fa-stethoscope"></i> Servicios Veterinarios
{% endblock %}

{% block table_filters %}

{% endblock %}

{% block table_tabs %}
<!-- Pestañas de estado -->
<div class="tabs-estado" style="margin: 1rem 0; padding: 0 1rem;">
    <button type="button" class="tab-estado {% if estado_actual != 'archivados' %}active{% endif %}" 
            onclick="cambiarEstadoServicios('activos')">
        <i class="fas fa-check-circle"></i> Activos
    </button>
    <button type="button" class="tab-estado {% if estado_actual == 'archivados' %}active{% endif %}" 
            onclick="cambiarEstadoServicios('archivados')">
        <i class="fas fa-archive"></i> Archivados
    </button>
</div>
{% endblock %}

{% block table_buttons %}
{% if user.is_staff or user.is_superuser %}
<button type="button" class="btn-primary-action" onclick="abrirModalNuevoServicio()">
    <i class="fas fa-plus-circle"></i> Nuevo Servicio
</button>
{% endif %}
{% endblock %}

{% block table_columns %}
<th>Servicio</th>
<th>Categoría</th>
<th>Precio</th>
<th>Duración</th>
<th>Gestión</th>
{% endblock %}

{% block table_rows %}
{% for servicio in servicios %}
<tr data-id="{{ servicio.idServicio }}" data-categoria="{{ servicio.categoria|default_if_none:'' }}" data-descripcion="{{ servicio.descripcion|default_if_none:'' }}" 
    style="cursor: pointer;" 
    onclick="if (event.target.closest('.manage-wheel')) return; const btn = this.querySelector('.manage-options button[onclick*=view]'); if(btn) btn.click();">
    <td>{{ servicio.nombre }}</td>
    <td>{{ servicio.categoria }}</td>
    <td>${{ servicio.precio|floatformat:0 }}</td>
    <td>{{ servicio.duracion }} min</td>

    <td>
        <div class="manage-wheel">
            <button type="button" onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display: none;">
                <button type="button" onclick="abrirModalServicio(this, 'view')">
                    <i class="fas fa-eye"></i> Ver detalles
                </button>
                {% if user.is_staff or user.is_superuser %}
                <button type="button" onclick="abrirModalServicio(this, 'edit')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                {% if not servicio.activo %}
                <button type="button" onclick="abrirModalArchivarServicio(this)">
                    <i class="fas fa-undo"></i> Restaurar
                </button>
                {% else %}
                <button type="button" onclick="abrirModalArchivarServicio(this)">
                    <i class="fas fa-archive"></i> Archivar
                </button>
                {% endif %}
                <button type="button" onclick="abrirModalEliminarServicio(this)">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
                {% endif %}
            </div>
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="5">No hay servicios registrados.</td>
</tr>
{% endfor %}
{% endblock %}

{% block modals %}

<!-- Modal: Ver/Editar Detalles Servicio -->
<div class="vet-modal-overlay hide" id="modalServicio">
    <div class="vet-custom-modal" style="max-width: 900px; width: 100%;">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>
                    <i class="fas fa-stethoscope"></i>
                    <span id="modalServicioTitulo">Detalles del Servicio</span>
                </h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                   onclick="closeVetModal('modalServicio')"></i>
            </div>
            <div class="vet-modal-body" style="max-height: 70vh; overflow-y: auto;">
                
                <!-- ⭐ PESTAÑAS DE NAVEGACIÓN (Detalles / Historial) -->
                <ul class="nav nav-tabs mb-3" id="modalServicioTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-detalles-servicio" data-bs-toggle="tab" data-bs-target="#content-detalles-servicio" type="button" role="tab">
                            <i class="fas fa-info-circle"></i> Detalles
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-historial-servicio" data-bs-toggle="tab" data-bs-target="#content-historial-servicio" type="button" role="tab" onclick="cargarHistorialModalServicio()">
                            <i class="fas fa-history"></i> Historial
                        </button>
                    </li>
                </ul>

                <!-- CONTENIDO DE LAS PESTAÑAS -->
                <div class="tab-content" id="modalServicioTabsContent">
                    <!-- PESTAÑA: DETALLES -->
                    <div class="tab-pane fade show active" id="content-detalles-servicio" role="tabpanel">

                        <!-- IDENTIFICACIÓN GENERAL -->
                        <div class="detail-section mb-4">
                            <h6 class="detail-section-title">
                                <i class="fas fa-tag"></i> Identificación General
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="text-muted small">Nombre del Servicio</label>
                                    <p class="field-view fw-bold mb-0" data-field="nombre">-</p>
                                    <input class="field-edit form-control d-none" data-field="nombre">
                                </div>
                                <div class="col-md-6">
                                    <label class="text-muted small">Categoría</label>
                                    <p class="field-view mb-0" data-field="categoria">-</p>
                                    <select class="field-edit form-control d-none" data-field="categoria">
                                        <option value="">Selecciona...</option>
                                        <option value="Servicios Veterinarios Comunes">Servicios Veterinarios Comunes</option>
                                        <option value="Servicios de Diagnóstico">Servicios de Diagnóstico</option>
                                        <option value="Procedimientos clínicos">Procedimientos clínicos</option>
                                        <option value="Cirugía">Cirugía</option>
                                        <option value="Servicios Complementarios">Servicios Complementarios</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <label class="text-muted small">Descripción</label>
                                    <p class="field-view mb-0" data-field="descripcion">-</p>
                                    <textarea class="field-edit form-control d-none" data-field="descripcion"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- INFORMACIÓN COMERCIAL -->
                        <div class="detail-section mb-4">
                            <h6 class="detail-section-title">
                                <i class="fas fa-dollar-sign"></i> Información Comercial
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="text-muted small">Precio</label>
                                    <p class="field-view fw-bold mb-0" data-field="precio">-</p>
                                    <input type="number" min="0" class="field-edit form-control d-none"
                                           data-field="precio">
                                </div>
                                <div class="col-md-4">
                                    <label class="text-muted small">Duración</label>
                                    <div class="field-view mb-0" data-field="duracion">-</div>
                                    <div class="input-group field-edit d-none">
                                        <input type="number" min="0" class="form-control field-edit" data-field="duracion" placeholder="Ej: 30">
                                        <span class="input-group-text">min</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div><!-- FIN: PESTAÑA DETALLES -->

                    <!-- ⭐ PESTAÑA: HISTORIAL -->
                    <div class="tab-pane fade" id="content-historial-servicio" role="tabpanel">
                        <!-- Filtros del historial -->
                        <div class="historial-filtros mb-3" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label class="form-label" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem;">
                                    <i class="fas fa-filter"></i> Tipo de Evento
                                </label>
                                <select class="form-select form-select-sm" id="filtroTipoEventoServicio" onchange="filtrarHistorialServicio()">
                                    <option value="">Todos los eventos</option>
                                    <option value="cambio_precio_servicio">Cambio de Precio</option>
                                    <option value="cambio_duracion">Cambio de Duración</option>
                                    <option value="cambio_categoria">Cambio de Categoría</option>
                                    <option value="modificacion_informacion">Modificación de Información</option>
                                    <option value="activacion">Activación</option>
                                    <option value="desactivacion">Desactivación</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label class="form-label" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem;">
                                    <i class="fas fa-exclamation-circle"></i> Criticidad
                                </label>
                                <select class="form-select form-select-sm" id="filtroCriticidadServicio" onchange="filtrarHistorialServicio()">
                                    <option value="">Todas las criticidades</option>
                                    <option value="critica">Crítica</option>
                                    <option value="alta">Alta</option>
                                    <option value="media">Media</option>
                                    <option value="baja">Baja</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn btn-sm btn-outline-secondary" onclick="limpiarFiltrosHistorialServicio()">
                                    <i class="fas fa-times"></i> Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="historial-loader-servicio" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando historial...</span>
                            </div>
                            <p class="mt-3 text-muted">Cargando historial del servicio...</p>
                        </div>
                        <div id="historial-contenido-servicio" style="display: none;">
                            <!-- El contenido se carga dinámicamente con AJAX -->
                        </div>
                    </div><!-- FIN: PESTAÑA HISTORIAL -->

                </div><!-- FIN: tab-content -->

            </div>
            <div class="vet-modal-body" style="border-top:1px solid #eee; text-align:right;">
                <button type="button" class="vet-btn vet-btn-grey" id="btnEditarServicio"
                        onclick="switchToEditModeServicio()">
                    <i class="bi bi-pencil-fill"></i> Editar
                </button>
                 <button type="button" class="vet-btn-delete" id="btnEliminarServicio"
                        onclick="abrirModalEliminarServicio(this)">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
                <button type="button" class="vet-btn vet-btn-primary d-none" id="btnGuardarServicio"
                        onclick="guardarServicioEditado()">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
               
            </div>
        </div>
    </div>
</div>

<!-- Modal: Archivar/Restaurar Servicio -->
<div class="vet-modal-overlay hide" id="modalArchivarServicio">
    <div class="vet-modal-compact">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #6b8e6b;">
                <h3><i class="fas fa-archive"></i> Archivar Servicio</h3>
                <i class="bi bi-x" onclick="closeArchivarServicioModal()"></i>
            </div>
            <div class="vet-modal-body">
                <p id="archivarServicioMensaje" class="text-center mb-4">¿Estás seguro que deseas archivar este servicio? Podrás restaurarlo desde la pestaña de archivados.</p>
                <div class="vet-modal-footer">
                    <button type="button" class="vet-btn vet-btn-grey" onclick="closeArchivarServicioModal()">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="vet-btn vet-btn-primary" id="btnConfirmarArchivarServicio">
                        <i class="fas fa-archive"></i> Archivar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Eliminar Servicio (Compacto UI estándar) -->
<div class="vet-modal-overlay hide" id="modalEliminarServicio">
    <div class="vet-modal-compact">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #b71c1c;">
                <h3><i class="bi bi-trash3-fill"></i> Eliminar Servicio</h3>
                <i class="bi bi-x" onclick="closeEliminarServicioModal()"></i>
            </div>
            <div class="vet-modal-body">
                <p id="eliminarServicioMensaje" class="text-center mb-4">¿Estás seguro que deseas eliminar permanentemente este servicio? Esta acción no se puede deshacer.</p>
                <div class="vet-modal-footer">
                    <button type="button" class="vet-btn vet-btn-grey" onclick="closeEliminarServicioModal()">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="vet-btn-delete" id="btnConfirmarEliminarServicio">
                        <i class="bi bi-trash3-fill"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/servicios/crud_servicios.js' %}"></script>

<style>
/* Estilos para las pestañas del modal de servicio */
#modalServicioTabs {
    border-bottom: 2px solid #e0e0e0;
    margin-bottom: 1.5rem;
}

#modalServicioTabs .nav-link {
    color: #757575;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

#modalServicioTabs .nav-link:hover {
    color: #6b8e6b;
    background: rgba(175, 225, 175, 0.1);
}

#modalServicioTabs .nav-link.active {
    color: #6b8e6b;
    border-bottom-color: #afe1af;
    background: rgba(175, 225, 175, 0.1);
}

#modalServicioTabs .nav-link i {
    font-size: 1.1rem;
}

/* Contenido de las pestañas */
#modalServicioTabsContent .tab-pane {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Spinner de carga */
#historial-loader-servicio .spinner-border {
    color: #afe1af !important;
}
</style>

<script>
// ⭐ CARGAR HISTORIAL DEL SERVICIO DINÁMICAMENTE
let historialServicioCargado = false;

function cargarHistorialModalServicio() {
    if (historialServicioCargado) {
        return;
    }
    
    const modal = document.getElementById('modalServicio');
    const servicioId = modal.getAttribute('data-objeto-id');
    
    if (!servicioId) {
        console.error('No se encontró el ID del servicio');
        return;
    }
    
    document.getElementById('historial-loader-servicio').style.display = 'block';
    document.getElementById('historial-contenido-servicio').style.display = 'none';
    
    fetch(`/historial/resumen/servicio/${servicioId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            document.getElementById('historial-contenido-servicio').innerHTML = html;
            document.getElementById('historial-loader-servicio').style.display = 'none';
            document.getElementById('historial-contenido-servicio').style.display = 'block';
            historialServicioCargado = true;
        })
        .catch(error => {
            console.error('Error al cargar historial:', error);
            document.getElementById('historial-loader-servicio').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error al cargar historial:</strong> ${error.message}
                    <br><small>Por favor, recarga la página e intenta nuevamente.</small>
                </div>
            `;
        });
}

// ⭐ FILTRAR EVENTOS DEL HISTORIAL DE SERVICIO
function filtrarHistorialServicio() {
    const tipoEvento = document.getElementById('filtroTipoEventoServicio').value;
    const criticidad = document.getElementById('filtroCriticidadServicio').value;
    
    const eventos = document.querySelectorAll('#historial-contenido-servicio .timeline-item');
    let eventosVisibles = 0;
    
    eventos.forEach(evento => {
        const eventoTipo = evento.getAttribute('data-tipo-evento');
        const eventoCriticidad = evento.getAttribute('data-criticidad');
        
        const cumpleTipo = !tipoEvento || eventoTipo === tipoEvento;
        const cumpleCriticidad = !criticidad || eventoCriticidad === criticidad;
        
        if (cumpleTipo && cumpleCriticidad) {
            evento.style.display = '';
            eventosVisibles++;
        } else {
            evento.style.display = 'none';
        }
    });
    
    const contenedor = document.getElementById('historial-contenido-servicio');
    let mensajeSinResultados = contenedor.querySelector('.sin-resultados-filtro');
    
    if (eventosVisibles === 0) {
        if (!mensajeSinResultados) {
            mensajeSinResultados = document.createElement('div');
            mensajeSinResultados.className = 'alert alert-info text-center sin-resultados-filtro';
            mensajeSinResultados.innerHTML = '<i class="fas fa-filter"></i> No hay eventos que coincidan con los filtros seleccionados';
            contenedor.appendChild(mensajeSinResultados);
        }
        mensajeSinResultados.style.display = 'block';
    } else {
        if (mensajeSinResultados) {
            mensajeSinResultados.style.display = 'none';
        }
    }
}

// ⭐ LIMPIAR FILTROS DEL HISTORIAL DE SERVICIO
function limpiarFiltrosHistorialServicio() {
    document.getElementById('filtroTipoEventoServicio').value = '';
    document.getElementById('filtroCriticidadServicio').value = '';
    filtrarHistorialServicio();
}

// ⭐ RESETEAR AL CERRAR EL MODAL DE SERVICIO
const originalCloseVetModalServicio = window.closeVetModal;
window.closeVetModal = function(modalId) {
    if (modalId === 'modalServicio') {
        historialServicioCargado = false;
        document.getElementById('historial-contenido-servicio').innerHTML = '';
        limpiarFiltrosHistorialServicio();
        document.getElementById('tab-detalles-servicio').click();
    }
    
    originalCloseVetModalServicio(modalId);
};
</script>
{% endblock %}
