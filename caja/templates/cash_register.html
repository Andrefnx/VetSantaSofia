{% extends 'partials/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Caja Registradora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'caja/css/cash_register.css' %}">
{% endblock %}

{% block content %}
<h1><i class="bi bi-bag-check-fill"></i> Caja</h1>

<!-- Main Layout: 1/3 Dashboard + 2/3 Sales -->
<div class="cash-layout">
    <!-- Left Sidebar (1/3) - Dashboard -->


    <!-- Right Main Area (2/3) - Sales -->
    <div class="cash-main">
        <!-- LEFT: Products List -->
        <div class="products-section">

            <!-- SEARCH -->
            <div class="search-bar">
                <input type="text" class="form-control" placeholder="Buscar producto o servicio..." id="searchInput"
                    oninput="filterProducts()">
            </div>

            <!-- FILTER TABS -->
            <div class="product-tabs">
                <button class="product-tab active" onclick="switchCategory(this, 'all')">
                    <i class="fas fa-th"></i> Todos
                </button>
                <button class="product-tab" onclick="switchCategory(this, 'servicios')">
                    <i class="fas fa-stethoscope"></i> Servicios
                </button>
                <button class="product-tab" onclick="switchCategory(this, 'productos')">
                    <i class="fas fa-box"></i> Productos
                </button>
               
            </div>

            <!-- LISTA -->
            <div class="products-list" id="productsList">

                <!-- ============================ -->
                <!--          SERVICIOS           -->
                <!-- ============================ -->
                {% for servicio in servicios %}
                <div class="product-list-item" data-category="servicios"
                    onclick="addToCart('{{ servicio.nombre|escapejs }}', {{ servicio.precio }})">

                    <div class="icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-stethoscope"></i>
                    </div>

                    <div class="info">
                        <h6>{{ servicio.nombre }}</h6>
                        <p>{{ servicio.categoria }}</p>
                    </div>

                    <div class="price">${{ servicio.precio|intcomma }}</div>
                    <button class="add-btn">+</button>
                </div>
                {% empty %}
                <p class="empty-section">No hay servicios registrados.</p>
                {% endfor %}

           <!-- ============================ -->
<!--          PRODUCTOS           -->
<!-- ============================ -->
{% for producto in productos %}
<div class="product-list-item" data-category="productos"
    onclick="addToCart('{{ producto.medicamento|escapejs }}', {{ producto.precio_venta }})">

    <div class="icon">
        <i class="fas fa-box"></i>
    </div>

    <div class="info">
        <h6>{{ producto.medicamento }}</h6>
        <p>Stock: {{ producto.stock_actual }} {{ producto.unidad_medida }}</p>
    </div>

    <div class="price">${{ producto.precio_venta|intcomma }}</div>
    <button class="add-btn">+</button>
</div>
{% empty %}
<p class="empty-section">No hay productos en inventario.</p>
{% endfor %}

            </div>
        </div>

        <!-- RIGHT: Shopping Cart -->
        <div class="cart-section">
            <!-- Cart Header -->
            <div class="cart-header" style="overflow: visible;">
                <h5><i class="bi bi-bag-check-fill"></i> Carrito de Venta</h5>

                <div class="cart-header-inner" style="overflow: visible;">
                    <div class="cart-header-actions" style="overflow: visible;">
                        <button class="save-draft-btn" onclick="abrirModalPagosPendientes()" style="margin-right: 8px; position: relative; overflow: visible !important;">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Pagos Pendientes</span>
                            <span id="badgePagosPendientes" style="display: block; position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; min-width: 22px; height: 22px; padding: 0 6px; font-size: 12px; font-weight: bold; line-height: 22px; text-align: center; box-shadow: 0 2px 6px rgba(239, 68, 68, 0.5); border: 2px solid white; z-index: 1000;">0</span>
                        </button>
                        <button class="save-draft-btn" onclick="guardarBorrador()">
                            <i class="fas fa-save"></i>
                            <span>Borrador</span>
                        </button>
                        <button class="clear-cart-btn" onclick="clearCart()" title="Vaciar carrito">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shopping Cart - TWO COLUMNS -->
            <div class="shopping-cart">
                <!-- Cart Header con acciones a la derecha -->


                <!-- Shopping Cart Grid -->
                <div class="cart-grid">
                    <!-- LEFT COLUMN: Products List -->
                    <div>
                        <div id="cartItems" class="cart-items">
                            <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                                <i class="fas fa-shopping-cart"
                                    style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p style="margin: 0; font-size: 0.9rem;">Carrito vacío</p>
                                <p style="margin: 0; font-size: 0.8rem;">Agrega productos desde la lista</p>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Totals & Payment -->
                    <div class="cart-right">
                        <h6
                            style="font-size: 0.9rem; font-weight: 700; margin-bottom: 12px; color: var(--text-dark); flex-shrink: 0;">
                            <i class="fas fa-calculator"></i> Resumen
                        </h6>

                        <div id="cartTotal"
                            style="display: none; flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <!-- Contenido scrolleable -->
                            <div style="flex: 1; overflow-y: auto; min-height: 0; padding-right: 5px;">
                                <!-- Totals -->


                                <!-- Payment Section -->


                                <div class="cart-total" style="border-top: none; padding-top: 0;">


                                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                                        <div class="mb-3">
                                            <label class="form-label"
                                                style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark);">Cliente</label>
                                            <input type="text" class="form-control form-control-sm"
                                                placeholder="Buscar o crear cliente..." id="clienteInput">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label"
                                                style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Métodos
                                                de Pago</label>

                                            <div class="payment-section">
                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="efectivo"
                                                        onclick="togglePaymentMethod(this, 'efectivo')">
                                                        <i class="fas fa-money-bill-wave"></i>
                                                        <span>Efectivo</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="efectivoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="debito"
                                                        onclick="togglePaymentMethod(this, 'debito')">
                                                        <i class="fas fa-credit-card"></i>
                                                        <span>Débito</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="debitoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="credito"
                                                        onclick="togglePaymentMethod(this, 'credito')">
                                                        <i class="fas fa-credit-card"></i>
                                                        <span>Crédito</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="creditoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="transferencia"
                                                        onclick="togglePaymentMethod(this, 'transferencia')">
                                                        <i class="fas fa-university"></i>
                                                        <span>Transferencia</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="transferenciaAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment Summary -->
                                        <div class="mb-3" id="paymentSummary" style="display: none;">
                                            <div class="payment-summary-box">
                                                <div class="payment-summary-row">
                                                    <span style="font-size: 0.85rem; color: #6c757d;">Total
                                                        Recibido:</span>
                                                    <span style="font-size: 0.95rem; font-weight: 700;"
                                                        id="totalRecibido">$0</span>
                                                </div>
                                                <div class="payment-summary-row">
                                                    <span style="font-size: 0.85rem; color: #6c757d;">Total a
                                                        Pagar:</span>
                                                    <span style="font-size: 0.95rem; font-weight: 700;"
                                                        id="totalAPagar">$0</span>
                                                </div>
                                                <div class="payment-summary-row"
                                                    style="padding-top: 8px; border-top: 1px solid #e9ecef; margin-top: 8px;">
                                                    <span style="font-size: 0.9rem; font-weight: 600;"
                                                        id="diferenciaLabel">Diferencia:</span>
                                                    <span style="font-size: 1.1rem; font-weight: 700;"
                                                        id="diferencia">$0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="cart-total-row">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">$0</span>
                                    </div>
                                    <div class="cart-total-row">
                                        <span>IVA (19%):</span>
                                        <span id="iva">$0</span>
                                    </div>
                                    <div class="cart-total-row final">
                                        <span>TOTAL:</span>
                                        <span id="total">$0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons - Fijos en la parte inferior -->
                            <div class="cart-actions">
                                <button class="btn btn-primary btn-sm" onclick="procesarVentaDirecto()">
                                    <i class="fas fa-check"></i> Confirmar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal: Abrir Caja -->
<div class="modal fade" id="abrirCajaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cash-register"></i> Abrir Caja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Cajero</label>
                        <input type="text" class="form-control" value="{{ user.nombre }} {{ user.apellido }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto Inicial</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" placeholder="50000">
                        </div>
                        <small class="form-text text-muted">Monto in efectivo con el que se inicia el turno</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones (Opcional)</label>
                        <textarea class="form-control" rows="3" placeholder="Notas sobre la apertura..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="openCashRegister()">
                    <i class="fas fa-check"></i> Abrir Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cerrar Caja -->
<div class="modal fade" id="cerrarCajaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="fas fa-lock"></i> Cerrar Caja</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Verifica los montos antes de cerrar la caja.
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="summary-card income">
                            <h6>Total Ingresos</h6>
                            <div class="value">$1,195,500</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card expense">
                            <h6>Total Egresos</h6>
                            <div class="value">$85,000</div>
                        </div>
                    </div>
                </div>

                <form>
                    <div class="mb-3">
                        <label class="form-label">Monto en Efectivo (Contado)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" placeholder="Monto contado">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones de Cierre</label>
                        <textarea class="form-control" rows="3" placeholder="Notas..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="closeCashRegister()">
                    <i class="fas fa-lock"></i> Cerrar Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Pagos Pendientes -->
<div id="pagosPendientesModal" class="vet-modal-overlay hide" onclick="cerrarModalPagosPendientes()">
    <div class="vet-modal-panel" role="dialog" aria-modal="true" onclick="event.stopPropagation()" style="max-width: 1200px;">
        <div class="vet-custom-modal-title">
            <h3><i class="fas fa-file-invoice-dollar"></i> Pagos Pendientes</h3>
            <i class="bi bi-x" role="button" tabindex="0" aria-label="Cerrar" onclick="cerrarModalPagosPendientes()"></i>
        </div>
        <div class="vet-modal-body">
            <div id="pagosPendientesLoading" style="text-align: center; padding: 40px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3">Cargando pagos pendientes...</p>
            </div>
            
            <div id="pagosPendientesContent" style="display: none;">
                <!-- Tabla de pagos pendientes -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>N° Venta</th>
                                <th>Origen</th>
                                <th>Paciente</th>
                                <th>Servicios</th>
                                <th>Insumos</th>
                                <th>Total</th>
                                <th>Fecha</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pagosPendientesList">
                            <!-- Se llena dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noPagosPendientes" style="display: none; text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 15px;"></i>
                    <p style="margin: 0; font-size: 1.1rem; font-weight: 600;">No hay pagos pendientes</p>
                    <p style="margin: 5px 0 0; color: #6b7280; font-size: 0.9rem;">Todos los cobros están al día</p>
                </div>
            </div>

            <div id="pagosPendientesError" style="display: none; text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 15px;"></i>
                <p style="margin: 0; font-size: 1.1rem; font-weight: 600;">Error al cargar pagos pendientes</p>
                <p style="margin: 5px 0 0; color: #6b7280; font-size: 0.9rem;" id="pagosPendientesErrorMsg"></p>
                <button class="btn btn-primary mt-3" onclick="cargarPagosPendientes()">
                    <i class="fas fa-sync"></i> Reintentar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales con URLs para el JavaScript externo
    window.CAJA_URLS = {
        apiCobrosPendientes: "{% url 'caja:api_cobros_pendientes' %}",
        marcarEnProceso: "{% url 'caja:marcar_cobro_en_proceso' 0 %}".replace('/0/', '/{id}/'),
        devolverAPendiente: "{% url 'caja:devolver_cobro_a_pendiente' 0 %}".replace('/0/', '/{id}/'),
        eliminarCobro: "{% url 'caja:eliminar_cobro_pendiente' 0 %}".replace('/0/', '/{id}/'),
        procesarVenta: "{% url 'caja:procesar_venta' %}"
    };
</script>
<script src="{% static 'caja/js/funcionamiento_caja.js' %}"></script>
{% endblock %}