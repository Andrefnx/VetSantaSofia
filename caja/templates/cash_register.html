{% extends 'partials/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Caja Registradora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'caja/css/cash_register.css' %}">
{% endblock %}

{% block content %}
<h1><i class="bi bi-bag-check-fill"></i> Caja</h1>

<!-- Main Layout: 1/3 Dashboard + 2/3 Sales -->
<div class="cash-layout">
    <!-- Left Sidebar (1/3) - Dashboard -->


    <!-- Right Main Area (2/3) - Sales -->
    <div class="cash-main">
        <!-- LEFT: Products List -->
        <div class="products-section">

            <!-- SEARCH -->
            <div class="search-bar">
                <input type="text" class="form-control" placeholder="Buscar producto o servicio..." id="searchInput"
                    oninput="filterProducts()">
            </div>

            <!-- FILTER TABS -->
            <div class="product-tabs">
                <button class="product-tab active" onclick="switchCategory(this, 'all')">
                    <i class="fas fa-th"></i> Todos
                </button>
                <button class="product-tab" onclick="switchCategory(this, 'servicios')">
                    <i class="fas fa-stethoscope"></i> Servicios
                </button>
                <button class="product-tab" onclick="switchCategory(this, 'productos')">
                    <i class="fas fa-box"></i> Productos
                </button>
               
            </div>

            <!-- LISTA -->
            <div class="products-list" id="productsList">

                <!-- ============================ -->
                <!--          SERVICIOS           -->
                <!-- ============================ -->
                {% for servicio in servicios %}
                <div class="product-list-item" data-category="servicios"
                    onclick="addToCart('{{ servicio.nombre|escapejs }}', {{ servicio.precio }})">

                    <div class="icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-stethoscope"></i>
                    </div>

                    <div class="info">
                        <h6>{{ servicio.nombre }}</h6>
                        <p>{{ servicio.categoria }}</p>
                    </div>

                    <div class="price">${{ servicio.precio|intcomma }}</div>
                    <button class="add-btn">+</button>
                </div>
                {% empty %}
                <p class="empty-section">No hay servicios registrados.</p>
                {% endfor %}

           <!-- ============================ -->
<!--          PRODUCTOS           -->
<!-- ============================ -->
{% for producto in productos %}
<div class="product-list-item" data-category="productos"
    onclick="addToCart('{{ producto.medicamento|escapejs }}', {{ producto.precio_venta }})">

    <div class="icon">
        <i class="fas fa-box"></i>
    </div>

    <div class="info">
        <h6>{{ producto.medicamento }}</h6>
        <p>Stock: {{ producto.stock_actual }} {{ producto.unidad_medida }}</p>
    </div>

    <div class="price">${{ producto.precio_venta|intcomma }}</div>
    <button class="add-btn">+</button>
</div>
{% empty %}
<p class="empty-section">No hay productos en inventario.</p>
{% endfor %}

            </div>
        </div>

        <!-- RIGHT: Shopping Cart -->
        <div class="cart-section">
            <!-- Cart Header -->
            <div class="cart-header">
                <h5><i class="bi bi-bag-check-fill"></i> Carrito de Venta</h5>

                <div class="cart-header-inner">
                    <div class="cart-header-actions">
                        <button class="save-draft-btn" onclick="abrirModalPagosPendientes()" style="margin-right: 8px;">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Pagos Pendientes</span>
                        </button>
                        <button class="save-draft-btn" onclick="guardarBorrador()">
                            <i class="fas fa-save"></i>
                            <span>Borrador</span>
                        </button>
                        <button class="clear-cart-btn" onclick="clearCart()" title="Vaciar carrito">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shopping Cart - TWO COLUMNS -->
            <div class="shopping-cart">
                <!-- Cart Header con acciones a la derecha -->


                <!-- Shopping Cart Grid -->
                <div class="cart-grid">
                    <!-- LEFT COLUMN: Products List -->
                    <div>
                        <div id="cartItems" class="cart-items">
                            <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                                <i class="fas fa-shopping-cart"
                                    style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p style="margin: 0; font-size: 0.9rem;">Carrito vacío</p>
                                <p style="margin: 0; font-size: 0.8rem;">Agrega productos desde la lista</p>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Totals & Payment -->
                    <div class="cart-right">
                        <h6
                            style="font-size: 0.9rem; font-weight: 700; margin-bottom: 12px; color: var(--text-dark); flex-shrink: 0;">
                            <i class="fas fa-calculator"></i> Resumen
                        </h6>

                        <div id="cartTotal"
                            style="display: none; flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <!-- Contenido scrolleable -->
                            <div style="flex: 1; overflow-y: auto; min-height: 0; padding-right: 5px;">
                                <!-- Totals -->


                                <!-- Payment Section -->


                                <div class="cart-total" style="border-top: none; padding-top: 0;">


                                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                                        <div class="mb-3">
                                            <label class="form-label"
                                                style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark);">Cliente</label>
                                            <input type="text" class="form-control form-control-sm"
                                                placeholder="Buscar o crear cliente..." id="clienteInput">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label"
                                                style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Métodos
                                                de Pago</label>

                                            <div class="payment-section">
                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="efectivo"
                                                        onclick="togglePaymentMethod(this, 'efectivo')">
                                                        <i class="fas fa-money-bill-wave"></i>
                                                        <span>Efectivo</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="efectivoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="debito"
                                                        onclick="togglePaymentMethod(this, 'debito')">
                                                        <i class="fas fa-credit-card"></i>
                                                        <span>Débito</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="debitoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="credito"
                                                        onclick="togglePaymentMethod(this, 'credito')">
                                                        <i class="fas fa-credit-card"></i>
                                                        <span>Crédito</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="creditoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="transferencia"
                                                        onclick="togglePaymentMethod(this, 'transferencia')">
                                                        <i class="fas fa-university"></i>
                                                        <span>Transferencia</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="transferenciaAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment Summary -->
                                        <div class="mb-3" id="paymentSummary" style="display: none;">
                                            <div class="payment-summary-box">
                                                <div class="payment-summary-row">
                                                    <span style="font-size: 0.85rem; color: #6c757d;">Total
                                                        Recibido:</span>
                                                    <span style="font-size: 0.95rem; font-weight: 700;"
                                                        id="totalRecibido">$0</span>
                                                </div>
                                                <div class="payment-summary-row">
                                                    <span style="font-size: 0.85rem; color: #6c757d;">Total a
                                                        Pagar:</span>
                                                    <span style="font-size: 0.95rem; font-weight: 700;"
                                                        id="totalAPagar">$0</span>
                                                </div>
                                                <div class="payment-summary-row"
                                                    style="padding-top: 8px; border-top: 1px solid #e9ecef; margin-top: 8px;">
                                                    <span style="font-size: 0.9rem; font-weight: 600;"
                                                        id="diferenciaLabel">Diferencia:</span>
                                                    <span style="font-size: 1.1rem; font-weight: 700;"
                                                        id="diferencia">$0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="cart-total-row">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">$0</span>
                                    </div>
                                    <div class="cart-total-row">
                                        <span>IVA (19%):</span>
                                        <span id="iva">$0</span>
                                    </div>
                                    <div class="cart-total-row final">
                                        <span>TOTAL:</span>
                                        <span id="total">$0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons - Fijos en la parte inferior -->
                            <div class="cart-actions">
                                <button class="btn btn-outline-secondary btn-sm" onclick="generarPresupuesto()">
                                    <i class="fas fa-file-invoice"></i> Presupuesto
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="procesarVentaDirecto()">
                                    <i class="fas fa-check"></i> Confirmar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal: Abrir Caja -->
<div class="modal fade" id="abrirCajaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cash-register"></i> Abrir Caja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Cajero</label>
                        <input type="text" class="form-control" value="{{ user.nombre }} {{ user.apellido }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto Inicial</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" placeholder="50000">
                        </div>
                        <small class="form-text text-muted">Monto in efectivo con el que se inicia el turno</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones (Opcional)</label>
                        <textarea class="form-control" rows="3" placeholder="Notas sobre la apertura..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="openCashRegister()">
                    <i class="fas fa-check"></i> Abrir Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cerrar Caja -->
<div class="modal fade" id="cerrarCajaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="fas fa-lock"></i> Cerrar Caja</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Verifica los montos antes de cerrar la caja.
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="summary-card income">
                            <h6>Total Ingresos</h6>
                            <div class="value">$1,195,500</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card expense">
                            <h6>Total Egresos</h6>
                            <div class="value">$85,000</div>
                        </div>
                    </div>
                </div>

                <form>
                    <div class="mb-3">
                        <label class="form-label">Monto en Efectivo (Contado)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" placeholder="Monto contado">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones de Cierre</label>
                        <textarea class="form-control" rows="3" placeholder="Notas..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="closeCashRegister()">
                    <i class="fas fa-lock"></i> Cerrar Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Pagos Pendientes -->
<div id="pagosPendientesModal" class="vet-modal-overlay hide" onclick="cerrarModalPagosPendientes()">
    <div class="vet-modal-panel" role="dialog" aria-modal="true" onclick="event.stopPropagation()" style="max-width: 1200px;">
        <div class="vet-custom-modal-title">
            <h3><i class="fas fa-file-invoice-dollar"></i> Pagos Pendientes</h3>
            <i class="bi bi-x" role="button" tabindex="0" aria-label="Cerrar" onclick="cerrarModalPagosPendientes()"></i>
        </div>
        <div class="vet-modal-body">
            <div id="pagosPendientesLoading" style="text-align: center; padding: 40px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3">Cargando pagos pendientes...</p>
            </div>
            
            <div id="pagosPendientesContent" style="display: none;">
                <!-- Tabla de pagos pendientes -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>N° Venta</th>
                                <th>Origen</th>
                                <th>Paciente</th>
                                <th>Servicios</th>
                                <th>Insumos</th>
                                <th>Total</th>
                                <th>Fecha</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pagosPendientesList">
                            <!-- Se llena dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noPagosPendientes" style="display: none; text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 15px;"></i>
                    <p style="margin: 0; font-size: 1.1rem; font-weight: 600;">No hay pagos pendientes</p>
                    <p style="margin: 5px 0 0; color: #6b7280; font-size: 0.9rem;">Todos los cobros están al día</p>
                </div>
            </div>

            <div id="pagosPendientesError" style="display: none; text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 15px;"></i>
                <p style="margin: 0; font-size: 1.1rem; font-weight: 600;">Error al cargar pagos pendientes</p>
                <p style="margin: 5px 0 0; color: #6b7280; font-size: 0.9rem;" id="pagosPendientesErrorMsg"></p>
                <button class="btn btn-primary mt-3" onclick="cargarPagosPendientes()">
                    <i class="fas fa-sync"></i> Reintentar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let cart = [];
    let selectedPaymentMethods = new Set();
    let cashOpen = true;
    let currentCategory = 'all';

    function switchCategory(element, category) {
        document.querySelectorAll('.product-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        element.classList.add('active');
        currentCategory = category;
        filterProducts();
    }

    function filterProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.product-list-item');

        items.forEach(item => {
            const name = item.querySelector('.info h6').textContent.toLowerCase();
            const category = item.getAttribute('data-category');
            const matchesSearch = name.includes(searchTerm);
            const matchesCategory = currentCategory === 'all' || category === currentCategory;

            if (matchesSearch && matchesCategory) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function addToCart(name, price) {
        if (!cashOpen) {
            alert('La caja está cerrada. Por favor, abre la caja para realizar ventas.');
            return;
        }

        const existingItem = cart.find(item => item.name === name);

        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ name, price, quantity: 1 });
        }

        updateCart();
    }

    function updateCart() {
        const cartItemsDiv = document.getElementById('cartItems');
        const cartTotalDiv = document.getElementById('cartTotal');

        if (cart.length === 0) {
            cartItemsDiv.innerHTML = `
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart"></i>
                    <h6>Carrito vacío</h6>
                    <p>Agrega productos desde la lista</p>
                </div>
            `;
            cartTotalDiv.style.display = 'none';
            return;
        }

        cartItemsDiv.innerHTML = cart.map((item, index) => `
            <div class="cart-item">
                <div class="cart-item-info">
                    <h6>${item.name}</h6>
                    <p>$${item.price.toLocaleString()} c/u</p>
                </div>
                <div class="cart-item-controls">
                    <button class="qty-btn" onclick="decreaseQty(${index})">-</button>
                    <span class="qty-display">${item.quantity}</span>
                    <button class="qty-btn" onclick="increaseQty(${index})">+</button>
                </div>
                <div class="cart-item-price">$${(item.price * item.quantity).toLocaleString()}</div>
                <button class="cart-remove" onclick="removeFromCart(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');

        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const iva = Math.round(subtotal * 0.19);
        const total = subtotal + iva;

        document.getElementById('subtotal').textContent = '$' + subtotal.toLocaleString();
        document.getElementById('iva').textContent = '$' + iva.toLocaleString();
        document.getElementById('total').textContent = '$' + total.toLocaleString();

        cartTotalDiv.style.display = 'block';
        calcularPagos();
    }

    function increaseQty(index) {
        cart[index].quantity++;
        updateCart();
    }

    function decreaseQty(index) {
        if (cart[index].quantity > 1) {
            cart[index].quantity--;
        } else {
            cart.splice(index, 1);
        }
        updateCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
    }

    function clearCart() {
        cart = [];
        document.getElementById('clienteInput').value = '';

        selectedPaymentMethods.clear();
        document.querySelectorAll('.payment-method-compact').forEach(btn => {
            btn.classList.remove('active');
        });

        document.querySelectorAll('.payment-amount-input').forEach(input => {
            input.disabled = true;
            input.value = '';
        });

        document.getElementById('paymentSummary').style.display = 'none';
        updateCart();
    }

    function togglePaymentMethod(element, method) {
        const input = document.getElementById(method + 'Amount');

        if (selectedPaymentMethods.has(method)) {
            selectedPaymentMethods.delete(method);
            element.classList.remove('active');
            input.disabled = true;
            input.value = '';
        } else {
            selectedPaymentMethods.add(method);
            element.classList.add('active');
            input.disabled = false;
            input.focus();
        }

        calcularPagos();
    }

    function calcularPagos() {
        if (cart.length === 0) return;

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const totalConIva = total + Math.round(total * 0.19);

        let totalRecibido = 0;

        selectedPaymentMethods.forEach(method => {
            const input = document.getElementById(method + 'Amount');
            const value = parseFloat(input.value) || 0;
            totalRecibido += value;
        });

        const diferencia = totalRecibido - totalConIva;

        if (selectedPaymentMethods.size > 0) {
            document.getElementById('paymentSummary').style.display = 'block';
            document.getElementById('totalRecibido').textContent = '$' + totalRecibido.toLocaleString();
            document.getElementById('totalAPagar').textContent = '$' + totalConIva.toLocaleString();

            const diferenciaElement = document.getElementById('diferencia');
            const diferenciaLabel = document.getElementById('diferenciaLabel');

            if (diferencia > 0) {
                diferenciaElement.textContent = '$' + diferencia.toLocaleString();
                diferenciaLabel.textContent = 'Vuelto:';
                diferenciaElement.classList.remove('negative', 'exact');
                diferenciaElement.classList.add('positive');
            } else if (diferencia < 0) {
                diferenciaElement.textContent = '-$' + Math.abs(diferencia).toLocaleString();
                diferenciaLabel.textContent = 'Falta:';
                diferenciaElement.classList.remove('positive', 'exact');
                diferenciaElement.classList.add('negative');
            } else {
                diferenciaElement.textContent = '$0';
                diferenciaLabel.textContent = 'Exacto:';
                diferenciaElement.classList.remove('positive', 'negative');
                diferenciaElement.classList.add('exact');
            }
        } else {
            document.getElementById('paymentSummary').style.display = 'none';
        }
    }

    function procesarVentaDirecto() {
        if (cart.length === 0) {
            alert('El carrito está vacío');
            return;
        }

        const cliente = document.getElementById('clienteInput').value;
        if (!cliente) {
            alert('Por favor, ingresa un cliente');
            return;
        }

        if (selectedPaymentMethods.size === 0) {
            alert('Por favor, selecciona al menos un método de pago');
            return;
        }

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const totalConIva = total + Math.round(total * 0.19);

        let totalRecibido = 0;
        let paymentDetails = [];

        selectedPaymentMethods.forEach(method => {
            const input = document.getElementById(method + 'Amount');
            const value = parseFloat(input.value) || 0;
            totalRecibido += value;

            if (value > 0) {
                paymentDetails.push(`${method.charAt(0).toUpperCase() + method.slice(1)}: $${value.toLocaleString()}`);
            }
        });

        const diferencia = totalRecibido - totalConIva;

        if (diferencia < 0) {
            alert(`Falta dinero: $${Math.abs(diferencia).toLocaleString()}`);
            return;
        }

        let mensaje = `¡Venta procesada exitosamente!\n\nCliente: ${cliente}\n\nMétodos de pago:\n${paymentDetails.join('\n')}\n\nTotal: $${totalConIva.toLocaleString()}\nRecibido: $${totalRecibido.toLocaleString()}`;

        if (diferencia > 0) {
            mensaje += `\nVuelto: $${diferencia.toLocaleString()}`;
        }

        alert(mensaje);
        clearCart();
    }

    function toggleCashRegister() {
        if (cashOpen) {
            const cerrarModal = new bootstrap.Modal(document.getElementById('cerrarCajaModal'));
            cerrarModal.show();
        } else {
            const abrirModal = new bootstrap.Modal(document.getElementById('abrirCajaModal'));
            abrirModal.show();
        }
    }

    function openCashRegister() {
        cashOpen = true;

        const btn = document.getElementById('cashStatusBtn');
        btn.classList.remove('closed');
        btn.classList.add('open');

        document.getElementById('cashStatusLabel').textContent = 'Caja Abierta';

        const card = document.getElementById('cashStatusCard');
        card.classList.remove('closed');
        card.querySelector('h5').innerHTML = '<i class="fas fa-cash-register"></i> Caja Abierta';

        bootstrap.Modal.getInstance(document.getElementById('abrirCajaModal')).hide();

        alert('Caja abierta exitosamente');
    }

    function closeCashRegister() {
        cashOpen = false;

        const btn = document.getElementById('cashStatusBtn');
        btn.classList.remove('open');
        btn.classList.add('closed');

        document.getElementById('cashStatusLabel').textContent = 'Caja Cerrada';
        document.getElementById('cashAmount').textContent = '$0';

        const card = document.getElementById('cashStatusCard');
        card.classList.add('closed');
        card.querySelector('h5').innerHTML = '<i class="fas fa-lock"></i> Caja Cerrada';
        card.querySelector('.amount').textContent = '$0';

        bootstrap.Modal.getInstance(document.getElementById('cerrarCajaModal')).hide();

        clearCart();

        alert('Caja cerrada. Se ha generado el reporte de cierre.');
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (!cashOpen) {
            const btn = document.getElementById('cashStatusBtn');
            btn.classList.remove('open');
            btn.classList.add('closed');
            document.getElementById('cashStatusLabel').textContent = 'Caja Cerrada';
            document.getElementById('cashAmount').textContent = '$0';
        }
    });

    // =========== FUNCIONES PARA PAGOS PENDIENTES ===========

    /**
     * Abre el modal de pagos pendientes y carga los datos desde el API
     */
    function abrirModalPagosPendientes() {
        const modal = document.getElementById('pagosPendientesModal');
        modal.classList.remove('hide');
        modal.classList.add('show');
        cargarPagosPendientes();
    }

    /**
     * Cierra el modal de pagos pendientes
     */
    function cerrarModalPagosPendientes() {
        const modal = document.getElementById('pagosPendientesModal');
        modal.classList.remove('show');
        modal.classList.add('hide');
    }

    /**
     * Carga la lista de pagos pendientes desde el API
     */
    async function cargarPagosPendientes() {
        const loadingDiv = document.getElementById('pagosPendientesLoading');
        const contentDiv = document.getElementById('pagosPendientesContent');
        const errorDiv = document.getElementById('pagosPendientesError');
        const noPagosDiv = document.getElementById('noPagosPendientes');

        // Mostrar loading
        loadingDiv.style.display = 'block';
        contentDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        try {
            const response = await fetch("{% url 'caja:api_cobros_pendientes' %}");
            
            if (!response.ok) {
                throw new Error('Error al cargar los pagos pendientes');
            }

            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Error desconocido');
            }

            // Ocultar loading
            loadingDiv.style.display = 'none';

            if (data.cobros.length === 0) {
                // No hay pagos pendientes
                contentDiv.style.display = 'block';
                noPagosDiv.style.display = 'block';
                document.querySelector('#pagosPendientesContent .table-responsive').style.display = 'none';
            } else {
                // Mostrar tabla con pagos
                contentDiv.style.display = 'block';
                noPagosDiv.style.display = 'none';
                document.querySelector('#pagosPendientesContent .table-responsive').style.display = 'block';
                renderizarPagosPendientes(data.cobros);
            }

        } catch (error) {
            console.error('Error al cargar pagos pendientes:', error);
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            document.getElementById('pagosPendientesErrorMsg').textContent = error.message;
        }
    }

    /**
     * Renderiza la lista de pagos pendientes en la tabla
     */
    function renderizarPagosPendientes(cobros) {
        const tbody = document.getElementById('pagosPendientesList');
        
        tbody.innerHTML = cobros.map(cobro => {
            // Filtrar servicios e insumos
            const servicios = cobro.detalles.filter(d => d.tipo === 'servicio');
            const insumos = cobro.detalles.filter(d => d.tipo === 'insumo');
            
            // Construir lista de items
            const listaServicios = servicios.length > 0 
                ? servicios.map(s => `${s.descripcion} (x${s.cantidad})`).join('<br>')
                : '-';
            const listaInsumos = insumos.length > 0
                ? insumos.map(i => `${i.descripcion} (x${i.cantidad})`).join('<br>')
                : '-';
            
            // Origen como texto plano
            let origenTexto = cobro.tipo_origen_display || 'Manual';
            
            return `
                <tr>
                    <td><strong>${cobro.numero_venta}</strong></td>
                    <td>${origenTexto}</td>
                    <td>${cobro.paciente || '-'}</td>
                    <td style="font-size: 0.85rem;">${listaServicios}</td>
                    <td style="font-size: 0.85rem;">${listaInsumos}</td>
                    <td><strong style="color: #10b981;">$${cobro.total.toLocaleString()}</strong></td>
                    <td style="font-size: 0.85rem;">${cobro.fecha_creacion}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-sm btn-primary" onclick="cargarPagoPendiente(${cobro.id})" style="margin-right: 5px; display: inline-block;">
                            <i class="fas fa-download"></i> Cargar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarCobroPendiente(${cobro.id}, '${cobro.numero_venta}')" title="Cancelar cobro" style="display: inline-block;">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    /**
     * Elimina/cancela un cobro pendiente
     */
    async function eliminarCobroPendiente(ventaId, numeroVenta) {
        if (!confirm(`¿Está seguro de cancelar el cobro ${numeroVenta}?\n\nEsta acción no se puede deshacer.`)) {
            return;
        }
        
        try {
            const response = await fetch(`{% url 'caja:eliminar_cobro_pendiente' 0 %}`.replace('0', ventaId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`✅ ${result.message}`);
                // Recargar la lista de cobros pendientes
                cargarPagosPendientes();
            } else {
                alert(`❌ Error: ${result.error}`);
            }
            
        } catch (error) {
            console.error('Error al eliminar cobro pendiente:', error);
            alert('Error al eliminar el cobro pendiente: ' + error.message);
        }
    }

    /**
     * Carga un pago pendiente en el carrito de caja
     */
    async function cargarPagoPendiente(ventaId) {
        try {
            // Buscar la venta en los datos cargados
            const response = await fetch("{% url 'caja:api_cobros_pendientes' %}");
            const data = await response.json();
            
            if (!data.success) {
                throw new Error('Error al obtener los detalles de la venta');
            }
            
            const venta = data.cobros.find(c => c.id === ventaId);
            
            if (!venta) {
                throw new Error('Venta no encontrada');
            }
            

    /**
     * Helper para obtener el CSRF token
     */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
            // Limpiar el carrito actual
            cart = [];
            
            // Agregar cada detalle al carrito
            venta.detalles.forEach(detalle => {
                cart.push({
                    id: detalle.id,
                    name: detalle.descripcion,
                    price: detalle.precio_unitario,
                    quantity: detalle.cantidad,
                    tipo: detalle.tipo
                });
            });
            
            // Actualizar UI del carrito
            updateCart();
            
            // Cerrar el modal
            cerrarModalPagosPendientes();
            
            // Mostrar mensaje de éxito
            alert(`Pago pendiente ${venta.numero_venta} cargado exitosamente.\nTotal: $${venta.total.toLocaleString()}`);
            
            // Si hay paciente, establecerlo (opcional)
            if (venta.paciente) {
                document.getElementById('clienteInput').value = venta.paciente;
            }
            
        } catch (error) {
            console.error('Error al cargar pago pendiente:', error);
            alert('Error al cargar el pago pendiente: ' + error.message);
        }
    }
</script>
{% endblock %}