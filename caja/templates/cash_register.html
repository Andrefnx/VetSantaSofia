{% extends 'partials/base.html' %}
{% load static %}

{% block title %}Caja Registradora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'caja/css/cash_register.css' %}">
{% endblock %}

{% block content %}
<!-- Main Layout: 1/3 Dashboard + 2/3 Sales -->
<div class="cash-layout">
    <!-- Left Sidebar (1/3) - Dashboard -->


    <!-- Right Main Area (2/3) - Sales -->
    <div class="cash-main">
        <!-- LEFT: Products List -->
        <div class="products-section">
            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" class="form-control" placeholder="üîç Buscar producto o servicio..." id="searchInput"
                    oninput="filterProducts()">
            </div>

            <!-- Product Tabs -->
            <div class="product-tabs">
                <button class="product-tab active" onclick="switchCategory(this, 'all')">
                    <i class="fas fa-th"></i> Todos
                </button>
                <button class="product-tab" onclick="switchCategory(this, 'servicios')">
                    <i class="fas fa-stethoscope"></i> Servicios
                </button>
                <button class="product-tab" onclick="switchCategory(this, 'productos')">
                    <i class="fas fa-pills"></i> Productos
                </button>
                <button class="product-tab" onclick="switchCategory(this, 'antiparasitarios')">
                    <i class="fas fa-shield-virus"></i> Antiparasitarios
                </button>
            </div>

            <!-- Products List -->
            <div class="products-list" id="productsList">
                <!-- Servicios -->
                <div class="product-list-item" data-category="servicios" onclick="addToCart('Consulta General', 35000)">
                    <div class="icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-stethoscope"></i>
                    </div>
                    <div class="info">
                        <h6>Consulta General</h6>
                        <p>Servicio veterinario</p>
                    </div>
                    <div class="price">$35,000</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="servicios"
                    onclick="addToCart('Vacuna Antirr√°bica', 15000)">
                    <div class="icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-syringe"></i>
                    </div>
                    <div class="info">
                        <h6>Vacuna Antirr√°bica</h6>
                        <p>Prevenci√≥n</p>
                    </div>
                    <div class="price">$15,000</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="servicios" onclick="addToCart('Vacuna M√∫ltiple', 25000)">
                    <div class="icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-syringe"></i>
                    </div>
                    <div class="info">
                        <h6>Vacuna M√∫ltiple</h6>
                        <p>Prevenci√≥n</p>
                    </div>
                    <div class="price">$25,000</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="servicios" onclick="addToCart('Desparasitaci√≥n', 12000)">
                    <div class="icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-pills"></i>
                    </div>
                    <div class="info">
                        <h6>Desparasitaci√≥n</h6>
                        <p>Tratamiento</p>
                    </div>
                    <div class="price">$12,000</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="servicios" onclick="addToCart('Cirug√≠a Simple', 180000)">
                    <div class="icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-scissors"></i>
                    </div>
                    <div class="info">
                        <h6>Cirug√≠a Simple</h6>
                        <p>Procedimiento quir√∫rgico</p>
                    </div>
                    <div class="price">$180,000</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="servicios" onclick="addToCart('Esterilizaci√≥n', 120000)">
                    <div class="icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-cut"></i>
                    </div>
                    <div class="info">
                        <h6>Esterilizaci√≥n</h6>
                        <p>Cirug√≠a</p>
                    </div>
                    <div class="price">$120,000</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="servicios"
                    onclick="addToCart('Ba√±o y Peluquer√≠a', 25000)">
                    <div class="icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-bath"></i>
                    </div>
                    <div class="info">
                        <h6>Ba√±o y Peluquer√≠a</h6>
                        <p>Est√©tica</p>
                    </div>
                    <div class="price">$25,000</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="servicios" onclick="addToCart('Examen de Sangre', 45000)">
                    <div class="icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-vial"></i>
                    </div>
                    <div class="info">
                        <h6>Examen de Sangre</h6>
                        <p>Diagn√≥stico</p>
                    </div>
                    <div class="price">$45,000</div>
                    <button class="add-btn">+</button>
                </div>

                <!-- Productos Antiparasitarios -->
                <div class="product-list-item" data-category="antiparasitarios"
                    onclick="addToCart('Revolution Plus', 32500)">
                    <div class="icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="info">
                        <h6>Revolution Plus</h6>
                        <p>Stock: 4 unidades</p>
                    </div>
                    <div class="price">$32,500</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="antiparasitarios"
                    onclick="addToCart('Bravecto 40-56Kg', 28000)">
                    <div class="icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="info">
                        <h6>Bravecto 40-56Kg</h6>
                        <p>Stock: 7 unidades</p>
                    </div>
                    <div class="price">$28,000</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="antiparasitarios"
                    onclick="addToCart('NexGard Spectra', 26500)">
                    <div class="icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="info">
                        <h6>NexGard Spectra</h6>
                        <p>Stock: 6 unidades</p>
                    </div>
                    <div class="price">$26,500</div>
                    <button class="add-btn">+</button>
                </div>

                <div class="product-list-item" data-category="antiparasitarios"
                    onclick="addToCart('Simparica Trio', 24500)">
                    <div class="icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="info">
                        <h6>Simparica Trio</h6>
                        <p>Stock: 28 unidades</p>
                    </div>
                    <div class="price">$24,500</div>
                    <button class="add-btn">+</button>
                </div>
            </div>
        </div>

        <!-- RIGHT: Shopping Cart -->
        <div class="cart-section">
            <!-- Cart Header -->
            <div class="cart-header">
                <h5><i class="fas fa-shopping-cart"></i> Carrito de Venta</h5>

                <div class="cart-header-inner">
                    <div class="cart-header-actions">
                        <button class="save-draft-btn" onclick="guardarBorrador()">
                            <i class="fas fa-save"></i>
                            <span>Borrador</span>
                        </button>
                        <button class="clear-cart-btn" onclick="clearCart()" title="Vaciar carrito">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shopping Cart - TWO COLUMNS -->
            <div class="shopping-cart">
                <!-- Cart Header con acciones a la derecha -->


                <!-- Shopping Cart Grid -->
                <div class="cart-grid">
                    <!-- LEFT COLUMN: Products List -->
                    <div>
                        <div id="cartItems" class="cart-items">
                            <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                                <i class="fas fa-shopping-cart"
                                    style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p style="margin: 0; font-size: 0.9rem;">Carrito vac√≠o</p>
                                <p style="margin: 0; font-size: 0.8rem;">Agrega productos desde la lista</p>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Totals & Payment -->
                    <div class="cart-right">
                        <h6
                            style="font-size: 0.9rem; font-weight: 700; margin-bottom: 12px; color: var(--text-dark); flex-shrink: 0;">
                            <i class="fas fa-calculator"></i> Resumen
                        </h6>

                        <div id="cartTotal"
                            style="display: none; flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <!-- Contenido scrolleable -->
                            <div style="flex: 1; overflow-y: auto; min-height: 0; padding-right: 5px;">
                                <!-- Totals -->


                                <!-- Payment Section -->


                                <div class="cart-total" style="border-top: none; padding-top: 0;">


                                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                                        <div class="mb-3">
                                            <label class="form-label"
                                                style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark);">Cliente</label>
                                            <input type="text" class="form-control form-control-sm"
                                                placeholder="Buscar o crear cliente..." id="clienteInput">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label"
                                                style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">M√©todos
                                                de Pago</label>

                                            <div class="payment-section">
                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="efectivo"
                                                        onclick="togglePaymentMethod(this, 'efectivo')">
                                                        <i class="fas fa-money-bill-wave"></i>
                                                        <span>Efectivo</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="efectivoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="debito"
                                                        onclick="togglePaymentMethod(this, 'debito')">
                                                        <i class="fas fa-credit-card"></i>
                                                        <span>D√©bito</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="debitoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="credito"
                                                        onclick="togglePaymentMethod(this, 'credito')">
                                                        <i class="fas fa-credit-card"></i>
                                                        <span>Cr√©dito</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="creditoAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>

                                                <div class="payment-row">
                                                    <button class="payment-method-compact" data-method="transferencia"
                                                        onclick="togglePaymentMethod(this, 'transferencia')">
                                                        <i class="fas fa-university"></i>
                                                        <span>Transferencia</span>
                                                    </button>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control payment-amount-input"
                                                            id="transferenciaAmount" disabled placeholder="0"
                                                            oninput="calcularPagos()">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment Summary -->
                                        <div class="mb-3" id="paymentSummary" style="display: none;">
                                            <div class="payment-summary-box">
                                                <div class="payment-summary-row">
                                                    <span style="font-size: 0.85rem; color: #6c757d;">Total
                                                        Recibido:</span>
                                                    <span style="font-size: 0.95rem; font-weight: 700;"
                                                        id="totalRecibido">$0</span>
                                                </div>
                                                <div class="payment-summary-row">
                                                    <span style="font-size: 0.85rem; color: #6c757d;">Total a
                                                        Pagar:</span>
                                                    <span style="font-size: 0.95rem; font-weight: 700;"
                                                        id="totalAPagar">$0</span>
                                                </div>
                                                <div class="payment-summary-row"
                                                    style="padding-top: 8px; border-top: 1px solid #e9ecef; margin-top: 8px;">
                                                    <span style="font-size: 0.9rem; font-weight: 600;"
                                                        id="diferenciaLabel">Diferencia:</span>
                                                    <span style="font-size: 1.1rem; font-weight: 700;"
                                                        id="diferencia">$0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="cart-total-row">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">$0</span>
                                    </div>
                                    <div class="cart-total-row">
                                        <span>IVA (19%):</span>
                                        <span id="iva">$0</span>
                                    </div>
                                    <div class="cart-total-row final">
                                        <span>TOTAL:</span>
                                        <span id="total">$0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons - Fijos en la parte inferior -->
                            <div class="cart-actions">
                                <button class="btn btn-outline-secondary btn-sm" onclick="generarPresupuesto()">
                                    <i class="fas fa-file-invoice"></i> Presupuesto
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="procesarVentaDirecto()">
                                    <i class="fas fa-check"></i> Confirmar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal: Abrir Caja -->
<div class="modal fade" id="abrirCajaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cash-register"></i> Abrir Caja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Cajero</label>
                        <input type="text" class="form-control" value="{{ user.nombre }} {{ user.apellido }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monto Inicial</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" placeholder="50000">
                        </div>
                        <small class="form-text text-muted">Monto in efectivo con el que se inicia el turno</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones (Opcional)</label>
                        <textarea class="form-control" rows="3" placeholder="Notas sobre la apertura..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="openCashRegister()">
                    <i class="fas fa-check"></i> Abrir Caja
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cerrar Caja -->
<div class="modal fade" id="cerrarCajaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="fas fa-lock"></i> Cerrar Caja</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Verifica los montos antes de cerrar la caja.
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="summary-card income">
                            <h6>Total Ingresos</h6>
                            <div class="value">$1,195,500</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card expense">
                            <h6>Total Egresos</h6>
                            <div class="value">$85,000</div>
                        </div>
                    </div>
                </div>

                <form>
                    <div class="mb-3">
                        <label class="form-label">Monto en Efectivo (Contado)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" placeholder="Monto contado">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones de Cierre</label>
                        <textarea class="form-control" rows="3" placeholder="Notas..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="closeCashRegister()">
                    <i class="fas fa-lock"></i> Cerrar Caja
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let cart = [];
    let selectedPaymentMethods = new Set();
    let cashOpen = true;
    let currentCategory = 'all';

    function switchCategory(element, category) {
        document.querySelectorAll('.product-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        element.classList.add('active');
        currentCategory = category;
        filterProducts();
    }

    function filterProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.product-list-item');

        items.forEach(item => {
            const name = item.querySelector('.info h6').textContent.toLowerCase();
            const category = item.getAttribute('data-category');
            const matchesSearch = name.includes(searchTerm);
            const matchesCategory = currentCategory === 'all' || category === currentCategory;

            if (matchesSearch && matchesCategory) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function addToCart(name, price) {
        if (!cashOpen) {
            alert('La caja est√° cerrada. Por favor, abre la caja para realizar ventas.');
            return;
        }

        const existingItem = cart.find(item => item.name === name);

        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ name, price, quantity: 1 });
        }

        updateCart();
    }

    function updateCart() {
        const cartItemsDiv = document.getElementById('cartItems');
        const cartTotalDiv = document.getElementById('cartTotal');

        if (cart.length === 0) {
            cartItemsDiv.innerHTML = `
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart"></i>
                    <h6>Carrito vac√≠o</h6>
                    <p>Agrega productos desde la lista</p>
                </div>
            `;
            cartTotalDiv.style.display = 'none';
            return;
        }

        cartItemsDiv.innerHTML = cart.map((item, index) => `
            <div class="cart-item">
                <div class="cart-item-info">
                    <h6>${item.name}</h6>
                    <p>$${item.price.toLocaleString()} c/u</p>
                </div>
                <div class="cart-item-controls">
                    <button class="qty-btn" onclick="decreaseQty(${index})">-</button>
                    <span class="qty-display">${item.quantity}</span>
                    <button class="qty-btn" onclick="increaseQty(${index})">+</button>
                </div>
                <div class="cart-item-price">$${(item.price * item.quantity).toLocaleString()}</div>
                <button class="cart-remove" onclick="removeFromCart(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');

        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const iva = Math.round(subtotal * 0.19);
        const total = subtotal + iva;

        document.getElementById('subtotal').textContent = '$' + subtotal.toLocaleString();
        document.getElementById('iva').textContent = '$' + iva.toLocaleString();
        document.getElementById('total').textContent = '$' + total.toLocaleString();

        cartTotalDiv.style.display = 'block';
        calcularPagos();
    }

    function increaseQty(index) {
        cart[index].quantity++;
        updateCart();
    }

    function decreaseQty(index) {
        if (cart[index].quantity > 1) {
            cart[index].quantity--;
        } else {
            cart.splice(index, 1);
        }
        updateCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
    }

    function clearCart() {
        cart = [];
        document.getElementById('clienteInput').value = '';

        selectedPaymentMethods.clear();
        document.querySelectorAll('.payment-method-compact').forEach(btn => {
            btn.classList.remove('active');
        });

        document.querySelectorAll('.payment-amount-input').forEach(input => {
            input.disabled = true;
            input.value = '';
        });

        document.getElementById('paymentSummary').style.display = 'none';
        updateCart();
    }

    function togglePaymentMethod(element, method) {
        const input = document.getElementById(method + 'Amount');

        if (selectedPaymentMethods.has(method)) {
            selectedPaymentMethods.delete(method);
            element.classList.remove('active');
            input.disabled = true;
            input.value = '';
        } else {
            selectedPaymentMethods.add(method);
            element.classList.add('active');
            input.disabled = false;
            input.focus();
        }

        calcularPagos();
    }

    function calcularPagos() {
        if (cart.length === 0) return;

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const totalConIva = total + Math.round(total * 0.19);

        let totalRecibido = 0;

        selectedPaymentMethods.forEach(method => {
            const input = document.getElementById(method + 'Amount');
            const value = parseFloat(input.value) || 0;
            totalRecibido += value;
        });

        const diferencia = totalRecibido - totalConIva;

        if (selectedPaymentMethods.size > 0) {
            document.getElementById('paymentSummary').style.display = 'block';
            document.getElementById('totalRecibido').textContent = '$' + totalRecibido.toLocaleString();
            document.getElementById('totalAPagar').textContent = '$' + totalConIva.toLocaleString();

            const diferenciaElement = document.getElementById('diferencia');
            const diferenciaLabel = document.getElementById('diferenciaLabel');

            if (diferencia > 0) {
                diferenciaElement.textContent = '$' + diferencia.toLocaleString();
                diferenciaLabel.textContent = 'Vuelto:';
                diferenciaElement.classList.remove('negative', 'exact');
                diferenciaElement.classList.add('positive');
            } else if (diferencia < 0) {
                diferenciaElement.textContent = '-$' + Math.abs(diferencia).toLocaleString();
                diferenciaLabel.textContent = 'Falta:';
                diferenciaElement.classList.remove('positive', 'exact');
                diferenciaElement.classList.add('negative');
            } else {
                diferenciaElement.textContent = '$0';
                diferenciaLabel.textContent = 'Exacto:';
                diferenciaElement.classList.remove('positive', 'negative');
                diferenciaElement.classList.add('exact');
            }
        } else {
            document.getElementById('paymentSummary').style.display = 'none';
        }
    }

    function procesarVentaDirecto() {
        if (cart.length === 0) {
            alert('El carrito est√° vac√≠o');
            return;
        }

        const cliente = document.getElementById('clienteInput').value;
        if (!cliente) {
            alert('Por favor, ingresa un cliente');
            return;
        }

        if (selectedPaymentMethods.size === 0) {
            alert('Por favor, selecciona al menos un m√©todo de pago');
            return;
        }

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const totalConIva = total + Math.round(total * 0.19);

        let totalRecibido = 0;
        let paymentDetails = [];

        selectedPaymentMethods.forEach(method => {
            const input = document.getElementById(method + 'Amount');
            const value = parseFloat(input.value) || 0;
            totalRecibido += value;

            if (value > 0) {
                paymentDetails.push(`${method.charAt(0).toUpperCase() + method.slice(1)}: $${value.toLocaleString()}`);
            }
        });

        const diferencia = totalRecibido - totalConIva;

        if (diferencia < 0) {
            alert(`Falta dinero: $${Math.abs(diferencia).toLocaleString()}`);
            return;
        }

        let mensaje = `¬°Venta procesada exitosamente!\n\nCliente: ${cliente}\n\nM√©todos de pago:\n${paymentDetails.join('\n')}\n\nTotal: $${totalConIva.toLocaleString()}\nRecibido: $${totalRecibido.toLocaleString()}`;

        if (diferencia > 0) {
            mensaje += `\nVuelto: $${diferencia.toLocaleString()}`;
        }

        alert(mensaje);
        clearCart();
    }

    function toggleCashRegister() {
        if (cashOpen) {
            const cerrarModal = new bootstrap.Modal(document.getElementById('cerrarCajaModal'));
            cerrarModal.show();
        } else {
            const abrirModal = new bootstrap.Modal(document.getElementById('abrirCajaModal'));
            abrirModal.show();
        }
    }

    function openCashRegister() {
        cashOpen = true;

        const btn = document.getElementById('cashStatusBtn');
        btn.classList.remove('closed');
        btn.classList.add('open');

        document.getElementById('cashStatusLabel').textContent = 'Caja Abierta';

        const card = document.getElementById('cashStatusCard');
        card.classList.remove('closed');
        card.querySelector('h5').innerHTML = '<i class="fas fa-cash-register"></i> Caja Abierta';

        bootstrap.Modal.getInstance(document.getElementById('abrirCajaModal')).hide();

        alert('Caja abierta exitosamente');
    }

    function closeCashRegister() {
        cashOpen = false;

        const btn = document.getElementById('cashStatusBtn');
        btn.classList.remove('open');
        btn.classList.add('closed');

        document.getElementById('cashStatusLabel').textContent = 'Caja Cerrada';
        document.getElementById('cashAmount').textContent = '$0';

        const card = document.getElementById('cashStatusCard');
        card.classList.add('closed');
        card.querySelector('h5').innerHTML = '<i class="fas fa-lock"></i> Caja Cerrada';
        card.querySelector('.amount').textContent = '$0';

        bootstrap.Modal.getInstance(document.getElementById('cerrarCajaModal')).hide();

        clearCart();

        alert('Caja cerrada. Se ha generado el reporte de cierre.');
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (!cashOpen) {
            const btn = document.getElementById('cashStatusBtn');
            btn.classList.remove('open');
            btn.classList.add('closed');
            document.getElementById('cashStatusLabel').textContent = 'Caja Cerrada';
            document.getElementById('cashAmount').textContent = '$0';
        }
    });
</script>
{% endblock %}