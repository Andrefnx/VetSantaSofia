{% extends "partials/base.html" %}
{% load static %}

{% block title %}Reportes Financieros{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-cash-coin"></i> Reportes Financieros</h2>
</div>

{% if error_message %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Filtros -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel"></i> Filtros
                    <button class="btn btn-sm btn-link float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse show" id="filtrosCollapse">
                <div class="card-body">
                    <form method="get" id="filtrosForm">
                        <div class="row g-3">
                            <!-- Fechas -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Fecha Desde</label>
                                <input type="date" class="form-control" name="fecha_desde" value="{{ request.GET.fecha_desde }}">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Fecha Hasta</label>
                                <input type="date" class="form-control" name="fecha_hasta" value="{{ request.GET.fecha_hasta }}">
                            </div>
                            
                            <!-- Método de Pago -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Método de Pago</label>
                                <select class="form-select" name="metodo_pago">
                                    <option value="">Todos</option>
                                    <option value="efectivo" {% if request.GET.metodo_pago == "efectivo" %}selected{% endif %}>Efectivo</option>
                                    <option value="tarjeta" {% if request.GET.metodo_pago == "tarjeta" %}selected{% endif %}>Tarjeta</option>
                                    <option value="transferencia" {% if request.GET.metodo_pago == "transferencia" %}selected{% endif %}>Transferencia</option>
                                    <option value="cheque" {% if request.GET.metodo_pago == "cheque" %}selected{% endif %}>Cheque</option>
                                    <option value="mixto" {% if request.GET.metodo_pago == "mixto" %}selected{% endif %}>Mixto</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Aplicar Filtros
                                </button>
                                <a href="{% url 'reportes:financieros' %}" class="btn btn-secondary">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resultados - Sesiones de Caja Expandibles -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Sesiones de Caja: {{ sesiones|length }} sesión{{ sesiones|length|pluralize }}</h5>
                <button type="button" class="btn btn-success" onclick="exportarExcel()">
                    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                </button>
            </div>
            <div class="card-body">
                {% if sesiones %}
                    <div class="accordion" id="acordeonSesiones">
                        {% for item in sesiones %}
                            {% with sesion=item.sesion ventas=item.ventas total_sesion=item.total_sesion %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" 
                                            aria-controls="collapse{{ forloop.counter }}">
                                        <div class="w-100">
                                            <div class="row align-items-center mb-2">
                                                <div class="col-md-8">
                                                    <strong>
                                                        <i class="bi bi-cash-register"></i>
                                                        Sesión {{ forloop.counter }} - 
                                                        {{ sesion.fecha_apertura|date:"d/m/Y H:i" }}
                                                    </strong>
                                                    <span class="ms-2 small">
                                                        {% if sesion.esta_cerrada %}
                                                            <span style="color: #28a745; font-weight: 500;">Cerrada</span>
                                                        {% else %}
                                                            <span style="color: #ffc107; font-weight: 500;">Abierta</span>
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <strong style="color: #000; font-size: 1.05rem;">
                                                        ${{ total_sesion|floatformat:2 }}
                                                    </strong>
                                                </div>
                                            </div>
                                            <div class="row small text-muted">
                                                <div class="col-md-4">
                                                    <i class="bi bi-person"></i>
                                                    Apertura: {{ sesion.usuario_apertura.nombre }} {{ sesion.usuario_apertura.apellido }}
                                                </div>
                                                {% if sesion.usuario_cierre %}
                                                <div class="col-md-4">
                                                    <i class="bi bi-person"></i>
                                                    Cierre: {{ sesion.usuario_cierre.nombre }} {{ sesion.usuario_cierre.apellido }}
                                                </div>
                                                {% endif %}
                                                {% if sesion.fecha_cierre %}
                                                <div class="col-md-4 text-end">
                                                    <i class="bi bi-clock"></i>
                                                    Cierre: {{ sesion.fecha_cierre|date:"d/m/Y H:i" }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                                     aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#acordeonSesiones">
                                    <div class="accordion-body p-0">
                                        <!-- Tabla de ventas dentro de la sesión -->
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Fecha/Hora</th>
                                                        <th>Nº Venta</th>
                                                        <th>Paciente</th>
                                                        <th>Método de Pago</th>
                                                        <th class="text-center">Origen</th>
                                                        <th class="text-end">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for venta in ventas %}
                                                    <tr>
                                                        <td>{{ venta.fecha_pago|date:"d/m/Y H:i" }}</td>
                                                        <td><strong>#{{ venta.numero_venta }}</strong></td>
                                                        <td>
                                                            {% if venta.paciente %}
                                                                {{ venta.paciente.nombre }}
                                                            {% else %}
                                                                <em class="text-muted">-</em>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if venta.metodo_pago %}
                                                                {{ venta.get_metodo_pago_display|capfirst }}
                                                            {% else %}
                                                                <em class="text-muted">-</em>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if venta.tipo_origen == "consulta" %}
                                                                <span style="color: #007bff; font-size: 0.9rem;">Consulta</span>
                                                            {% elif venta.tipo_origen == "hospitalizacion" %}
                                                                <span style="color: #dc3545; font-size: 0.9rem;">Hosp.</span>
                                                            {% else %}
                                                                <span style="color: #6c757d; font-size: 0.9rem;">Venta Libre</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-end"><strong>${{ venta.total|floatformat:2 }}</strong></td>
                                                    </tr>
                                                    {% endfor %}
                                                    <!-- Fila subtotal de sesión -->
                                                    <tr class="table-light" style="border-top: 2px solid #dee2e6;">
                                                        <td colspan="5" class="text-end">
                                                            <strong>Subtotal sesión:</strong>
                                                        </td>
                                                        <td class="text-end">
                                                            <strong style="color: #495057; font-size: 1rem;">
                                                                ${{ total_sesion|floatformat:2 }}
                                                            </strong>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endwith %}
                        {% endfor %}
                    </div>

                    <!-- Total del período -->
                    <div class="mt-4 pt-3" style="border-top: 3px solid #dee2e6;">
                        <div class="row">
                            <div class="col-12 text-end">
                                <p class="mb-1" style="font-size: 1rem; color: #6c757d;">
                                    <strong>Total del período:</strong>
                                </p>
                                <h4 style="color: #000; font-weight: 700; margin: 0;">
                                    ${{ total_periodo|floatformat:2 }}
                                </h4>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- Estado vacío -->
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
                        <p class="mb-0 mt-3 text-muted">
                            No hay sesiones de caja que coincidan con los filtros seleccionados
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Script para exportar a Excel (sin funcionalidad backend aún) -->
<script>
function exportarExcel() {
    // Obtener los parámetros del formulario
    const form = document.getElementById('filtrosForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    
    // TODO: Cuando se implemente el backend, descomentar la siguiente línea
    // const exportUrl = '/reportes/financieros/exportar-excel/?' + params.toString();
    // window.location.href = exportUrl;
    
    // Placeholder temporal: mostrar alerta
    alert('Funcionalidad de exportación pendiente de implementación');
}
</script>

{% endblock %}
