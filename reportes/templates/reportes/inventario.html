{% extends "partials/base.html" %}
{% load static %}

{% block title %}Reporte de Inventario{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-box-seam"></i> Reporte de Inventario</h2>
</div>

{% if error_message %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Filtros -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel"></i> Filtros
                    <button class="btn btn-sm btn-link float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse show" id="filtrosCollapse">
                <div class="card-body">
                    <form method="get" id="filtrosForm">
                        <div class="row g-3">
                            <!-- Fechas -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Fecha Desde</label>
                                <input type="date" class="form-control" name="fecha_desde" value="{{ request.GET.fecha_desde }}">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Fecha Hasta</label>
                                <input type="date" class="form-control" name="fecha_hasta" value="{{ request.GET.fecha_hasta }}">
                            </div>
                            
                            <!-- Marca -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Marca</label>
                                <select class="form-select" name="marca">
                                    <option value="">Todas las marcas</option>
                                    {% for marca in marcas %}
                                    <option value="{{ marca }}" {% if request.GET.marca == marca %}selected{% endif %}>{{ marca }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Estado -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" name="estado">
                                    <option value="">Todos</option>
                                    <option value="activo" {% if request.GET.estado == "activo" %}selected{% endif %}>Activo</option>
                                    <option value="archivado" {% if request.GET.estado == "archivado" %}selected{% endif %}>Archivado</option>
                                </select>
                            </div>
                            
                            <!-- Stock -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Stock Mínimo</label>
                                <input type="number" class="form-control" name="stock_min" value="{{ request.GET.stock_min }}" step="0.01" placeholder="Ej: 10">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Stock Máximo</label>
                                <input type="number" class="form-control" name="stock_max" value="{{ request.GET.stock_max }}" step="0.01" placeholder="Ej: 100">
                            </div>
                            
                            <!-- Precio -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Precio Mínimo</label>
                                <input type="number" class="form-control" name="precio_min" value="{{ request.GET.precio_min }}" step="0.01" placeholder="Ej: 1000">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">Precio Máximo</label>
                                <input type="number" class="form-control" name="precio_max" value="{{ request.GET.precio_max }}" step="0.01" placeholder="Ej: 50000">
                            </div>
                            
                            <!-- Vendidos -->
                            <div class="col-md-6 col-lg-4">
                                <label class="form-label">Vendidos</label>
                                <select class="form-select" name="vendidos">
                                    <option value="">Todos</option>
                                    <option value="si" {% if request.GET.vendidos == "si" %}selected{% endif %}>Solo vendidos</option>
                                    <option value="no" {% if request.GET.vendidos == "no" %}selected{% endif %}>No vendidos</option>
                                </select>
                            </div>
                            
                            <!-- Usados en consultas -->
                            <div class="col-md-6 col-lg-4">
                                <label class="form-label">Usados en Consultas</label>
                                <select class="form-select" name="en_consultas">
                                    <option value="">Todos</option>
                                    <option value="si" {% if request.GET.en_consultas == "si" %}selected{% endif %}>Usados en consultas</option>
                                    <option value="no" {% if request.GET.en_consultas == "no" %}selected{% endif %}>No usados</option>
                                </select>
                            </div>
                            
                            <!-- Usados en hospitalizaciones -->
                            <div class="col-md-6 col-lg-4">
                                <label class="form-label">Usados en Hospitalizaciones</label>
                                <select class="form-select" name="en_hospitalizaciones">
                                    <option value="">Todos</option>
                                    <option value="si" {% if request.GET.en_hospitalizaciones == "si" %}selected{% endif %}>Usados en hospitalizaciones</option>
                                    <option value="no" {% if request.GET.en_hospitalizaciones == "no" %}selected{% endif %}>No usados</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Aplicar Filtros
                                </button>
                                <a href="{% url 'reportes:inventario' %}" class="btn btn-secondary">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resultados -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Resultados: {{ insumos|length }} insumo{{ insumos|length|pluralize }}</h5>
                <button type="button" class="btn btn-success" onclick="exportarExcel()">
                    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Medicamento</th>
                                <th>Marca</th>
                                <th class="text-end">Stock Actual</th>
                                <th class="text-end">Precio Venta</th>
                                <th class="text-end">Veces Vendido</th>
                                <th class="text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for insumo in insumos %}
                            <tr>
                                <td><strong>{{ insumo.medicamento }}</strong></td>
                                <td>{{ insumo.marca|default:"-" }}</td>
                                <td class="text-end">
                                    {% if insumo.stock_actual <= 10 %}
                                        <span class="text-danger fw-bold">{{ insumo.stock_actual }}</span>
                                    {% elif insumo.stock_actual <= 30 %}
                                        <span class="text-warning fw-bold">{{ insumo.stock_actual }}</span>
                                    {% else %}
                                        {{ insumo.stock_actual }}
                                    {% endif %}
                                </td>
                                <td class="text-end">${{ insumo.precio_venta|floatformat:2 }}</td>
                                <td class="text-end">{{ insumo.veces_vendido|default:0 }}</td>
                                <td class="text-center">
                                    {% if insumo.archivado %}
                                        <span class="text-muted">Archivado</span>
                                    {% else %}
                                        <span class="text-success">Activo</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">No hay insumos que coincidan con los filtros</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportarExcel() {
    // Obtener los parámetros del formulario
    const form = document.getElementById('filtrosForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    
    // Construir URL de exportación con filtros
    const exportUrl = '{% url "reportes:exportar_inventario_excel" %}?' + params.toString();
    window.location.href = exportUrl;
}
</script>
{% endblock %}
