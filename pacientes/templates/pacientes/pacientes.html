{% extends "partials/base_table.html" %}
{% load static %}

{% block title %}Pacientes{% endblock %}
{% block table_title %}
<i class="fas fa-paw"></i> Pacientes
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/base/tables_base.css' %}?v=4" type="text/css" media="all">
<style>
    /* Sober, standardized visuals aligned with base */
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 992px) { .modal-grid { grid-template-columns: 1fr; } }

    .owner-mode-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .owner-mode-group .btn { border-color: var(--primary-color); color: #0f2b17; font-size: 0.9rem; flex: 1; min-width: 120px; }
    .owner-mode-group .btn-check:checked + .btn { background-color: var(--primary-color); color: #0f2b17; }

    .edad-selector-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .edad-selector-group .btn { border: 1px solid #dde5df; background: #f7faf7; color: #0f2b17; font-size: 0.9rem; box-shadow: none; }
    .edad-selector-group .btn-check:checked + .btn { background-color: var(--primary-color); color: #0f2b17; border-color: var(--primary-color); box-shadow: none; }

    #fieldEdadAproximada > div { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    #fieldEdadAproximada label { font-size: 0.9rem; }
    #fieldEdadAproximada input { font-size: 0.95rem; }

    .vet-modal-body { padding: 1.25rem !important; }
    .vet-modal-body .mb-3 { margin-bottom: 0.75rem !important; }
    .vet-modal-body .mb-2 { margin-bottom: 0.5rem !important; }
    .vet-modal-body label { font-size: 0.9rem; margin-bottom: 0.35rem; }
    .vet-modal-body .form-control, .vet-modal-body .form-select { font-size: 0.9rem; padding: 0.4rem 0.75rem; }
    .vet-modal-body textarea { max-height: 60px; resize: vertical; }

    .propietario-nombre-grupo { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .owner-form-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; }
    .owner-form-row textarea { grid-column: span 5; }
    @media (max-width: 1200px) { .owner-form-row { grid-template-columns: repeat(3, 1fr); } .owner-form-row textarea { grid-column: span 3; } }
    @media (max-width: 768px) { .owner-form-row { grid-template-columns: 1fr; } .owner-form-row textarea { grid-column: span 1; } }

    .detail-section-title { display: flex; align-items: center; gap: 0.5rem; }

    .tabs-estado { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e6e8ec; }
    .tab-estado { padding: 0.75rem 1.25rem; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: #4b5563; transition: all 0.2s ease; }
    .tab-estado:hover { color: #0f2b17; background: rgba(175, 225, 175, 0.15); }
    .tab-estado.active { color: #0f2b17; border-bottom-color: var(--primary-color); background: rgba(175, 225, 175, 0.15); }
    .tab-estado i { margin-right: 0.5rem; }

    /* Primary modal button standardized */
    .vet-btn-primary { background: var(--primary-color); color: #fff; border: 1px solid var(--primary-color); box-shadow: none; }
    .vet-btn-primary:hover { background: var(--primary-hover); color: #fff; border-color: var(--primary-hover); }
</style>
{% endblock %}

{% block modals %}
<!-- Modal: Nuevo/Editar Paciente -->
<div class="vet-modal-overlay hide" id="modalNuevoPaciente">
    <div class="vet-custom-modal" style="max-width: 900px;">
        <div class="vet-modal-content">

            <!-- Título -->
            <div class="vet-custom-modal-title">
                <h3><i class="fas fa-paw"></i> <span id="tituloModalPaciente">Nuevo Paciente</span></h3>
                <i class="bi bi-x" onclick="closeVetModal('modalNuevoPaciente')"
                    style="cursor:pointer;margin-left:auto;"></i>
            </div>

            <!-- Cuerpo -->
            <div class="vet-modal-body">
                <form id="addPacienteForm" onsubmit="event.preventDefault();">
                    <input type="hidden" id="pacienteIdEdit">

                    <div class="modal-grid">
                        <!-- IZQUIERDA: Datos del paciente -->
                        <div>
                            <h6 class="detail-section-title"><i class="fas fa-paw"></i> Datos del Paciente</h6>

                            <!-- Nombre -->
                            <div class="mb-3">
                                <label>Nombre</label>
                                <input type="text" id="pacienteNombre" class="form-control">
                            </div>

                            <!-- Especie -->
                            <div class="mb-3">
                                <label>Especie</label>
                                <select id="pacienteEspecie" class="form-control">
                                    <option value="">Selecciona...</option>
                                    <option value="perro">Perro</option>
                                    <option value="gato">Gato</option>
                                </select>
                            </div>

                            <!-- Raza -->
                            <div class="mb-3">
                                <label>Raza</label>
                                <input type="text" id="pacienteRaza" class="form-control">
                            </div>

                            <!-- Sexo -->
                            <div class="mb-3">
                                <label>Sexo</label>
                                <select id="pacienteSexo" class="form-control">
                                    <option value="">Selecciona...</option>
                                    <option value="M">Macho</option>
                                    <option value="H">Hembra</option>
                                </select>
                            </div>

                            <!-- Edad: Selector de tipo -->
                            <div class="mb-3">
                                <label style="display: block; margin-bottom: 0.75rem; font-weight: 500;">Edad</label>
                                <div class="edad-selector-group">
                                    <input type="radio" class="btn-check" name="tipoEdad" id="tipoEdadFecha" value="fecha" checked>
                                    <label class="btn btn-outline-secondary" for="tipoEdadFecha"><i class="bi bi-calendar-event"></i> Fecha nacimiento</label>

                                    <input type="radio" class="btn-check" name="tipoEdad" id="tipoEdadEstimada" value="estimada">
                                    <label class="btn btn-outline-secondary" for="tipoEdadEstimada"><i class="bi bi-calculator"></i> Edad aproximada</label>
                                </div>
                            </div>

                            <!-- Fecha de nacimiento -->
                            <div class="mb-3" id="fieldFechaNacimiento">
                                <label>Fecha de Nacimiento</label>
                                <input type="date" id="pacienteFechaNacimiento" class="form-control">
                                <!-- Edad calculada -->
                                <small id="edadCalculada" class="text-muted d-block mt-2" style="display: none;"></small>
                            </div>

                            <!-- Edad aproximada (años y meses) -->
                            <div class="mb-3" id="fieldEdadAproximada" style="display: none;">
                                <div>
                                    <div>
                                        <label>Años</label>
                                        <input type="number" id="pacienteEdadAnos" class="form-control" min="0" max="50" placeholder="0">
                                    </div>
                                    <div>
                                        <label>Meses</label>
                                        <input type="number" id="pacienteEdadMeses" class="form-control" min="0" max="11" placeholder="0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- DERECHA: Propietario -->
                        <div>
                            <h6 class="detail-section-title"><i class="bi bi-person-badge"></i> Propietario</h6>

                            <!-- Modo -->
                            <div class="owner-mode-group mb-2">
                                <div id="wrapperEditarActual">
                                    <input type="radio" class="btn-check" name="modoPropietario" id="modoPropietarioEditar"
                                        value="editar">
                                    <label class="btn btn-outline-success" for="modoPropietarioEditar">Editar actual</label>
                                </div>

                                <div>
                                    <input type="radio" class="btn-check" name="modoPropietario" id="modoPropietarioNuevo"
                                        value="nuevo">
                                    <label class="btn btn-outline-success" for="modoPropietarioNuevo">Crear nuevo</label>
                                </div>

                                <div>
                                    <input type="radio" class="btn-check" name="modoPropietario"
                                        id="modoPropietarioExistente" value="existente">
                                    <label class="btn btn-outline-success" for="modoPropietarioExistente">Seleccionar
                                        existente</label>
                                </div>
                            </div>
                            <input type="hidden" id="propietarioModo" value="nuevo">

                            <small class="text-muted d-block mb-2">
                                Puedes editar al dueño actual, asignar uno ya registrado o crear un nuevo registro.
                            </small>

                            <!-- BUSCAR EXISTENTE -->
                            <div id="seccionBusquedaPropietario" class="mb-3" style="display:none;">
                                <label>Buscar Propietario Existente</label>
                                <div class="input-group">
                                    <input type="text" id="buscarPropietario" class="form-control"
                                        placeholder="Buscar por nombre, teléfono o email...">
                                    <button type="button" class="btn btn-secondary" onclick="buscarPropietarios()">
                                        <i class="bi bi-search"></i> Buscar
                                    </button>
                                </div>
                            </div>

                            <!-- RESULTADOS -->
                            <div id="resultadosPropietarios" class="mb-3" style="display:none;">
                                <label>Resultados:</label>
                                <select id="selectPropietario" class="form-control"
                                    onchange="seleccionarPropietario(this.value)">
                                    <option value="">Selecciona...</option>
                                </select>
                            </div>

                            <!-- FORM NUEVO PROPIETARIO -->
                            <div id="formNuevoPropietario">
                                <input type="hidden" id="propietarioId" value="">
                                <div class="propietario-nombre-grupo">
                                    <div class="mb-2">
                                        <label>Nombre *</label>
                                        <input type="text" id="propietarioNombre" class="form-control">
                                    </div>

                                    <div class="mb-2">
                                        <label>Apellido *</label>
                                        <input type="text" id="propietarioApellido" class="form-control">
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label>Teléfono *</label>
                                    <input type="tel" id="propietarioTelefono" placeholder="+56912345678"
                                        class="form-control" data-phone="true" required>
                                </div>

                                <div class="mb-2">
                                    <label>Email</label>
                                    <input type="email" id="propietarioEmail" placeholder="correo@dominio.cl"
                                        class="form-control" data-email="true">
                                </div>

                                <div class="mb-2">
                                    <label>Dirección</label>
                                    <textarea id="propietarioDireccion" class="form-control"></textarea>
                                </div>
                            </div>

                        </div> <!-- FIN DERECHA -->
                    </div> <!-- FIN GRID -->

                </form>
            </div>

            <!-- FOOTER -->
            <div class="vet-modal-footer">
                <button type="button" class="vet-btn vet-btn-grey" onclick="closeVetModal('modalNuevoPaciente')">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="vet-btn vet-btn-primary" onclick="saveNewPaciente()"
                    id="btnGuardarModalPaciente">
                    <i class="bi bi-floppy-fill"></i> Guardar Paciente
                </button>
            </div>

        </div>
    </div>
</div>

<!-- Modal: Archivar/Restaurar Paciente (Compacto UI estándar) -->
<div class="vet-modal-overlay hide" id="modalArchivarPaciente">
    <div class="vet-modal-compact">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background:#f57c00;">
                <h3><i class="bi bi-archive-fill"></i> <span id="tituloArchivar">Archivar Paciente</span></h3>
                <i class="bi bi-x" onclick="closeArchivarPacienteModal()"></i>
            </div>
            <div class="vet-modal-body">
                <p id="archivarPacienteMensaje" class="text-center mb-4">¿Estás seguro que deseas archivar este paciente? Podrás restaurarlo desde la pestaña de archivados.</p>
                <div class="vet-modal-footer">
                    <button type="button" class="vet-btn-cancel" onclick="closeArchivarPacienteModal()">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="vet-btn vet-btn-primary" id="btnConfirmarArchivarPaciente">
                        <i class="bi bi-archive-fill"></i> <span id="btnTextoArchivar">Archivar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block table_buttons %}
<button type="button" onclick="abrirModalNuevoPaciente()">
    <i class="fas fa-plus-circle"></i> Nuevo Paciente
</button>
{% endblock %}

{% block table_tabs %}
<!-- Pestañas de estado -->
<div class="tabs-estado" style="margin: 1rem 0; padding: 0 1rem;">
    <button type="button" class="tab-estado {% if estado_actual != 'archivados' %}active{% endif %}" 
            onclick="cambiarEstadoPacientes('activos')">
        <i class="bi bi-heart-pulse-fill"></i> Activos
    </button>
    <button type="button" class="tab-estado {% if estado_actual == 'archivados' %}active{% endif %}" 
            onclick="cambiarEstadoPacientes('archivados')">
        <i class="bi bi-archive-fill"></i> Archivados
    </button>
</div>
{% endblock %}

{% block table_columns %}
<th>Nombre</th>
<th>Especie</th>
<th>Raza</th>
<th>Edad</th>
<th>Sexo</th>
<th>Propietario</th>
<th>Gestión</th>
{% endblock %}

{% block table_rows %}
{% for paciente in pacientes %}
<tr data-especie="{{ paciente.especie|lower }}" data-sexo="{{ paciente.sexo|lower }}" 
    style="cursor: pointer;" 
    onclick="if (event.target.closest('.manage-wheel')) return; window.location.href='{% url 'pacientes:ficha_mascota' paciente.id %}'">
    <td>{{ paciente.nombre }}</td>
    <td>{{ paciente.get_especie_display|default:paciente.especie|capfirst }}</td>
    <td>{{ paciente.raza|default:"-" }}</td>
    <td>{{ paciente.edad_formateada }}</td>
    <td>{{ paciente.get_sexo_display|default:paciente.sexo|capfirst }}</td>
    <td>{{ paciente.propietario.nombre_completo|default:"-" }}</td>
    <td>
        <div class="manage-wheel">
            <button type="button" onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display:none;">
                <button type="button" onclick="window.location.href='{% url 'pacientes:ficha_mascota' paciente.id %}'">
                    <i class="bi bi-eye"></i> Ver
                </button>
                {% if paciente.activo %}
                <button type="button" onclick="abrirModalPaciente(this, 'edit', {{ paciente.id }})">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" onclick="abrirModalArchivarPaciente(this, {{ paciente.id }}, false)">
                    <i class="bi bi-archive-fill"></i> Archivar
                </button>
                {% else %}
                <button type="button" onclick="abrirModalArchivarPaciente(this, {{ paciente.id }}, true)">
                    <i class="bi bi-arrow-clockwise"></i> Restaurar
                </button>
                {% endif %}
            </div>
        </div>
    </td>
</tr>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/utils/validators.js' %}?v=1"></script>
<script src="{% static 'js/pacientes/new_paciente.js' %}?v=6"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        attachEmailPhoneValidation('#propietarioEmail', '#propietarioTelefono');
    });
</script>
{% endblock %}