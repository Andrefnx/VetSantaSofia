{% extends "partials/base_table.html" %}
{% load static %}

{% block title %}Pacientes{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/base/tables_base.css' %}?v=4" type="text/css" media="all">
<style>
    /* Mejor contraste en botones verdes claros */
    .vet-btn-primary,
    .btn.btn-success,
    .btn.btn-outline-success {
        color: #0b4d2d !important;
    }

    /* Layout 50/50 para modal */
    .modal-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 992px) {
        .modal-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Estilo verde selector propietario */
    .owner-mode-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .owner-mode-group .btn {
        border-color: #69c087;
        color: #0b4d2d;
        font-size: 0.9rem;
        flex: 1;
        min-width: 120px;
    }

    .owner-mode-group .btn-check:checked+.btn {
        background-color: #69c087;
        color: #0b4d2d;
    }

    /* Estilo para selector de edad */
    .edad-selector-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .edad-selector-group .btn {
        border-color: #69c087;
        color: #0b4d2d;
        font-size: 0.9rem;
    }

    .edad-selector-group .btn-check:checked+.btn {
        background-color: #69c087;
        color: #0b4d2d;
    }

    /* Campos de edad aproximada en grid 2 columnas */
    #fieldEdadAproximada > div {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    #fieldEdadAproximada label {
        font-size: 0.9rem;
    }

    #fieldEdadAproximada input {
        font-size: 0.95rem;
    }

    /* Compactar espaciado del modal */
    .vet-modal-body {
        padding: 1.25rem !important;
    }

    .vet-modal-body .mb-3 {
        margin-bottom: 0.75rem !important;
    }

    .vet-modal-body .mb-2 {
        margin-bottom: 0.5rem !important;
    }

    .vet-modal-body label {
        font-size: 0.9rem;
        margin-bottom: 0.35rem;
    }

    .vet-modal-body .form-control,
    .vet-modal-body .form-select {
        font-size: 0.9rem;
        padding: 0.4rem 0.75rem;
    }

    .vet-modal-body textarea {
        max-height: 60px;
        resize: vertical;
    }

    /* Grid para nombre y apellido propietario */
    .propietario-nombre-grupo {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .owner-form-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.75rem;
    }

    .owner-form-row textarea {
        grid-column: span 5;
    }

    @media (max-width: 1200px) {
        .owner-form-row {
            grid-template-columns: repeat(3, 1fr);
        }

        .owner-form-row textarea {
            grid-column: span 3;
        }
    }

    @media (max-width: 768px) {
        .owner-form-row {
            grid-template-columns: 1fr;
        }

        .owner-form-row textarea {
            grid-column: span 1;
        }
    }

    .detail-section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
</style>
{% endblock %}

{% block modals %}
<!-- Modal: Nuevo/Editar Paciente -->
<div class="vet-modal-overlay hide" id="modalNuevoPaciente">
    <div class="vet-custom-modal" style="max-width: 900px;">
        <div class="vet-modal-content">

            <!-- Título -->
            <div class="vet-custom-modal-title">
                <h3><i class="fas fa-paw"></i> <span id="tituloModalPaciente">Nuevo Paciente</span></h3>
                <i class="bi bi-x" onclick="closeVetModal('modalNuevoPaciente')"
                    style="cursor:pointer;margin-left:auto;"></i>
            </div>

            <!-- Cuerpo -->
            <div class="vet-modal-body">
                <form id="addPacienteForm" onsubmit="event.preventDefault();">
                    <input type="hidden" id="pacienteIdEdit">

                    <div class="modal-grid">
                        <!-- IZQUIERDA: Datos del paciente -->
                        <div>
                            <h6 class="detail-section-title"><i class="fas fa-paw"></i> Datos del Paciente</h6>

                            <!-- Nombre -->
                            <div class="mb-3">
                                <label>Nombre</label>
                                <input type="text" id="pacienteNombre" class="form-control">
                            </div>

                            <!-- Especie -->
                            <div class="mb-3">
                                <label>Especie</label>
                                <select id="pacienteEspecie" class="form-control">
                                    <option value="">Selecciona...</option>
                                    <option value="perro">Perro</option>
                                    <option value="gato">Gato</option>
                                </select>
                            </div>

                            <!-- Raza -->
                            <div class="mb-3">
                                <label>Raza</label>
                                <input type="text" id="pacienteRaza" class="form-control">
                            </div>

                            <!-- Sexo -->
                            <div class="mb-3">
                                <label>Sexo</label>
                                <select id="pacienteSexo" class="form-control">
                                    <option value="">Selecciona...</option>
                                    <option value="M">Macho</option>
                                    <option value="H">Hembra</option>
                                </select>
                            </div>

                            <!-- Edad: Selector de tipo -->
                            <div class="mb-3">
                                <label style="display: block; margin-bottom: 0.75rem; font-weight: 500;">Edad</label>
                                <div class="edad-selector-group">
                                    <input type="radio" class="btn-check" name="tipoEdad" id="tipoEdadFecha" value="fecha" checked>
                                    <label class="btn btn-outline-secondary" for="tipoEdadFecha"><i class="bi bi-calendar-event"></i> Fecha nacimiento</label>

                                    <input type="radio" class="btn-check" name="tipoEdad" id="tipoEdadEstimada" value="estimada">
                                    <label class="btn btn-outline-secondary" for="tipoEdadEstimada"><i class="bi bi-calculator"></i> Edad aproximada</label>
                                </div>
                            </div>

                            <!-- Fecha de nacimiento -->
                            <div class="mb-3" id="fieldFechaNacimiento">
                                <label>Fecha de Nacimiento</label>
                                <input type="date" id="pacienteFechaNacimiento" class="form-control">
                                <!-- Edad calculada -->
                                <small id="edadCalculada" class="text-muted d-block mt-2" style="display: none;"></small>
                            </div>

                            <!-- Edad aproximada (años y meses) -->
                            <div class="mb-3" id="fieldEdadAproximada" style="display: none;">
                                <div>
                                    <div>
                                        <label>Años</label>
                                        <input type="number" id="pacienteEdadAnos" class="form-control" min="0" max="50" placeholder="0">
                                    </div>
                                    <div>
                                        <label>Meses</label>
                                        <input type="number" id="pacienteEdadMeses" class="form-control" min="0" max="11" placeholder="0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- DERECHA: Propietario -->
                        <div>
                            <h6 class="detail-section-title"><i class="bi bi-person-badge"></i> Propietario</h6>

                            <!-- Modo -->
                            <div class="owner-mode-group mb-2">
                                <div id="wrapperEditarActual">
                                    <input type="radio" class="btn-check" name="modoPropietario" id="modoPropietarioEditar"
                                        value="editar">
                                    <label class="btn btn-outline-success" for="modoPropietarioEditar">Editar actual</label>
                                </div>

                                <div>
                                    <input type="radio" class="btn-check" name="modoPropietario" id="modoPropietarioNuevo"
                                        value="nuevo">
                                    <label class="btn btn-outline-success" for="modoPropietarioNuevo">Crear nuevo</label>
                                </div>

                                <div>
                                    <input type="radio" class="btn-check" name="modoPropietario"
                                        id="modoPropietarioExistente" value="existente">
                                    <label class="btn btn-outline-success" for="modoPropietarioExistente">Seleccionar
                                        existente</label>
                                </div>
                            </div>
                            <input type="hidden" id="propietarioModo" value="nuevo">

                            <small class="text-muted d-block mb-2">
                                Puedes editar al dueño actual, asignar uno ya registrado o crear un nuevo registro.
                            </small>

                            <!-- BUSCAR EXISTENTE -->
                            <div id="seccionBusquedaPropietario" class="mb-3" style="display:none;">
                                <label>Buscar Propietario Existente</label>
                                <div class="input-group">
                                    <input type="text" id="buscarPropietario" class="form-control"
                                        placeholder="Buscar por nombre, teléfono o email...">
                                    <button type="button" class="btn btn-secondary" onclick="buscarPropietarios()">
                                        <i class="bi bi-search"></i> Buscar
                                    </button>
                                </div>
                            </div>

                            <!-- RESULTADOS -->
                            <div id="resultadosPropietarios" class="mb-3" style="display:none;">
                                <label>Resultados:</label>
                                <select id="selectPropietario" class="form-control"
                                    onchange="seleccionarPropietario(this.value)">
                                    <option value="">Selecciona...</option>
                                </select>
                            </div>

                            <!-- FORM NUEVO PROPIETARIO -->
                            <div id="formNuevoPropietario">
                                <input type="hidden" id="propietarioId" value="">
                                <div class="propietario-nombre-grupo">
                                    <div class="mb-2">
                                        <label>Nombre *</label>
                                        <input type="text" id="propietarioNombre" class="form-control">
                                    </div>

                                    <div class="mb-2">
                                        <label>Apellido *</label>
                                        <input type="text" id="propietarioApellido" class="form-control">
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label>Teléfono *</label>
                                    <input type="tel" id="propietarioTelefono" placeholder="+56912345678"
                                        class="form-control">
                                </div>

                                <div class="mb-2">
                                    <label>Email</label>
                                    <input type="email" id="propietarioEmail" placeholder="correo@dominio.cl"
                                        class="form-control">
                                </div>

                                <div class="mb-2">
                                    <label>Dirección</label>
                                    <textarea id="propietarioDireccion" class="form-control"></textarea>
                                </div>
                            </div>
                            
                            <!-- Badge de propietario seleccionado -->
                            <div id="propietarioSeleccionadoBadge" class="alert alert-info" style="display:none; margin-top:0.75rem; padding: 0.6rem; font-size: 0.9rem;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-check-circle"></i>
                                        Propietario: <strong id="propietarioNombreDisplay"></strong>
                                    </div>
                                </div>
                            </div>

                        </div> <!-- FIN DERECHA -->
                    </div> <!-- FIN GRID -->

                </form>
            </div>

            <!-- FOOTER -->
            <div class="vet-modal-footer">
                <button type="button" class="vet-btn vet-btn-grey" onclick="closeVetModal('modalNuevoPaciente')">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="vet-btn vet-btn-primary" onclick="saveNewPaciente()"
                    id="btnGuardarModalPaciente">
                    <i class="bi bi-floppy-fill"></i> Guardar Paciente
                </button>
            </div>

        </div>
    </div>
</div>

<!-- Modal: Eliminar Paciente -->
<div class="vet-modal-overlay hide" id="modalEliminarPaciente">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background:#b71c1c;">
                <h3><i class="bi bi-trash3-fill"></i> Eliminar Paciente</h3>
                <i class="bi bi-x" onclick="closeEliminarPacienteModal()" style="cursor:pointer;"></i>
            </div>
            <div class="vet-modal-body">
                <p id="eliminarPacienteMensaje">¿Estás seguro que deseas eliminar este paciente?</p>
            </div>
            <div class="vet-modal-body" style="text-align:right;">
                <button type="button" class="vet-btn-grey error" id="btnConfirmarEliminarPaciente">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block table_buttons %}
<button type="button" onclick="abrirModalNuevoPaciente()">
    <i class="fas fa-plus-circle"></i> Nuevo Paciente
</button>
{% endblock %}

{% block table_columns %}
<th>Nombre</th>
<th>Especie</th>
<th>Raza</th>
<th>Edad</th>
<th>Sexo</th>
<th>Propietario</th>
<th>Gestión</th>
{% endblock %}

{% block table_rows %}
{% for paciente in pacientes %}
<tr data-especie="{{ paciente.especie|lower }}" data-sexo="{{ paciente.sexo|lower }}">
    <td>{{ paciente.nombre }}</td>
    <td>{{ paciente.get_especie_display|default:paciente.especie|capfirst }}</td>
    <td>{{ paciente.raza|default:"-" }}</td>
    <td>{{ paciente.edad_formateada }}</td>
    <td>{{ paciente.get_sexo_display|default:paciente.sexo|capfirst }}</td>
    <td>{{ paciente.propietario.nombre_completo|default:"-" }}</td>
    <td>
        <div class="manage-wheel">
            <button type="button" onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display:none;">
                <button type="button" onclick="window.location.href='{% url 'pacientes:ficha_mascota' paciente.id %}'">
                    <i class="bi bi-eye"></i> Ver
                </button>
                <button type="button" onclick="abrirModalPaciente(this, 'edit', {{ paciente.id }})">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" onclick="abrirModalEliminarPaciente(this, {{ paciente.id }})">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </td>
</tr>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/utils/validators.js' %}?v=1"></script>
<script src="{% static 'js/pacientes/new_paciente.js' %}?v=6"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        attachEmailPhoneValidation('#propietarioEmail', '#propietarioTelefono');
    });
</script>
{% endblock %}