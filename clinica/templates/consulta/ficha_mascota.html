{% extends 'partials/base.html' %}
{% load static %}
{% block title %}Ficha de {{ paciente.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/custom/pacientes.css' %}">
<link rel="stylesheet" href="{% static 'css/custom/consulta_inventario.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="general-container">
        <div class="general-information">
            <div class="section personal-info">
                <div class="section-header-with-edit">
                    <h2>Información General</h2>
                    <button class="btn-edit-icon" id="btnEditarFicha" title="Editar información">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <!-- Botones Guardar / Cancelar (ocultos inicialmente) -->
                    <div id="btnEditActions" style="display:none;">
                        <button class="btn-edit-icon btn-cancel" id="btnCancelar" title="Cancelar">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <button class="btn-edit-icon btn-save" id="btnGuardar" title="Guardar">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="info" id="infoGeneral">
                    <!-- Nombre del paciente -->
                    <div class="info-row info-row-full paciente-nombre-row">
                        <p><strong>Nombre:</strong> <span class="view-mode paciente-nombre-display">{{ paciente.nombre }}</span>
                            <input type="text" class="form-control edit-mode" name="nombre" value="{{ paciente.nombre }}" style="display:none;">
                        </p>
                    </div>

                    <div class="info-row">
                        <p><strong>Especie:</strong> <span class="view-mode">{{ paciente.especie }}</span>
                            <select class="form-control edit-mode" name="especie" style="display:none;">
                                <option value="perro" {% if paciente.especie == 'perro' %}selected{% endif %}>Perro</option>
                                <option value="gato" {% if paciente.especie == 'gato' %}selected{% endif %}>Gato</option>
                                <option value="otro" {% if paciente.especie == 'otro' %}selected{% endif %}>Otro</option>
                            </select>
                        </p>
                        <p><strong>Raza:</strong> <span class="view-mode">{{ paciente.raza|default:"No especificada" }}</span>
                            <input type="text" class="form-control edit-mode" name="raza" value="{{ paciente.raza }}" style="display:none;">
                        </p>
                        <p><strong>Color:</strong> <span class="view-mode">{{ paciente.color|default:"No especificado" }}</span>
                            <input type="text" class="form-control edit-mode" name="color" value="{{ paciente.color }}" style="display:none;">
                        </p>
                        <p><strong>Sexo:</strong>
                            <span class="view-mode">
                                {% if paciente.sexo == 'M' %}Macho{% elif paciente.sexo == 'H' %}Hembra{% else %}{{ paciente.sexo }}{% endif %}
                            </span>
                            <select class="form-control edit-mode" name="sexo" style="display:none;">
                                <option value="M" {% if paciente.sexo == 'M' %}selected{% endif %}>Macho</option>
                                <option value="H" {% if paciente.sexo == 'H' %}selected{% endif %}>Hembra</option>
                            </select>
                        </p>
                    </div>

                    <!-- Sección de Edad con diseño especial -->
                    <div class="edad-section">
                        <p><strong>Edad:</strong> <span class="view-mode">{{ paciente.edad_formateada }}</span></p>

                        <div class="edit-mode edad-edit-container" style="display:none;">
                            <div class="edad-option">
                                <label>
                                    <input type="radio" name="tipo_edad" value="fecha" {% if paciente.fecha_nacimiento %}checked{% endif %}>
                                    <strong>Fecha de nacimiento</strong>
                                </label>
                                <input type="date" class="form-control" name="fecha_nacimiento"
                                    value="{{ paciente.fecha_nacimiento|date:'Y-m-d' }}"
                                    id="fechaNacimiento" max="{% now 'Y-m-d' %}" 
                                    {% if not paciente.fecha_nacimiento %}style="display:none;"{% endif %}>
                            </div>

                            <div class="edad-option">
                                <label>
                                    <input type="radio" name="tipo_edad" value="estimada" {% if not paciente.fecha_nacimiento %}checked{% endif %}>
                                    <strong>Edad estimada</strong>
                                </label>
                                <div id="edadEstimadaInputs" {% if paciente.fecha_nacimiento %}style="display:none;"{% endif %}>
                                    <input type="number" class="form-control" name="edad"
                                        value="{{ paciente.edad_anos|default:'' }}" placeholder="Años" min="0">
                                    <input type="number" class="form-control" name="edad_meses"
                                        value="{{ paciente.edad_meses|default:'' }}" placeholder="Meses" min="0" max="11">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-row info-row-full">
                        <p><strong>Microchip:</strong> <span class="view-mode">{{ paciente.microchip|default:"No tiene" }}</span>
                            <input type="text" class="form-control edit-mode" name="microchip" value="{{ paciente.microchip }}" style="display:none;">
                        </p>
                    </div>

                    <!-- Sección de Observaciones -->
                    {% if paciente.observaciones %}
                    <div class="info-row">
                        <p><strong>Observaciones:</strong> <span class="view-mode">{{ paciente.observaciones }}</span>
                            <textarea class="form-control edit-mode" name="observaciones" style="display:none;">{{ paciente.observaciones }}</textarea>
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Responsable como bloque individual separado -->
            <div class="section responsable-section">
                <div class="section-header-with-edit">
                    <h2>Responsable</h2>
                    <button class="btn-edit-icon" id="btnEditarResponsable" title="Editar responsable">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <!-- Botones Guardar / Cancelar (ocultos inicialmente) -->
                    <div id="btnEditResponsableActions" style="display:none;">
                        <button class="btn-edit-icon btn-cancel" id="btnCancelarResponsable" title="Cancelar">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <button class="btn-edit-icon btn-save" id="btnGuardarResponsable" title="Guardar">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="info" id="infoResponsable">
                    <div class="info-row">
                        <div>
                            <p><strong>Dueño:</strong>
                                <span class="view-mode">{{ paciente.propietario.nombre_completo }}</span>
                            </p>
                            <!-- En modo edición: mostrar nombre y apellido como inputs -->
                            <div id="camposNombreEditable" style="display:none;" class="edit-mode-container">
                                <input type="hidden" name="propietario_id" value="{{ paciente.propietario.id }}">
                                <input type="text" class="form-control edit-mode" name="propietario_nombre_edit"
                                    placeholder="Nombre" value="{{ paciente.propietario.nombre }}" style="margin-bottom: 8px;">
                                <input type="text" class="form-control edit-mode" name="propietario_apellido_edit"
                                    placeholder="Apellido" value="{{ paciente.propietario.apellido }}" style="margin-bottom: 8px;">
                            </div>
                            <!-- SELECT OCULTO INICIALMENTE - se muestra al hacer clic en "Cambiar de responsable" -->
                            <div class="edit-mode" id="propietarioSelector" style="display:none;">
                                <!-- Buscador de responsables -->
                                <input type="text" class="form-control" id="buscarPropietario"
                                    placeholder="Buscar responsable..." autocomplete="off" style="margin-bottom: 10px;">
                                <div id="resultadosBusqueda" class="search-results" style="display:none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;"></div>
                                <small style="display: block; margin-top: 5px;">
                                    <a href="#" id="enlaceNuevoPropietario" style="font-size: 0.85rem;">+ Crear nuevo responsable</a>
                                </small>
                            </div>
                            <!-- CAMPOS PARA CREAR NUEVO PROPIETARIO -->
                            <div id="camposNombrePropietario" class="edit-mode" style="display:none;">
                                <input type="text" class="form-control edit-mode" name="propietario_nombre_new"
                                    placeholder="Nombre" style="margin-bottom: 8px;">
                                <input type="text" class="form-control edit-mode" name="propietario_apellido_new"
                                    placeholder="Apellido" style="margin-bottom: 8px;">
                                <input type="hidden" name="propietario_id" value="">
                                <small style="display: block; margin-top: 5px;">
                                    <a href="#" id="enlaceVoltearAlSelect" style="font-size: 0.85rem;">← Volver al listado</a>
                                </small>
                            </div>
                        </div>
                        <p><strong>Teléfono:</strong>
                            <span class="view-mode">{{ paciente.propietario.telefono|default:"No registrado" }}</span>
                            <input type="tel" class="form-control edit-mode" name="propietario_telefono"
                                value="{{ paciente.propietario.telefono }}" placeholder="+569876543210" style="display:none;">
                            <small class="text-danger" id="errorTelefono" style="display:none;">El teléfono debe tener 9 dígitos (ej: +569876543210 o 987654321)</small>
                        </p>
                    </div>
                    <p><strong>Correo Electrónico:</strong>
                        <span class="view-mode">{{ paciente.propietario.email|default:"No registrado" }}</span>
                        <input type="email" class="form-control edit-mode" name="propietario_email"
                            value="{{ paciente.propietario.email }}" placeholder="ejemplo@correo.com" style="display:none;">
                        <small class="text-danger" id="errorEmail" style="display:none;">El correo debe tener un formato válido (ej: ejemplo@correo.com)</small>
                    </p>
                    <p><strong>Dirección:</strong>
                        <span class="view-mode">{{ paciente.propietario.direccion|default:"No registrada" }}</span>
                        <textarea class="form-control edit-mode" name="propietario_direccion" style="display:none;">{{ paciente.propietario.direccion }}</textarea>
                    </p>
                    
                    <!-- LÍNEA SEPARADORA Y ENLACE "CAMBIAR DE RESPONSABLE" -->
                    <hr style="display:none;" class="edit-mode" id="separadorCambiarResponsable">
                    <div style="display:none; text-align: center; margin-top: 15px;" class="edit-mode" id="enlaceCambiarResponsable">
                        <small>
                            <a href="#" id="btnCambiarResponsable" style="font-size: 0.85rem; text-decoration: underline;">Cambiar de responsable</a>
                        </small>
                    </div>
                </div>
            </div>

            <div class="section resumen-clinico">
                <div class="section-header-with-edit">
                    <h2>Antecedentes Médicos Críticos</h2>
                    <button class="btn-edit-icon" id="btnEditarAntecedentes" title="Editar antecedentes">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <!-- Botones Guardar / Cancelar (ocultos inicialmente) -->
                    <div id="btnEditAntecedentesActions" style="display:none; gap: 0.5rem;">
                        <button class="btn-thin btn-thin-cancel" id="btnCancelarAntecedentes" title="Cancelar">
                            <i class="bi bi-x-lg"></i> Cancelar
                        </button>
                        <button class="btn-thin btn-thin-save" id="btnGuardarAntecedentes" title="Guardar">
                            <i class="bi bi-check-lg"></i> Guardar
                        </button>
                    </div>
                </div>
                <div class="info" id="infoAntecedentes">
                    <div class="info-row">
                        <div style="width: 100%; margin-bottom: 1rem;">
                            <p><strong><i class="bi bi-exclamation-triangle" style="color: #dc3545;"></i> Alergias:</strong> 
                                <span class="view-mode">{{ paciente.alergias|default:"No registradas" }}</span>
                                <textarea class="form-control edit-mode" name="alergias" style="display:none;">{{ paciente.alergias }}</textarea>
                            </p>
                        </div>
                        <div style="width: 100%; margin-bottom: 1rem;">
                            <p><strong><i class="bi bi-heart-pulse" style="color: #e74c3c;"></i> Enfermedades Crónicas:</strong> 
                                <span class="view-mode">{{ paciente.enfermedades_cronicas|default:"No registradas" }}</span>
                                <textarea class="form-control edit-mode" name="enfermedades_cronicas" style="display:none;">{{ paciente.enfermedades_cronicas }}</textarea>
                            </p>
                        </div>
                        <div style="width: 100%; margin-bottom: 1rem;">
                            <p><strong><i class="bi bi-capsule" style="color: #3498db;"></i> Medicamentos Actuales:</strong> 
                                <span class="view-mode">{{ paciente.medicamentos_actuales|default:"Ninguno" }}</span>
                                <textarea class="form-control edit-mode" name="medicamentos_actuales" style="display:none;">{{ paciente.medicamentos_actuales }}</textarea>
                            </p>
                        </div>
                        <div style="width: 100%;">
                            <p><strong><i class="bi bi-hospital" style="color: #9b59b6;"></i> Cirugías Previas:</strong> 
                                <span class="view-mode">{{ paciente.cirugia_previa|default:"Ninguna registrada" }}</span>
                                <textarea class="form-control edit-mode" name="cirugia_previa" style="display:none;">{{ paciente.cirugia_previa }}</textarea>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section resumen-clinico">
                <h2>Resumen Clínico</h2>
                <div class="info">
                    <div class="info-row">
                        <p><strong>Último peso registrado:</strong> {{ paciente.ultimo_peso|default:"No registrado" }} kg</p>
                        <p><strong>Último control:</strong>
                            {% if paciente.consultas.first %}
                            {{ paciente.consultas.first.fecha|date:"d/m/Y H:i" }}
                            {% else %}
                            No registrado
                            {% endif %}
                        </p>
                    </div>
                    <p><strong>Fecha de registro:</strong> {{ paciente.fecha_registro|date:"d/m/Y" }}</p>
                </div>
            </div>
        </div>

        <div class="section tabs-section">
            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="historial">Historial Clínico</button>
                <button class="tab-btn" data-tab="hosp">Hospitalizaciones</button>
                <button class="tab-btn" data-tab="docs">Documentos</button>
            </div>
            <div class="tabs-content">
                <div class="tab-content active" id="historial">
                    <div class="historial-container">
                        <!-- Contenido Principal -->
                        <div class="historial-main">
                            <h3>Historial Clínico</h3>

                            <div class="timeline" id="timeline">
                                {% for consulta in consultas %}
                                <div class="timeline-item"
                                    data-diagnostico="{{ consulta.diagnostico|lower|default:'' }}"
                                    data-tratamiento="{{ consulta.tratamiento|lower|default:'' }}"
                                    data-veterinario="{{ consulta.veterinario.nombre|lower }} {{ consulta.veterinario.apellido|lower }}"
                                    data-veterinario-id="{{ consulta.veterinario.id }}"
                                    data-tipo="{{ consulta.get_tipo_consulta_display|lower }}">
                                    <div class="timeline-date">
                                        <span class="month">{{ consulta.fecha|date:"M" }}</span>
                                        <span class="day">{{ consulta.fecha|date:"d" }}</span>
                                        <span class="year" style="display:none;">{{ consulta.fecha|date:"Y" }}</span>
                                    </div>
                                    <div class="timeline-marker"></div>
                                    <div class="timeline-content">
                                        <div class="timeline-item-header">
                                            <div class="timeline-item-info">
                                                <h3 class="event-title timeline-item-title">
                                                    {{ consulta.get_tipo_consulta_display|default:"Consulta general" }}
                                                    <span class="timeline-item-date">
                                                        {{ consulta.fecha|date:"d/m/Y H:i" }}
                                                    </span>
                                                </h3>
                                                <p class="event-subtitle timeline-item-subtitle">
                                                    <i class="bi bi-person"></i> {{ consulta.veterinario.nombre }} {{ consulta.veterinario.apellido }}
                                                </p>
                                            </div>
                                            <button class="timeline-btn timeline-item-btn" onclick="verDetalleConsulta('{{ consulta.id }}')">
                                                Ver detalle
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="timeline-item empty-state">
                                    <div class="timeline-content" style="text-align: center; padding: 2rem; color: #999;">
                                        <i class="bi bi-clipboard2-pulse" style="font-size: 3rem;"></i>
                                        <p style="margin-top: 1rem;">No hay consultas registradas</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Barra Lateral Derecha -->
                        <div class="historial-sidebar">
                            <!-- Botones de Acción -->
                            <div class="sidebar-actions">
                                <button class="vet-btn vet-btn-primary" id="btnNuevaConsulta" style="width: 100%; margin-bottom: 8px;">
                                    <i class="bi bi-clipboard2-plus"></i> Nueva Consulta
                                </button>
                                <button class="vet-btn vet-btn-success" id="btnAgendarCitaModal" style="width: 100%;">
                                    <i class="bi bi-calendar-plus"></i> Agendar Cita
                                </button>
                            </div>

                            <div class="sidebar-divider"></div>

                            <!-- Buscador -->
                            <div class="sidebar-section">
                                <label class="sidebar-label">Buscar</label>
                                <div class="sidebar-search">
                                    <i class="bi bi-search"></i>
                                    <input type="text" id="searchHistorial" class="form-control form-control-sm"
                                        placeholder="Diagnóstico, veterinario...">
                                </div>
                            </div>

                            <!-- Filtros -->
                            <div class="sidebar-section">
                                <div class="sidebar-label-with-clear">
                                    <label class="sidebar-label">Filtros</label>
                                    <button class="btn-clear-all" id="btnClearFilters" title="Limpiar filtros">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>

                                <!-- Contenedor Grid para Filtros -->
                                <div class="filters-grid">
                                    <!-- Filtro de Fecha -->
                                    <div class="filter-block">
                                        <span class="filter-label">
                                            <i class="bi bi-calendar3"></i> Fecha
                                        </span>
                                        <div class="calendar-inline compact">
                                            <div class="calendar-header">
                                                <button class="calendar-nav" id="btnPrevMonth">
                                                    <i class="bi bi-chevron-left"></i>
                                                </button>
                                                <div class="calendar-title">
                                                    <select id="selectMonth" name="selectMonth" class="calendar-select">
                                                        <option value="">Mes</option>
                                                        <option value="0">Ene</option>
                                                        <option value="1">Feb</option>
                                                        <option value="2">Mar</option>
                                                        <option value="3">Abr</option>
                                                        <option value="4">May</option>
                                                        <option value="5">Jun</option>
                                                        <option value="6">Jul</option>
                                                        <option value="7">Ago</option>
                                                        <option value="8">Sep</option>
                                                        <option value="9">Oct</option>
                                                        <option value="10">Nov</option>
                                                        <option value="11">Dic</option>
                                                    </select>
                                                    <select id="selectYear" name="selectYear" class="calendar-select">
                                                        <option value="">Año</option>
                                                    </select>
                                                </div>
                                                <button class="calendar-nav" id="btnNextMonth">
                                                    <i class="bi bi-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filtro de Veterinario -->
                                    <div class="filter-block">
                                        <span class="filter-label">
                                            <i class="bi bi-person-check"></i> Veterinario
                                        </span>
                                        <select id="filterVeterinario" name="filterVeterinario" class="calendar-select">
                                            <option value="">-- Todos --</option>
                                            {% for vet in veterinarios %}
                                                <option value="{{ vet.id }}">{{ vet.nombre }} {{ vet.apellido }}</option>
                                            {% empty %}
                                                <option disabled>No disponible</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="hosp">
                    <div class="hospitalizaciones">
                        <h3>Hospitalizaciones</h3>
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha ingreso</th>
                                    <th>Fecha alta</th>
                                    <th>Motivo</th>
                                    <th>Veterinario</th>
                                    <th>Estado</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for hosp in hospitalizaciones %}
                                <tr>
                                    <td>{{ hosp.fecha_ingreso|date:"d/m/Y H:i" }}</td>
                                    <td>{{ hosp.fecha_alta|date:"d/m/Y H:i"|default:"-" }}</td>
                                    <td>{{ hosp.motivo }}</td>
                                    <td>{{ hosp.veterinario.get_full_name|default:"-" }}</td>
                                    <td>
                                        <span class="badge bg-{% if hosp.estado == 'activa' %}warning{% elif hosp.estado == 'alta' %}success{% else %}danger{% endif %}">
                                            {{ hosp.get_estado_display }}
                                        </span>
                                    </td>
                                    <td>{{ hosp.notas|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
                                        No hay hospitalizaciones registradas
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-content" id="docs">
                    <div class="documentos">
                        <h3>Documentos</h3>
                        <div style="margin-bottom: 1rem;">
                            <label class="vet-btn vet-btn-primary" style="cursor:pointer;">
                                <i class="bi bi-paperclip"></i> Adjuntar Documento
                                <input type="file" name="adjuntar_documento" style="display:none;"
                                    onchange="subirDocumento(this, {{ paciente.id }})">
                            </label>
                        </div>
                        <ul class="list-group">
                            {% for doc in documentos %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ doc.nombre }}</strong>
                                    {% if doc.descripcion %}
                                    <br><small class="text-muted">{{ doc.descripcion }}</small>
                                    {% endif %}
                                    <br><small class="text-muted">{{ doc.fecha_subida|date:"d/m/Y H:i" }}</small>
                                </div>
                                <a href="{{ doc.archivo.url }}" target="_blank" class="vet-link-exam">
                                    <i class="bi bi-file-earmark-text"></i> Descargar
                                </a>
                            </li>
                            {% empty %}
                            <li class="list-group-item" style="text-align: center; padding: 2rem; color: #999;">
                                No hay documentos adjuntos
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ⭐ MODALES (sin cambios) -->
<!-- Modal Detalle Consulta -->
<div id="detalleConsultaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 id="detalleTitulo" style="margin:0;"><i class="bi bi-clipboard2-pulse"></i> Detalle de Consulta</h3>
            <i class="bi bi-x" id="closeDetalleModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <div class="vet-modal-body">
            <div class="row g-3">
                <div class="col-md-8" id="detalleContenido">
                    <!-- Detalles dinámicos -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Consulta -->
<div id="nuevaConsultaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-clipboard2-plus"></i> Nueva Consulta</h3>
            <i class="bi bi-x" id="closeNuevaConsultaModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formNuevaConsulta">
            <div class="vet-modal-body">
                <!-- Fila compacta con Médico Tratante, Fecha y Tipo de Consulta -->
                <div class="header-info-compact">
                    <div class="info-item">
                        <span class="info-label">Médico:</span>
                        <span class="info-value" id="medicoTratante">{{ user.nombre }} {{ user.apellido }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fecha:</span>
                        <span class="info-value" id="fechaConsulta">{% now "d/m/Y" %}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tipo:</span>
                        <select class="form-control-compact" id="tipoConsultaSelect" name="tipo_consulta" required>
                            <option value="">Seleccionar</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-3">
                        <!-- ⭐ ANTECEDENTES MÉDICOS CRÍTICOS - PRIMERO -->
                        <div class="detail-section" style="border-top: 2px solid #ffc107; padding-top: 1rem; margin-top: 0; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div class="detail-section-title" style="margin: 0; color: #dc3545;">
                                    <i class="bi bi-exclamation-triangle"></i> Antecedentes Médicos
                                </div>
                                <i class="bi bi-pencil" id="btnEditarAntecedentesModal" style="cursor: pointer; font-size: 1.1rem; color: #495057; padding: 0.25rem 0.5rem; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#e9ecef'; this.style.color='#212529';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#495057';" role="button" tabindex="0"></i>
                            </div>
                            
                            <!-- Vista de antecedentes -->
                            <div id="antecedentesVista">
                                <div id="antecedentesContenido" style="font-size: 0.9rem; line-height: 1.6;">
                                    <!-- Se llena dinámicamente -->
                                </div>
                            </div>

                            <!-- Formulario de edición -->
                            <div id="antecedentesEdicionModal" style="display:none; margin-top: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
                                <div class="mb-2">
                                    <label class="form-label form-label-sm"><strong>Alergias</strong></label>
                                    <textarea class="form-control form-control-sm" id="antecedentesAlergias" placeholder="Ej: alergia al pollo" rows="2"></textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label form-label-sm"><strong>Enfermedades Crónicas</strong></label>
                                    <textarea class="form-control form-control-sm" id="antecedentesEnfermedades" placeholder="Ej: diabetes, artritis" rows="2"></textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label form-label-sm"><strong>Medicamentos Actuales</strong></label>
                                    <textarea class="form-control form-control-sm" id="antecedenteMedicamentos" placeholder="Medicamentos actuales" rows="2"></textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label form-label-sm"><strong>Cirugías Previas</strong></label>
                                    <textarea class="form-control form-control-sm" id="antecedenteCirugias" placeholder="Cirugías previas" rows="2"></textarea>
                                </div>
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button type="button" class="btn-thin btn-thin-cancel" id="btnCancelarAntecedentesModal" title="Cancelar">
                                        <i class="bi bi-x-lg"></i> Cancelar
                                    </button>
                                    <button type="button" class="btn-thin btn-thin-save" id="btnGuardarAntecedentesModal" title="Guardar">
                                        <i class="bi bi-check-lg"></i> Guardar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <hr style="margin: 0.75rem 0; border-top: 1px solid #dee2e6;">

                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-thermometer-half"></i> Temperatura</div>
                            <input type="text" class="form-control" name="temperatura" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-speedometer2"></i> Peso</div>
                            <input type="text" class="form-control" name="peso" id="pesoConsulta" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-heart-pulse"></i> Frec. Cardíaca</div>
                            <input type="text" class="form-control" name="frecuencia_cardiaca">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-wind"></i> Frec. Respiratoria</div>
                            <input type="text" class="form-control" name="frecuencia_respiratoria">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-droplet-half"></i> Otros</div>
                            <input type="text" class="form-control" name="otros">
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-clipboard2-check"></i> Diagnóstico</div>
                            <textarea class="form-control" name="diagnostico" rows="5"></textarea>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-capsule"></i> Tratamiento</div>
                            <div class="tratamiento-container">
                                <textarea class="form-control" name="tratamiento" rows="6" placeholder="Descripción del tratamiento..."></textarea>
                                
                                <div class="inventario-selector-compact">
                                    <input type="text" class="form-control form-control-sm" id="searchInventario" placeholder="Buscar medicamento...">
                                    <div class="inventario-list-compact" id="inventarioList">
                                        <!-- Lista dinámica -->
                                    </div>
                                </div>
                                
                                <div class="insumos-utilizados">
                                    <div class="insumos-title">Insumos utilizados:</div>
                                    <div id="insumosSeleccionados">
                                        <!-- Tags dinámicos -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-journal-text"></i> Notas</div>
                            <textarea class="form-control" name="notas" rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-end align-items-center">
                <button type="submit" class="vet-btn vet-btn-primary" id="btnAgendarNuevaCita">
                    <i class="bi bi-check-lg"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Agendar Cita -->
<div id="agendarCitaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-calendar-plus"></i> Agendar Cita</h3>
            <i class="bi bi-x" id="closeAgendarCitaModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formAgendarCita">
            <div class="vet-modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-calendar-event"></i> Fecha</div>
                            <input type="date" class="form-control" name="fecha" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-clock"></i> Hora</div>
                            <input type="time" class="form-control" name="hora" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-list-task"></i> Tipo de Cita</div>
                            <select class="form-control" name="tipo" required>
                                <option value="">Seleccione tipo</option>
                                <option value="hospitalizacion">Hospitalización</option>
                                <option value="consulta">Consulta general</option>
                                <option value="control">Control</option>
                                <option value="vacunacion">Vacunación</option>
                            </select>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-journal-text"></i> Notas</div>
                            <textarea class="form-control" name="notas"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-between align-items-center">
                <span></span>
                <button type="submit" class="vet-btn vet-btn-primary">
                    <i class="bi bi-calendar-plus"></i> Agendar
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Obtener datos del paciente desde la API
    const pacienteId = {{ paciente.id }};
    
    fetch(`/clinica/pacientes/${pacienteId}/data/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.pacienteData = data.paciente;
                console.log('✅ [API] window.pacienteData cargado:', window.pacienteData);
            } else {
                console.error('❌ Error en API:', data.error);
                window.pacienteData = { id: pacienteId };
            }
        })
        .catch(error => {
            console.error('❌ Error al cargar datos del paciente:', error);
            // Fallback: usar al menos el ID
            window.pacienteData = { id: pacienteId };
        });
</script>
<script src="{% static 'js/base/modals_base.js' %}"></script>
<script src="{% static 'js/pacientes/editar_ficha.js' %}"></script>
<script src="{% static 'js/pacientes/antecedentes_medicos.js' %}"></script>
<script src="{% static 'js/pacientes/historial_medico.js' %}"></script>
<script src="{% static 'js/pacientes/inventario_consulta.js' %}"></script>
<script>
// ⭐ CARGAR SERVICIOS DINÁMICAMENTE
document.addEventListener('DOMContentLoaded', function() {
    const tipoConsultaSelect = document.getElementById('tipoConsultaSelect');
    
    if (tipoConsultaSelect) {
        fetch('/clinica/api/servicios/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.servicios) {
                    // Limpiar opciones anteriores excepto la primera
                    while (tipoConsultaSelect.options.length > 1) {
                        tipoConsultaSelect.remove(1);
                    }
                    
                    // Agregar servicios dinámicamente
                    data.servicios.forEach(servicio => {
                        const option = document.createElement('option');
                        option.value = servicio.nombre;  // Usar nombre como valor
                        option.textContent = `${servicio.nombre} (${servicio.categoria})`;
                        tipoConsultaSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error cargando servicios:', error);
                // Fallback a opciones estáticas si hay error
                const opciones_fallback = [
                    { value: 'Consulta General', text: 'Consulta General' },
                    { value: 'Urgencia', text: 'Urgencia' },
                    { value: 'Vacuna', text: 'Vacuna' },
                    { value: 'Control', text: 'Control' },
                ];
                opciones_fallback.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    tipoConsultaSelect.appendChild(option);
                });
            });
    }
});
</script>
{% endblock %}