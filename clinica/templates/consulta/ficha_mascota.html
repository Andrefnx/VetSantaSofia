{% extends 'partials/base.html' %}
{% load static %}
{% block title %}Ficha de {{ paciente.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/custom/pacientes.css' %}">
<link rel="stylesheet" href="{% static 'css/custom/consulta_inventario.css' %}">
<link rel="stylesheet" href="{% static 'css/custom/hospitalizaciones.css' %}">
<!-- Meta data para hospitalizaciones -->
<meta data-paciente-id="{{ paciente.id }}">
<script>
    window.userRol = "{{ user.rol }}";
    window.pacienteId = {{ paciente.id }};
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="general-container">
        <div class="general-information">
            <div class="section personal-info">
                <div class="section-header-with-edit">
                    <h2>Informaci√≥n General</h2>
                    <button class="btn-edit-icon" id="btnEditarFicha" title="Editar informaci√≥n">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <!-- Botones Guardar / Cancelar (ocultos inicialmente) -->
                    <div id="btnEditActions" style="display:none;">
                        <button class="btn-edit-icon btn-cancel" id="btnCancelar" title="Cancelar">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <button class="btn-edit-icon btn-save" id="btnGuardar" title="Guardar">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="info" id="infoGeneral">
                    <!-- Nombre del paciente -->
                    <div class="info-row info-row-full paciente-nombre-row">
                        <p><strong>Nombre:</strong> <span class="view-mode paciente-nombre-display">{{ paciente.nombre }}</span>
                            <input type="text" class="form-control edit-mode" name="nombre" value="{{ paciente.nombre }}" style="display:none;">
                        </p>
                    </div>

                    <!-- Indicador de Hospitalizaci√≥n Activa -->
                    <div id="indicadorHospitalizacion" style="display: none; margin-bottom: 15px;">
                        <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                            <i class="bi bi-hospital" style="font-size: 20px; color: #ffc107;"></i>
                            <div>
                                <strong style="color: #856404;">üè• Paciente Hospitalizado</strong>
                                <div style="font-size: 13px; color: #856404;" id="detallesHospitalizacion"></div>

                            </div>
                        </div>
                    </div>
                    <div class="info-row">
                        <p><strong>Especie:</strong> <span class="view-mode">{{ paciente.especie }}</span>
                            <select class="form-control edit-mode" name="especie" style="display:none;">
                                <option value="perro" {% if paciente.especie == 'perro' %}selected{% endif %}>Perro</option>
                                <option value="gato" {% if paciente.especie == 'gato' %}selected{% endif %}>Gato</option>
                                <option value="otro" {% if paciente.especie == 'otro' %}selected{% endif %}>Otro</option>
                            </select>
                        </p>
                        <p><strong>Raza:</strong> <span class="view-mode">{{ paciente.raza|default:"No especificada" }}</span>
                            <input type="text" class="form-control edit-mode" name="raza" value="{{ paciente.raza }}" style="display:none;">
                        </p>
                        <p><strong>Color:</strong> <span class="view-mode">{{ paciente.color|default:"No especificado" }}</span>
                            <input type="text" class="form-control edit-mode" name="color" value="{{ paciente.color }}" style="display:none;">
                        </p>
                        <p><strong>Sexo:</strong>
                            <span class="view-mode">
                                {% if paciente.sexo == 'M' %}Macho{% elif paciente.sexo == 'H' %}Hembra{% else %}{{ paciente.sexo }}{% endif %}
                            </span>
                            <select class="form-control edit-mode" name="sexo" style="display:none;">
                                <option value="M" {% if paciente.sexo == 'M' %}selected{% endif %}>Macho</option>
                                <option value="H" {% if paciente.sexo == 'H' %}selected{% endif %}>Hembra</option>
                            </select>
                        </p>
                    </div>

                    <!-- Secci√≥n de Edad con dise√±o especial -->
                    <div class="edad-section">
                        <p><strong>Edad:</strong> <span class="view-mode">{{ paciente.edad_formateada }}</span></p>

                        <div class="edit-mode edad-edit-container" style="display:none;">
                            <div class="edad-option">
                                <label>
                                    <input type="radio" name="tipo_edad" value="fecha" {% if paciente.fecha_nacimiento %}checked{% endif %}>
                                    <strong>Fecha de nacimiento</strong>
                                </label>
                                <input type="date" class="form-control" name="fecha_nacimiento"
                                    value="{{ paciente.fecha_nacimiento|date:'Y-m-d' }}"
                                    id="fechaNacimiento" max="{% now 'Y-m-d' %}" 
                                    {% if not paciente.fecha_nacimiento %}style="display:none;"{% endif %}>
                            </div>

                            <div class="edad-option">
                                <label>
                                    <input type="radio" name="tipo_edad" value="estimada" {% if not paciente.fecha_nacimiento %}checked{% endif %}>
                                    <strong>Edad estimada</strong>
                                </label>
                                <div id="edadEstimadaInputs" {% if paciente.fecha_nacimiento %}style="display:none;"{% endif %}>
                                    <input type="number" class="form-control" name="edad"
                                        value="{{ paciente.edad_anos|default:'' }}" placeholder="A√±os" min="0">
                                    <input type="number" class="form-control" name="edad_meses"
                                        value="{{ paciente.edad_meses|default:'' }}" placeholder="Meses" min="0" max="11">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-row info-row-full">
                        <p><strong>Microchip:</strong> <span class="view-mode">{{ paciente.microchip|default:"No tiene" }}</span>
                            <input type="text" class="form-control edit-mode" name="microchip" value="{{ paciente.microchip }}" style="display:none;">
                        </p>
                    </div>

                    <!-- Secci√≥n de Observaciones -->
                    {% if paciente.observaciones %}
                    <div class="info-row">
                        <p><strong>Observaciones:</strong> <span class="view-mode">{{ paciente.observaciones }}</span>
                            <textarea class="form-control edit-mode" name="observaciones" style="display:none;">{{ paciente.observaciones }}</textarea>
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Responsable como bloque individual separado -->
            <div class="section responsable-section">
                <div class="section-header-with-edit">
                    <h2>Responsable</h2>
                    <button class="btn-edit-icon" id="btnEditarResponsable" title="Editar responsable">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <!-- Botones Guardar / Cancelar (ocultos inicialmente) -->
                    <div id="btnEditResponsableActions" style="display:none;">
                        <button class="btn-edit-icon btn-cancel" id="btnCancelarResponsable" title="Cancelar">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <button class="btn-edit-icon btn-save" id="btnGuardarResponsable" title="Guardar">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="info" id="infoResponsable">
                    <div class="info-row">
                        <div>
                            <p><strong>Due√±o:</strong>
                                <span class="view-mode">{{ paciente.propietario.nombre_completo }}</span>
                            </p>
                            <!-- En modo edici√≥n: mostrar nombre y apellido como inputs -->
                            <div id="camposNombreEditable" style="display:none;" class="edit-mode-container">
                                <input type="hidden" name="propietario_id" value="{{ paciente.propietario.id }}">
                                <input type="text" class="form-control edit-mode" name="propietario_nombre_edit"
                                    placeholder="Nombre" value="{{ paciente.propietario.nombre }}" style="margin-bottom: 8px;">
                                <input type="text" class="form-control edit-mode" name="propietario_apellido_edit"
                                    placeholder="Apellido" value="{{ paciente.propietario.apellido }}" style="margin-bottom: 8px;">
                            </div>
                            <!-- SELECT OCULTO INICIALMENTE - se muestra al hacer clic en "Cambiar de responsable" -->
                            <div class="edit-mode" id="propietarioSelector" style="display:none;">
                                <!-- Buscador de responsables -->
                                <input type="text" class="form-control" id="buscarPropietario"
                                    placeholder="Buscar responsable..." autocomplete="off" style="margin-bottom: 10px;">
                                <div id="resultadosBusqueda" class="search-results" style="display:none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;"></div>
                                <small style="display: block; margin-top: 5px;">
                                    <a href="#" id="enlaceNuevoPropietario" style="font-size: 0.85rem;">+ Crear nuevo responsable</a>
                                </small>
                            </div>
                            <!-- CAMPOS PARA CREAR NUEVO PROPIETARIO -->
                            <div id="camposNombrePropietario" class="edit-mode" style="display:none;">
                                <input type="text" class="form-control edit-mode" name="propietario_nombre_new"
                                    placeholder="Nombre" style="margin-bottom: 8px;">
                                <input type="text" class="form-control edit-mode" name="propietario_apellido_new"
                                    placeholder="Apellido" style="margin-bottom: 8px;">
                                <input type="hidden" name="propietario_id" value="">
                                <small style="display: block; margin-top: 5px;">
                                    <a href="#" id="enlaceVoltearAlSelect" style="font-size: 0.85rem;">‚Üê Volver al listado</a>
                                </small>
                            </div>
                        </div>
                        <p><strong>Tel√©fono:</strong>
                            <span class="view-mode">{{ paciente.propietario.telefono|default:"No registrado" }}</span>
                            <input type="tel" class="form-control edit-mode" name="propietario_telefono"
                                value="{{ paciente.propietario.telefono }}" placeholder="+569876543210" 
                                data-phone="true" style="display:none;">
                        </p>
                    </div>
                    <p><strong>Correo Electr√≥nico:</strong>
                        <span class="view-mode">{{ paciente.propietario.email|default:"No registrado" }}</span>
                        <input type="email" class="form-control edit-mode" name="propietario_email"
                            value="{{ paciente.propietario.email }}" placeholder="ejemplo@correo.com" 
                            data-email="true" style="display:none;">
                    </p>
                    <p><strong>Direcci√≥n:</strong>
                        <span class="view-mode">{{ paciente.propietario.direccion|default:"No registrada" }}</span>
                        <textarea class="form-control edit-mode" name="propietario_direccion" style="display:none;">{{ paciente.propietario.direccion }}</textarea>
                    </p>
                    
                    <!-- L√çNEA SEPARADORA Y ENLACE "CAMBIAR DE RESPONSABLE" -->
                    <hr style="display:none;" class="edit-mode" id="separadorCambiarResponsable">
                    <div style="display:none; text-align: center; margin-top: 15px;" class="edit-mode" id="enlaceCambiarResponsable">
                        <small>
                            <a href="#" id="btnCambiarResponsable" style="font-size: 0.85rem; text-decoration: underline;">Cambiar de responsable</a>
                        </small>
                    </div>
                </div>
            </div>

            {% if user.rol != 'recepcion' %}
            <div class="section resumen-clinico antecedentes-compact">
                <div class="section-header-with-edit">
                    <h2>Antecedentes M√©dicos Cr√≠ticos</h2>
                    <button class="btn-edit-icon" id="btnEditarAntecedentes" title="Editar antecedentes">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <!-- Acciones de edici√≥n (mismo patr√≥n que Responsable) -->
                    <div id="btnEditAntecedentesActions" style="display:none;">
                        <button class="btn-edit-icon btn-cancel" id="btnCancelarAntecedentes" title="Cancelar">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <button class="btn-edit-icon btn-save" id="btnGuardarAntecedentes" title="Guardar">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="info" id="infoAntecedentes">
                    <div class="info-row">
                        <p>
                            <strong>Alergias:</strong>
                            <span class="view-mode">{{ paciente.alergias|default:"No registradas" }}</span>
                            <textarea class="form-control edit-mode" name="alergias" style="display:none;">{{ paciente.alergias }}</textarea>
                        </p>
                        <p>
                            <strong>Enfermedades Cr√≥nicas:</strong>
                            <span class="view-mode">{{ paciente.enfermedades_cronicas|default:"No registradas" }}</span>
                            <textarea class="form-control edit-mode" name="enfermedades_cronicas" style="display:none;">{{ paciente.enfermedades_cronicas }}</textarea>
                        </p>
                    </div>
                    <div class="info-row">
                        <p>
                            <strong>Medicamentos Actuales:</strong>
                            <span class="view-mode">{{ paciente.medicamentos_actuales|default:"Ninguno" }}</span>
                            <textarea class="form-control edit-mode" name="medicamentos_actuales" style="display:none;">{{ paciente.medicamentos_actuales }}</textarea>
                        </p>
                        <p>
                            <strong>Cirug√≠as Previas:</strong>
                            <span class="view-mode">{{ paciente.cirugia_previa|default:"Ninguna registrada" }}</span>
                            <textarea class="form-control edit-mode" name="cirugia_previa" style="display:none;">{{ paciente.cirugia_previa }}</textarea>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if user.rol != 'recepcion' %}
            <div class="section resumen-clinico">
                <h2>Resumen Cl√≠nico</h2>
                <div class="info">
                    <div class="info-row">
                        <p><strong>√öltimo peso registrado:</strong> {{ paciente.ultimo_peso|default:"No registrado" }} kg</p>
                        <p><strong>√öltimo control:</strong>
                            {% if paciente.consultas.first %}
                            {{ paciente.consultas.first.fecha|date:"d/m/Y H:i" }}
                            {% else %}
                            No registrado
                            {% endif %}
                        </p>
                    </div>
                    <p><strong>Fecha de registro:</strong> {{ paciente.fecha_registro|date:"d/m/Y" }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="section tabs-section">
            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="historial">Historial Cl√≠nico</button>
                <button class="tab-btn" data-tab="hosp">Hospitalizaciones</button>
                {% if user.rol != 'recepcion' %}
                <button class="tab-btn" data-tab="docs">Documentos</button>
                {% endif %}
            </div>
            <div class="tabs-content">
                <div class="tab-content active" id="historial">
                    <div class="historial-container">
                        <!-- Contenido Principal -->
                        <div class="historial-main">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <h3 class="mb-0">Historial Cl√≠nico 
                                    <small style="color: #6b7280; font-size: 0.8rem; font-weight: normal;">
                                        ({{ citas_agendadas|length }} cita{{ citas_agendadas|length|pluralize }} agendada{{ citas_agendadas|length|pluralize }})
                                    </small>
                                </h3>
                                <form method="get" class="d-flex align-items-center gap-2">
                                    <label class="mb-0 small text-muted">Orden</label>
                                    <select name="orden_timeline" class="form-select form-select-sm" onchange="this.form.submit()" style="width: auto;">
                                        <option value="desc" {% if orden_timeline != 'asc' %}selected{% endif %}>Descendente</option>
                                        <option value="asc" {% if orden_timeline == 'asc' %}selected{% endif %}>Ascendente</option>
                                        
                                    </select>
                                    {% for key, value in request.GET.items %}
                                        {% if key != 'orden_timeline' %}
                                            <input type="hidden" name="{{ key }}" value="{{ value }}" />
                                        {% endif %}
                                    {% endfor %}
                                </form>
                                <small class="text-muted" style="margin-left:auto;">Items: {{ timeline_items|length }}</small>
                            </div>
                            <!-- DEBUG: Citas count = {{ citas_agendadas|length }} -->
                            <!-- DEBUG: citas_agendadas existe = {% if citas_agendadas %}SI{% else %}NO{% endif %} -->
                            <!-- DEBUG: Tipo = {{ citas_agendadas|default:"UNDEFINED" }} -->
                            {% if citas_agendadas %}
                                {% for c in citas_agendadas %}
                                    <!-- DEBUG CITA: ID={{ c.id }} Fecha={{ c.fecha }} Hora={{ c.hora_inicio }} -->
                                {% endfor %}
                            {% endif %}
                            
                            <div class="timeline" id="timeline">
                                <!-- START CITAS AGENDADAS LOOP -->
                                {% if timeline_items %}
                                    {% for item in timeline_items %}
                                        {% if item.tipo == 'cita' %}
                                            {% with cita=item.obj %}
                                            <div class="timeline-item" 
                                                data-cita-id="{{ cita.id }}"
                                                data-servicio="{{ cita.servicio.nombre|default:'' }}"
                                                data-veterinario="{{ cita.veterinario.nombre }} {{ cita.veterinario.apellido }}"
                                                data-fecha="{{ item.fecha|date:'d/m/Y' }}"
                                                data-hora="{{ cita.hora_inicio|time:'H:i' }}">
                                                <div class="timeline-date">
                                                    <span class="month">{{ item.fecha|date:"M" }}</span>
                                                    <span class="day">{{ item.fecha|date:"d" }}</span>
                                                    <span class="year" style="display:none;">{{ item.fecha|date:"Y" }}</span>
                                                </div>
                                                <div class="timeline-marker"></div>
                                                <div class="timeline-content">
                                                    <div class="timeline-card timeline-cita-agendada">
                                                        <div class="timeline-item-header">
                                                            <div class="timeline-item-info">
                                                                <h3 class="event-title timeline-item-title">
                                                                    {{ cita.servicio.nombre|default:"Cita agendada" }}
                                                                    <span class="timeline-item-date">
                                                                        {{ item.fecha|date:"d/m/Y" }} {{ cita.hora_inicio|time:"H:i" }} - {{ cita.hora_fin|time:"H:i" }}
                                                                    </span>
                                                                </h3>
                                                                <p class="event-subtitle timeline-item-subtitle">
                                                                    <i class="bi bi-person"></i> {{ cita.veterinario.nombre }} {{ cita.veterinario.apellido }}
                                                                </p>
                                                                <div class="timeline-item-meta">
                                                                    {% if cita.estado == 'completada' or cita.estado == 'realizada' %}
                                                                        <span class="cita-status-pill estado-realizada">Realizada</span>
                                                                    {% else %}
                                                                        <span class="cita-status-pill estado-pendiente">Pendiente</span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% if user.id == cita.veterinario_id %}
                                                            <button class="timeline-btn timeline-item-btn" onclick="iniciarCitaDesdeFicha({{ cita.id }}, this)">
                                                                Iniciar
                                                            </button>
                                                            {% else %}
                                                            <span class="badge bg-secondary" style="font-weight: 600;">Asignada a {{ cita.veterinario.nombre }} {{ cita.veterinario.apellido }}</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endwith %}
                                        {% else %}
                                            {% with consulta=item.obj %}
                                            <div class="timeline-item"
                                                data-diagnostico="{{ consulta.diagnostico|lower|default:'' }}"
                                                data-tratamiento="{{ consulta.tratamiento|lower|default:'' }}"
                                                data-veterinario="{{ consulta.veterinario.nombre|lower }} {{ consulta.veterinario.apellido|lower }}"
                                                data-veterinario-id="{{ consulta.veterinario.id }}"
                                                data-tipo="{{ consulta.get_tipo_consulta_display|lower }}">
                                                <div class="timeline-date">
                                                    <span class="month">{{ item.fecha|date:"M" }}</span>
                                                    <span class="day">{{ item.fecha|date:"d" }}</span>
                                                    <span class="year" style="display:none;">{{ item.fecha|date:"Y" }}</span>
                                                </div>
                                                <div class="timeline-marker"></div>
                                                <div class="timeline-content">
                                                    <div class="timeline-item-header">
                                                        <div class="timeline-item-info">
                                                            <h3 class="event-title timeline-item-title">
                                                                {{ consulta.servicios_nombres|default:"Consulta general" }}
                                                                <span class="timeline-item-date">
                                                                    {{ consulta.fecha|date:"d/m/Y H:i" }}
                                                                </span>
                                                            </h3>
                                                            <p class="event-subtitle timeline-item-subtitle">
                                                                <i class="bi bi-person"></i> {{ consulta.veterinario.nombre }} {{ consulta.veterinario.apellido }}
                                                            </p>
                                                        </div>
                                                        {% if user.rol != 'recepcion' %}
                                                        <button class="timeline-btn timeline-item-btn" onclick="verDetalleConsulta('{{ consulta.id }}')">
                                                            Ver detalle
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endwith %}
                                        {% endif %}
                                    {% endfor %}
                                {% elif citas_agendadas or consultas %}
                                    {% for cita in citas_agendadas %}
                                    <div class="timeline-item" 
                                        data-cita-id="{{ cita.id }}"
                                        data-servicio="{{ cita.servicio.nombre|default:'' }}"
                                        data-veterinario="{{ cita.veterinario.nombre }} {{ cita.veterinario.apellido }}"
                                        data-fecha="{{ cita.fecha|date:'d/m/Y' }}"
                                        data-hora="{{ cita.hora_inicio|time:'H:i' }}">
                                        <div class="timeline-date">
                                            <span class="month">{{ cita.fecha|date:"M" }}</span>
                                            <span class="day">{{ cita.fecha|date:"d" }}</span>
                                            <span class="year" style="display:none;">{{ cita.fecha|date:"Y" }}</span>
                                        </div>
                                        <div class="timeline-marker"></div>
                                        <div class="timeline-content">
                                            <div class="timeline-card timeline-cita-agendada">
                                                <div class="timeline-item-header">
                                                    <div class="timeline-item-info">
                                                        <h3 class="event-title timeline-item-title">
                                                            {{ cita.servicio.nombre|default:"Cita agendada" }}
                                                            <span class="timeline-item-date">
                                                                {{ cita.fecha|date:"d/m/Y" }} {{ cita.hora_inicio|time:"H:i" }} - {{ cita.hora_fin|time:"H:i" }}
                                                            </span>
                                                        </h3>
                                                        <p class="event-subtitle timeline-item-subtitle">
                                                            <i class="bi bi-person"></i> {{ cita.veterinario.nombre }} {{ cita.veterinario.apellido }}
                                                        </p>
                                                    </div>
                                                    {% if user.id == cita.veterinario_id %}
                                                    <button class="timeline-btn timeline-item-btn" onclick="iniciarCitaDesdeFicha({{ cita.id }}, this)">
                                                        Iniciar
                                                    </button>
                                                    {% else %}
                                                    <span class="badge bg-secondary" style="font-weight: 600;">Asignada a {{ cita.veterinario.nombre }} {{ cita.veterinario.apellido }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}

                                    {% for consulta in consultas %}
                                    <div class="timeline-item"
                                        data-diagnostico="{{ consulta.diagnostico|lower|default:'' }}"
                                        data-tratamiento="{{ consulta.tratamiento|lower|default:'' }}"
                                        data-veterinario="{{ consulta.veterinario.nombre|lower }} {{ consulta.veterinario.apellido|lower }}"
                                        data-veterinario-id="{{ consulta.veterinario.id }}"
                                        data-tipo="{{ consulta.get_tipo_consulta_display|lower }}">
                                        <div class="timeline-date">
                                            <span class="month">{{ consulta.fecha|date:"M" }}</span>
                                            <span class="day">{{ consulta.fecha|date:"d" }}</span>
                                            <span class="year" style="display:none;">{{ consulta.fecha|date:"Y" }}</span>
                                        </div>
                                        <div class="timeline-marker"></div>
                                        <div class="timeline-content">
                                            <div class="timeline-item-header">
                                                <div class="timeline-item-info">
                                                    <h3 class="event-title timeline-item-title">
                                                        {{ consulta.servicios_nombres|default:"Consulta general" }}
                                                        <span class="timeline-item-date">
                                                            {{ consulta.fecha|date:"d/m/Y H:i" }}
                                                        </span>
                                                    </h3>
                                                    <p class="event-subtitle timeline-item-subtitle">
                                                        <i class="bi bi-person"></i> {{ consulta.veterinario.nombre }} {{ consulta.veterinario.apellido }}
                                                    </p>
                                                </div>
                                                {% if user.rol != 'recepcion' %}
                                                <button class="timeline-btn timeline-item-btn" onclick="verDetalleConsulta('{{ consulta.id }}')">
                                                    Ver detalle
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="timeline-item empty-state">
                                        <div class="timeline-content" style="text-align: center; padding: 2rem; color: #999;">
                                            <i class="bi bi-clipboard2-pulse" style="font-size: 3rem;"></i>
                                            <p style="margin-top: 1rem;">No hay consultas registradas</p>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Barra Lateral Derecha -->
                        <div class="historial-sidebar">
                            <!-- Botones de Acci√≥n -->
                            <div class="sidebar-actions">
                                {% if user.rol != 'recepcion' %}
                                <button class="vet-btn vet-btn-primary" id="btnNuevaConsulta" style="width: 100%; margin-bottom: 8px;">
                                    <i class="bi bi-clipboard2-plus"></i> Nueva Consulta
                                </button>
                                <button class="vet-btn vet-btn-warning" id="btnNuevaHospitalizacion" style="width: 100%; margin-bottom: 8px;">
                                    <i class="bi bi-hospital"></i> Hospitalizaci√≥n
                                </button>
                                <button class="vet-btn vet-btn-success" id="btnAgendarCitaModal" style="width: 100%; display: none;">
                                    <i class="bi bi-calendar-plus"></i> Agendar Cita
                                </button>
                                {% endif %}
                            </div>

                            <div class="sidebar-divider"></div>

                            <!-- Buscador -->
                            <div class="sidebar-section">
                                <label class="sidebar-label">Buscar</label>
                                <div class="sidebar-search">
                                    <i class="bi bi-search"></i>
                                    <input type="text" id="searchHistorial" class="form-control form-control-sm"
                                        placeholder="Diagn√≥stico, veterinario...">
                                </div>
                            </div>

                            <!-- Filtros -->
                            <div class="sidebar-section">
                                <div class="sidebar-label-with-clear">
                                    <label class="sidebar-label">Filtros</label>
                                    <button class="btn-clear-all" id="btnClearFilters" title="Limpiar filtros">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>

                                <!-- Contenedor Grid para Filtros -->
                                <div class="filters-grid">
                                    <!-- Filtro de Fecha -->
                                    <div class="filter-block">
                                        <span class="filter-label">
                                            <i class="bi bi-calendar3"></i> Fecha
                                        </span>
                                        <div class="calendar-inline compact">
                                            <div class="calendar-header">
                                                <button class="calendar-nav" id="btnPrevMonth">
                                                    <i class="bi bi-chevron-left"></i>
                                                </button>
                                                <div class="calendar-title">
                                                    <select id="selectMonth" name="selectMonth" class="calendar-select">
                                                        <option value="">Mes</option>
                                                        <option value="0">Ene</option>
                                                        <option value="1">Feb</option>
                                                        <option value="2">Mar</option>
                                                        <option value="3">Abr</option>
                                                        <option value="4">May</option>
                                                        <option value="5">Jun</option>
                                                        <option value="6">Jul</option>
                                                        <option value="7">Ago</option>
                                                        <option value="8">Sep</option>
                                                        <option value="9">Oct</option>
                                                        <option value="10">Nov</option>
                                                        <option value="11">Dic</option>
                                                    </select>
                                                    <select id="selectYear" name="selectYear" class="calendar-select">
                                                        <option value="">A√±o</option>
                                                    </select>
                                                </div>
                                                <button class="calendar-nav" id="btnNextMonth">
                                                    <i class="bi bi-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filtro de Veterinario -->
                                    <div class="filter-block">
                                        <span class="filter-label">
                                            <i class="bi bi-person-check"></i> Veterinario
                                        </span>
                                        <select id="filterVeterinario" name="filterVeterinario" class="calendar-select">
                                            <option value="">-- Todos --</option>
                                            {% for vet in veterinarios %}
                                                <option value="{{ vet.id }}">{{ vet.nombre }} {{ vet.apellido }}</option>
                                            {% empty %}
                                                <option disabled>No disponible</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="hosp">
                    <div class="hospitalizaciones-section" style="display: flex; gap: 1.5rem;">
                        <!-- Contenido Principal -->
                        <div class="historial-main" style="flex: 1;">
                            <h3 style="margin-bottom: 1.5rem;">Registro de Hospitalizaciones</h3>
                            
                            <!-- Contenedor din√°mico para hospitalizaciones -->
                            <div id="hospitalizacionesContainer">
                                <!-- Se carga din√°micamente via JavaScript -->
                            </div>
                        </div>

                        <!-- Sidebar Filtros -->
                        <div class="historial-sidebar">
                            <!-- Buscador -->
                            <div class="sidebar-section">
                                <label class="sidebar-label">Buscar</label>
                                <div class="sidebar-search">
                                    <i class="bi bi-search"></i>
                                    <input type="text" id="searchHospitalizacion" class="form-control form-control-sm"
                                        placeholder="Motivo, diagn√≥stico...">
                                </div>
                            </div>

                            <!-- Filtros -->
                            <div class="sidebar-section">
                                <div class="sidebar-label-with-clear">
                                    <label class="sidebar-label">Filtros</label>
                                    <button class="btn-clear-all" id="btnClearHospFilters" title="Limpiar filtros">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>

                                <!-- Contenedor Grid para Filtros -->
                                <div class="filters-grid">
                                    <!-- Filtro de Fecha -->
                                    <div class="filter-block">
                                        <span class="filter-label">
                                            <i class="bi bi-calendar3"></i> Fecha
                                        </span>
                                        <div class="calendar-inline compact">
                                            <div class="calendar-header">
                                                <button class="calendar-nav" id="btnHospPrevMonth">
                                                    <i class="bi bi-chevron-left"></i>
                                                </button>
                                                <div class="calendar-title">
                                                    <select id="selectHospMonth" class="calendar-select">
                                                        <option value="">Mes</option>
                                                        <option value="1">Ene</option>
                                                        <option value="2">Feb</option>
                                                        <option value="3">Mar</option>
                                                        <option value="4">Abr</option>
                                                        <option value="5">May</option>
                                                        <option value="6">Jun</option>
                                                        <option value="7">Jul</option>
                                                        <option value="8">Ago</option>
                                                        <option value="9">Sep</option>
                                                        <option value="10">Oct</option>
                                                        <option value="11">Nov</option>
                                                        <option value="12">Dic</option>
                                                    </select>
                                                    <select id="selectHospYear" class="calendar-select">
                                                        <option value="">A√±o</option>
                                                    </select>
                                                </div>
                                                <button class="calendar-nav" id="btnHospNextMonth">
                                                    <i class="bi bi-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filtro de Estado -->
                                    <div class="filter-block">
                                        <span class="filter-label">
                                            <i class="bi bi-circle-fill"></i> Estado
                                        </span>
                                        <div class="filter-checkboxes">
                                            <label class="filter-checkbox">
                                                <input type="checkbox" id="filterHospActiva" value="activa" checked>
                                                <span>Activa</span>
                                            </label>
                                            <label class="filter-checkbox">
                                                <input type="checkbox" id="filterHospAlta" value="alta" checked>
                                                <span>Alta</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if user.rol != 'recepcion' %}
                <div class="tab-content" id="docs">
                    <div class="documentos">
                        <h3>Documentos</h3>
                        <div style="margin-bottom: 1rem;">
                            <label class="vet-btn vet-btn-primary" style="cursor:pointer;">
                                <i class="bi bi-paperclip"></i> Adjuntar Documento
                                <input type="file" id="inputDocumento" name="adjuntar_documento" style="display:none;"
                                    onchange="subirDocumento(this, {{ paciente.id }})">
                            </label>
                        </div>
                        <ul class="list-group" id="listaDocumentos">
                            {% for doc in documentos %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" data-doc-id="{{ doc.id }}">
                                <div>
                                    <strong>{{ doc.nombre }}</strong>
                                    {% if doc.descripcion %}
                                    <br><small class="text-muted">{{ doc.descripcion }}</small>
                                    {% endif %}
                                    <br><small class="text-muted">{{ doc.fecha_subida|date:"d/m/Y H:i" }}</small>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <a href="{{ doc.archivo.url }}" target="_blank" class="vet-link-exam">
                                        <i class="bi bi-file-earmark-text"></i> Ver
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="eliminarDocumento({{ doc.id }})" title="Eliminar documento">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </li>
                            {% empty %}
                            <li class="list-group-item" id="mensajeSinDocumentos" style="text-align: center; padding: 2rem; color: #999;">
                                No hay documentos adjuntos
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ‚≠ê MODALES (sin cambios) -->

<script>
// Toggle edici√≥n de Antecedentes en la ficha (no modal)
document.addEventListener('DOMContentLoaded', function() {
    const btnEditar = document.getElementById('btnEditarAntecedentes');
    const acciones = document.getElementById('btnEditAntecedentesActions');
    const contenedor = document.getElementById('infoAntecedentes');
    const btnCancelar = document.getElementById('btnCancelarAntecedentes');
    const btnGuardar = document.getElementById('btnGuardarAntecedentes');

    if (!btnEditar || !acciones || !contenedor) return;

    const setEditMode = (editing) => {
        // Mostrar/ocultar acciones
        acciones.style.display = editing ? 'flex' : 'none';
        // Ocultar/mostrar el l√°piz mientras se edita
        btnEditar.style.display = editing ? 'none' : 'inline-flex';
        // Alternar clase de edici√≥n; el CSS controla qu√© se muestra
        contenedor.classList.toggle('edit-mode-active', editing);
    };

    // Inicial: solo texto
    setEditMode(false);

    btnEditar.addEventListener('click', () => setEditMode(true));
    btnCancelar?.addEventListener('click', () => setEditMode(false));

    // Guardar: mantener UI coherente; env√≠o se maneja por backend o JS existente
    btnGuardar?.addEventListener('click', () => {
        // Aqu√≠ podr√≠as recopilar datos si existe flujo de guardado espec√≠fico
        setEditMode(false);
    });
});
</script>
<!-- Modal Detalle Consulta -->
<div id="detalleConsultaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 id="detalleTitulo" style="margin:0;"><i class="bi bi-clipboard2-pulse"></i> Detalle de Consulta</h3>
            <i class="bi bi-x" id="closeDetalleModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <div class="vet-modal-body">
            <div class="row g-3">
                <div class="col-md-8" id="detalleContenido">
                    <!-- Detalles din√°micos -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Consulta -->
<div id="nuevaConsultaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-clipboard2-plus"></i> Nueva Consulta</h3>
            <i class="bi bi-x" id="closeNuevaConsultaModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formNuevaConsulta">
            <div class="vet-modal-body">
                <!-- Fila compacta con M√©dico Tratante, Fecha y Tipo de Consulta -->
                <div class="header-info-compact">
                    <div class="info-item">
                        <span class="info-label">M√©dico:</span>
                        <span class="info-value" id="medicoTratante">{{ user.nombre }} {{ user.apellido }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fecha:</span>
                        <span class="info-value" id="fechaConsulta">{% now "d/m/Y" %}</span>
                    </div>
                    <div class="info-item" style="flex: 1;">
                        <span class="info-label">Servicios:</span>
                        <div style="position: relative;">
                            <input type="text" class="form-control-compact" id="buscarServicio" placeholder="Buscar servicios..." autocomplete="off" style="width: 100%;">
                            <div id="resultadosServicio" style="display: none; position: absolute; top: 100%; left: 0; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; width: 100%; margin-top: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                        </div>
                        <div id="serviciosSeleccionados" style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; max-height: 50px; overflow-y: auto;"></div>
                        <input type="hidden" id="serviciosIds" name="servicios_ids">
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-3">
                        <!-- ‚≠ê ANTECEDENTES M√âDICOS CR√çTICOS - PRIMERO -->
                        <div class="detail-section" style="border-top: 2px solid #ffc107; padding-top: 1rem; margin-top: 0; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div class="detail-section-title" style="margin: 0; color: #dc3545;">
                                    <i class="bi bi-exclamation-triangle"></i> Antecedentes M√©dicos
                                </div>
                                <i class="bi bi-pencil" id="btnEditarAntecedentesModal" style="cursor: pointer; font-size: 1.1rem; color: #495057; padding: 0.25rem 0.5rem; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#e9ecef'; this.style.color='#212529';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#495057';" role="button" tabindex="0"></i>
                            </div>
                            
                            <!-- Vista de antecedentes -->
                            <div id="antecedentesVista">
                                <div id="antecedentesContenido" style="font-size: 0.9rem; line-height: 1.6;">
                                    <!-- Se llena din√°micamente -->
                                </div>
                            </div>

                            <!-- Formulario de edici√≥n -->
                            <div id="antecedentesEdicionModal" style="display:none; margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border-radius: 6px; border: 1px solid #e9ecef;">
                                <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <div>
                                        <label class="form-label form-label-sm" style="font-weight: 600; font-size: 0.85rem; color: #495057; margin-bottom: 0.35rem; display: block;">
                                            <i class="bi bi-exclamation-triangle" style="color: #dc3545; margin-right: 0.25rem;"></i> Alergias
                                        </label>
                                        <textarea class="form-control form-control-sm" id="antecedentesAlergias" placeholder="Ej: alergia al pollo" rows="2" style="font-size: 0.85rem;"></textarea>
                                    </div>
                                    <div>
                                        <label class="form-label form-label-sm" style="font-weight: 600; font-size: 0.85rem; color: #495057; margin-bottom: 0.35rem; display: block;">
                                            <i class="bi bi-heart-pulse" style="color: #ffc107; margin-right: 0.25rem;"></i> Enfermedades Cr√≥nicas
                                        </label>
                                        <textarea class="form-control form-control-sm" id="antecedentesEnfermedades" placeholder="Ej: diabetes, artritis" rows="2" style="font-size: 0.85rem;"></textarea>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label class="form-label form-label-sm" style="font-weight: 600; font-size: 0.85rem; color: #495057; margin-bottom: 0.35rem; display: block;">
                                            <i class="bi bi-capsule" style="color: #17a2b8; margin-right: 0.25rem;"></i> Medicamentos Actuales
                                        </label>
                                        <textarea class="form-control form-control-sm" id="antecedenteMedicamentos" placeholder="Ej: ibuprofen 400mg c/8h" rows="2" style="font-size: 0.85rem;"></textarea>
                                    </div>
                                    <div>
                                        <label class="form-label form-label-sm" style="font-weight: 600; font-size: 0.85rem; color: #495057; margin-bottom: 0.35rem; display: block;">
                                            <i class="bi bi-scissors" style="color: #6c757d; margin-right: 0.25rem;"></i> Cirug√≠as Previas
                                        </label>
                                        <textarea class="form-control form-control-sm" id="antecedenteCirugias" placeholder="Ej: esterilizaci√≥n 2023" rows="2" style="font-size: 0.85rem;"></textarea>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid #dee2e6;">
                                    <button type="button" class="btn btn-sm" id="btnCancelarAntecedentesModal" title="Cancelar" style="background: #6c757d; color: white; border: none; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%;" onmouseover="this.style.backgroundColor='#dc3545';" onmouseout="this.style.backgroundColor='#6c757d';">
                                        <i class="bi bi-x-lg"></i> Cancelar
                                    </button>
                                    <button type="button" class="btn btn-sm" id="btnGuardarAntecedentesModal" title="Guardar" style="background: #28a745; color: white; border: none; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%;">
                                        <i class="bi bi-check-lg"></i> Guardar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <hr style="margin: 0.75rem 0; border-top: 1px solid #dee2e6;">

                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-thermometer-half"></i> Temperatura</div>
                            <input type="text" class="form-control" name="temperatura" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-speedometer2"></i> Peso</div>
                            <input type="text" class="form-control" name="peso" id="pesoConsulta" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-heart-pulse"></i> Frec. Card√≠aca</div>
                            <input type="text" class="form-control" name="frecuencia_cardiaca">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-wind"></i> Frec. Respiratoria</div>
                            <input type="text" class="form-control" name="frecuencia_respiratoria">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-droplet-half"></i> Otros</div>
                            <input type="text" class="form-control" name="otros">
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-clipboard2-check"></i> Diagn√≥stico</div>
                            <textarea class="form-control" name="diagnostico" rows="5"></textarea>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-capsule"></i> Tratamiento</div>
                            <div class="tratamiento-container">
                                <textarea class="form-control" name="tratamiento" rows="6" placeholder="Descripci√≥n del tratamiento..."></textarea>
                                
                                <div class="inventario-selector-compact">
                                    <input type="text" class="form-control form-control-sm" id="searchInventario" placeholder="Buscar medicamento...">
                                    <div class="inventario-list-compact" id="inventarioList">
                                        <!-- Lista din√°mica -->
                                    </div>
                                </div>
                                
                                <div class="insumos-utilizados">
                                    <div class="insumos-title">Insumos utilizados:</div>
                                    <div id="insumosSeleccionados">
                                        <!-- Tags din√°micos -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-journal-text"></i> Notas</div>
                            <textarea class="form-control" name="notas" rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-end align-items-center">
                <button type="submit" class="vet-btn vet-btn-primary" id="btnAgendarNuevaCita">
                    <i class="bi bi-check-lg"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Agendar Cita -->
<div id="agendarCitaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-calendar-plus"></i> Agendar Cita</h3>
            <i class="bi bi-x" id="closeAgendarCitaModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formAgendarCita">
            <div class="vet-modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-calendar-event"></i> Fecha</div>
                            <input type="date" class="form-control" name="fecha" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-clock"></i> Hora</div>
                            <input type="time" class="form-control" name="hora" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-list-task"></i> Tipo de Cita</div>
                            <select class="form-control" name="tipo" required>
                                <option value="">Seleccione tipo</option>
                                <option value="hospitalizacion">Hospitalizaci√≥n</option>
                                <option value="consulta">Consulta general</option>
                                <option value="control">Control</option>
                                <option value="vacunacion">Vacunaci√≥n</option>
                            </select>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-journal-text"></i> Notas</div>
                            <textarea class="form-control" name="notas"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-between align-items-center">
                <span></span>
                <button type="submit" class="vet-btn vet-btn-primary">
                    <i class="bi bi-calendar-plus"></i> Agendar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ============================================
     MODALES DE HOSPITALIZACIONES
     ============================================ -->

<!-- Modal Detalles Hospitalizaci√≥n (DOS COLUMNAS) -->
<div id="detallesHospitalizacionModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal modal-compact modal-compact-wide">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-hospital"></i> Detalles de Hospitalizaci√≥n</h3>
            <i class="bi bi-x" onclick="document.getElementById('detallesHospitalizacionModal').classList.remove('show'); document.getElementById('detallesHospitalizacionModal').classList.add('hide');" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <div class="vet-modal-body hosp-detail-body">
            <!-- COLUMNA IZQUIERDA: Informaci√≥n General -->
            <div class="hosp-detail-left">
                <div id="detallesIzquierda">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
            
            <!-- COLUMNA DERECHA: Registros Diarios Scrolleables -->
            <div class="hosp-detail-right">
                <div id="insumosHospitalizacionContainer" class="hosp-compact-spacer"></div>
                <h5 style="margin-top: 0;"><i class="bi bi-calendar-day"></i> Registros Diarios</h5>
                <div id="registrosDiariosContainer">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Hospitalizaci√≥n -->
<div id="nuevaHospitalizacionModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal modal-compact">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-hospital"></i> Nueva Hospitalizaci√≥n</h3>
            <i class="bi bi-x" id="closeHospitalizacionModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formNuevaHospitalizacion">
            <div class="vet-modal-body modal-compact-body">
                <div class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-exclamation-circle"></i> Motivo del Ingreso</div>
                    <textarea class="form-control" name="motivo" required rows="3" placeholder="Ej: Pi√≥metra, Obstrucci√≥n urinaria..."></textarea>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-stethoscope"></i> Diagn√≥stico</div>
                    <textarea class="form-control" name="diagnostico" rows="3" placeholder="Diagn√≥stico preliminar..."></textarea>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-journal-text"></i> Observaciones</div>
                    <textarea class="form-control" name="observaciones" rows="3" placeholder="Observaciones iniciales..."></textarea>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-end align-items-center">
                <button type="submit" class="vet-btn vet-btn-primary">
                    <i class="bi bi-check-lg"></i> Crear Hospitalizaci√≥n
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Cirug√≠a -->
<div id="cirugiaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-tools"></i> Registrar Cirug√≠a</h3>
            <i class="bi bi-x" onclick="document.getElementById('cirugiaModal').classList.remove('show'); document.getElementById('cirugiaModal').classList.add('hide');" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formCirugia">
            <div class="vet-modal-body">
                <div class="row g-4">
                    <!-- Columna izquierda: datos de la cirug√≠a -->
                    <div class="col-md-6">
                        <div class="row g-2">
                            <div class="col-8">
                                <div class="detail-section">
                                    <div class="detail-section-title">Tipo de Cirug√≠a</div>
                                    <select class="form-control" name="servicio_cirugia" id="servicioCirugia" required>
                                        <!-- SIN OPCIONES HARDCODEADAS -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="detail-section">
                                    <div class="detail-section-title">Duraci√≥n (min)</div>
                                    <input type="number" class="form-control" name="duracion_minutos" id="duracionCirugia" readonly placeholder="Auto">
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <div class="detail-section-title">Descripci√≥n (autom√°tica)</div>
                            <textarea class="form-control descripcion-auto" name="descripcion" required rows="2" readonly></textarea>
                        </div>

                        <hr class="section-divider-sm">

                        <div class="detail-section">
                            <div class="detail-section-title">Resultado</div>
                            <select class="form-control" name="resultado">
                                <option value="" selected>Seleccione resultado</option>
                                <option value="problemas">Problemas</option>
                                <option value="exitosa">Exitosa</option>
                                <option value="con_complicaciones">Con complicaciones</option>
                            </select>
                        </div>

                        <div class="detail-section">
                            <div class="detail-section-title">Notas</div>
                            <textarea class="form-control" name="notas" rows="2" placeholder="Notas adicionales sobre la cirug√≠a..."></textarea>
                        </div>

                        <div class="detail-section">
                            <div class="detail-section-title">Complicaciones</div>
                            <textarea class="form-control" name="complicaciones" rows="2" placeholder="Dejar en blanco si no hubo complicaciones"></textarea>
                        </div>

                    </div>

                    <!-- Columna derecha: equipo e insumos -->
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title">Equipo (veterinarios)</div>
                            <input type="text" class="form-control" id="buscarEquipoCirugia" placeholder="Buscar veterinario..." style="margin-bottom:8px;">
                            <div id="equipoCirugia" class="equipo-container"></div>
                            <input type="hidden" name="equipo_cirugia" id="equipoCirugiaHidden">
                            <div id="equipoSeleccionadoCirugia" class="chips-container"></div>
                        </div>

                        <hr class="section-divider">

                        <div class="detail-section">
                            <div class="detail-section-title">Insumos / Implementos</div>
                            <input type="text" class="form-control" id="buscarInsumosCirugia" placeholder="Buscar insumo..." style="margin-bottom:8px;">
                            <div id="insumosCirugia" class="insumos-container"></div>
                            <input type="hidden" name="insumos_cirugia" id="insumosCirugiaHidden">
                            <small class="info-note">Nota: los insumos seleccionados se descuentan del stock.</small>
                            <div id="insumosSeleccionadosCirugia" class="chips-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-end">
                <button type="submit" class="vet-btn vet-btn-primary">
                    <i class="bi bi-save"></i> Guardar Cirug√≠a
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Registro Diario -->
<div id="registroDiarioModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal modal-compact modal-compact-sm">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-calendar-day"></i> Registro Diario</h3>
            <i class="bi bi-x" onclick="document.getElementById('registroDiarioModal').classList.remove('show'); document.getElementById('registroDiarioModal').classList.add('hide');" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formRegistroDiario">
            <div class="vet-modal-body modal-compact-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-thermometer-half"></i> Temperatura</div>
                            <input type="number" class="form-control" name="temperatura" step="0.1" placeholder="¬∞C">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-speedometer2"></i> Peso</div>
                            <input type="number" class="form-control" name="peso" step="0.01" placeholder="kg">
                        </div>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-heart-pulse"></i> Frec. Card√≠aca</div>
                            <input type="number" class="form-control" name="frecuencia_cardiaca" placeholder="lpm">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-wind"></i> Frec. Respiratoria</div>
                            <input type="number" class="form-control" name="frecuencia_respiratoria" placeholder="rpm">
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-journal-text"></i> Observaciones</div>
                    <textarea class="form-control" name="observaciones" rows="3" placeholder="Estado general, comportamiento, etc..."></textarea>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-end">
                <button type="submit" class="vet-btn vet-btn-primary">
                    <i class="bi bi-plus-circle"></i> Guardar Registro
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Alta M√©dica -->
<div id="altaMedicaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-check-circle"></i> Dar de Alta</h3>
            <i class="bi bi-x" onclick="document.getElementById('altaMedicaModal').classList.remove('show'); document.getElementById('altaMedicaModal').classList.add('hide');" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formAltaMedica">
            <div class="vet-modal-body">
                <div class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-stethoscope"></i> Diagn√≥stico Final (opcional)</div>
                    <textarea class="form-control" name="diagnostico_final" rows="3"></textarea>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-capsule"></i> Tratamiento Post-Alta (opcional)</div>
                    <textarea class="form-control" name="tratamiento_post_alta" rows="3"></textarea>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-lightbulb"></i> Recomendaciones (opcional)</div>
                    <textarea class="form-control" name="recomendaciones" rows="3" placeholder="Reposo, dieta, medicamentos en casa, cuidados especiales..."></textarea>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-calendar-check"></i> Pr√≥xima Revisi√≥n (opcional)</div>
                    <input type="date" class="form-control" name="proxima_revision">
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-end">
                <button type="submit" class="vet-btn vet-btn-primary">
                    <i class="bi bi-check-lg"></i> Completar Alta
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- ‚≠ê VARIABLES GLOBALES - DEBE IR PRIMERO ANTES DE OTROS SCRIPTS -->
<script>
// Variables globales para servicios - DEFINIR PRIMERO
window.todosLosServicios = [];
window.serviciosPromise = null;
window.medicamentosSeleccionados = [];
window.serviciosSeleccionadosArray = [];

console.log('‚úÖ Variables globales inicializadas');
</script>

<script src="{% static 'js/pacientes/hospitalizaciones.js' %}"></script>
<script src="{% static 'js/base/modals_base.js' %}"></script>
<script src="{% static 'js/pacientes/editar_ficha.js' %}"></script>
<script src="{% static 'js/pacientes/antecedentes_medicos.js' %}"></script>
<script src="{% static 'js/pacientes/inventario_consulta.js' %}"></script>
<script src="{% static 'js/pacientes/historial_medico.js' %}"></script>

<script>
// Cargar servicios despu√©s de que el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ DOMContentLoaded - Iniciando carga de servicios');
    window.serviciosPromise = cargarServicios();
});

function cargarServicios() {
    return fetch('/clinica/api/servicios/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.servicios) {
                // Filtrar cirug√≠as
                todosLosServicios = data.servicios.filter(servicio => 
                    servicio.categoria !== 'cirugia'
                );
                console.log('‚úÖ Servicios cargados:', todosLosServicios.length);
            }
            return todosLosServicios;
        })
        .catch(error => {
            console.error('Error al cargar servicios:', error);
            return [];
        });
}

// Variables para m√∫ltiples servicios
let serviciosSeleccionadosArray = [];

// Buscador de servicios
const buscarServicio = document.getElementById('buscarServicio');
const resultadosServicio = document.getElementById('resultadosServicio');

// A√±adir estilos
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .resultado-item:hover {
            background-color: #f0f9ff !important;
            border-left: 3px solid #3b82f6 !important;
        }
        .servicio-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #6366f1;
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .servicio-chip .remove-btn {
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0.8;
            margin-left: 2px;
        }
        .servicio-chip .remove-btn:hover {
            opacity: 1;
        }
    `;
    document.head.appendChild(style);
});

if (buscarServicio) {
    buscarServicio.addEventListener('input', function() {
        const termino = this.value.toLowerCase().trim();
        
        if (termino.length === 0) {
            resultadosServicio.style.display = 'none';
            return;
        }
        
        // Filtrar servicios que no est√©n ya seleccionados
        const serviciosFiltrados = todosLosServicios.filter(servicio =>
            !serviciosSeleccionadosArray.some(s => s.id === servicio.idServicio) &&
            (servicio.nombre.toLowerCase().includes(termino) ||
            (servicio.categoria && servicio.categoria.toLowerCase().includes(termino)))
        );
        
        if (serviciosFiltrados.length > 0) {
            resultadosServicio.innerHTML = serviciosFiltrados.map(servicio => `
                <div class="resultado-item" onclick="agregarServicio(${servicio.idServicio}, '${servicio.nombre.replace(/'/g, "\\'")}')"
                     style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #e5e7eb; background-color: white; transition: all 0.2s;">
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 3px;">${servicio.nombre}</div>
                    ${servicio.categoria ? `<small style="color: #6b7280; text-transform: capitalize;">${servicio.categoria.replace('_', ' ')}</small>` : ''}
                </div>
            `).join('');
            resultadosServicio.style.display = 'block';
        } else {
            const mensaje = serviciosSeleccionadosArray.length > 0 && termino.length > 0 
                ? 'Servicio ya agregado o no encontrado'
                : 'No se encontraron servicios';
            resultadosServicio.innerHTML = `<div style="padding: 20px; text-align: center; color: #9ca3af; font-style: italic;">${mensaje}</div>`;
            resultadosServicio.style.display = 'block';
        }
    });
    
    // Cerrar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!buscarServicio.contains(e.target) && !resultadosServicio.contains(e.target)) {
            resultadosServicio.style.display = 'none';
        }
    });
}

function agregarServicio(id, nombre) {
    // Verificar que no est√© ya agregado
    if (serviciosSeleccionadosArray.some(s => s.id === id)) {
        return;
    }
    
    // Agregar al array
    serviciosSeleccionadosArray.push({ id, nombre });
    
    // Actualizar vista
    actualizarServiciosSeleccionados();
    
    // Limpiar buscador
    buscarServicio.value = '';
    resultadosServicio.style.display = 'none';
}

function eliminarServicio(id) {
    serviciosSeleccionadosArray = serviciosSeleccionadosArray.filter(s => s.id !== id);
    actualizarServiciosSeleccionados();
}

function actualizarServiciosSeleccionados() {
    const container = document.getElementById('serviciosSeleccionados');
    const idsInput = document.getElementById('serviciosIds');
    
    if (!container || !idsInput) return;
    
    // Actualizar campo hidden con los IDs
    idsInput.value = serviciosSeleccionadosArray.map(s => s.id).join(',');
    
    // Actualizar chips visuales
    if (serviciosSeleccionadosArray.length === 0) {
        container.innerHTML = '<small style="color: #9ca3af; font-style: italic;">No hay servicios seleccionados</small>';
    } else {
        container.innerHTML = serviciosSeleccionadosArray.map(servicio => `
            <span class="servicio-chip">
                ${servicio.nombre}
                <i class="bi bi-x-circle remove-btn" onclick="eliminarServicio(${servicio.id})"></i>
            </span>
        `).join('');
    }
}

// Funci√≥n para subir documento
function subirDocumento(input, pacienteId) {
    const archivo = input.files[0];
    if (!archivo) return;
    
    // Mostrar indicador de carga
    const lista = document.getElementById('listaDocumentos');
    const cargandoItem = document.createElement('li');
    cargandoItem.className = 'list-group-item text-center';
    cargandoItem.id = 'cargandoDocumento';
    cargandoItem.innerHTML = '<i class="bi bi-hourglass-split"></i> Subiendo documento...';
    
    // Eliminar mensaje de sin documentos si existe
    const mensajeSin = document.getElementById('mensajeSinDocumentos');
    if (mensajeSin) {
        mensajeSin.remove();
    }
    
    lista.appendChild(cargandoItem);
    
    // Crear FormData
    const formData = new FormData();
    formData.append('archivo', archivo);
    formData.append('nombre', archivo.name);
    
    // Obtener el token CSRF
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Enviar archivo
    fetch(`/clinica/pacientes/${pacienteId}/documento/subir/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Eliminar indicador de carga
        cargandoItem.remove();
        
        if (data.success) {
            // Agregar nuevo documento a la lista
            const nuevoItem = document.createElement('li');
            nuevoItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            nuevoItem.setAttribute('data-doc-id', data.documento.id);
            nuevoItem.innerHTML = `
                <div>
                    <strong>${data.documento.nombre}</strong>
                    ${data.documento.descripcion ? '<br><small class="text-muted">' + data.documento.descripcion + '</small>' : ''}
                    <br><small class="text-muted">${data.documento.fecha_subida}</small>
                </div>
                <div style="display: flex; gap: 10px;">
                    <a href="${data.documento.url}" target="_blank" class="vet-link-exam">
                        <i class="bi bi-file-earmark-text"></i> Ver
                    </a>
                    <button class="btn btn-sm btn-danger" onclick="eliminarDocumento(${data.documento.id})" title="Eliminar documento">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            lista.appendChild(nuevoItem);
            
            // Mostrar mensaje de √©xito
            mostrarMensaje('Documento subido correctamente', 'success');
        } else {
            mostrarMensaje(data.message || 'Error al subir documento', 'error');
        }
        
        // Limpiar input
        input.value = '';
    })
    .catch(error => {
        cargandoItem.remove();
        console.error('Error:', error);
        mostrarMensaje('Error al subir documento', 'error');
        input.value = '';
    });
}

// Funci√≥n para eliminar documento
function eliminarDocumento(documentoId) {
    if (!confirm('¬øEst√° seguro de eliminar este documento?')) {
        return;
    }
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/clinica/documento/${documentoId}/eliminar/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Eliminar elemento de la lista
            const item = document.querySelector(`[data-doc-id="${documentoId}"]`);
            if (item) {
                item.remove();
            }
            
            // Si no quedan documentos, mostrar mensaje
            const lista = document.getElementById('listaDocumentos');
            if (lista.children.length === 0) {
                const mensajeSin = document.createElement('li');
                mensajeSin.className = 'list-group-item';
                mensajeSin.id = 'mensajeSinDocumentos';
                mensajeSin.style.cssText = 'text-align: center; padding: 2rem; color: #999;';
                mensajeSin.textContent = 'No hay documentos adjuntos';
                lista.appendChild(mensajeSin);
            }
            
            mostrarMensaje('Documento eliminado correctamente', 'success');
        } else {
            mostrarMensaje(data.message || 'Error al eliminar documento', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al eliminar documento', 'error');
    });
}

// Funci√≥n auxiliar para mostrar mensajes
function mostrarMensaje(mensaje, tipo) {
    const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
    const icono = tipo === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill';
    
    const alerta = document.createElement('div');
    alerta.className = `alert ${alertClass} alert-dismissible fade show`;
    alerta.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alerta.innerHTML = `
        <i class="bi bi-${icono}"></i> ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alerta);
    
    // Auto-cerrar despu√©s de 5 segundos
    setTimeout(() => {
        alerta.remove();
    }, 5000);
}
</script>

{% endblock %}