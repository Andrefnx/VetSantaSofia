{% extends "partials/base_table.html" %}
{% load static %}

{% block title %}Inventario{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/custom/style_inventario.css' %}" type="text/css" media="all">

{% endblock %}

{% block table_title %}
<i class="fas fa-boxes"></i> Inventario
{% endblock %}

{% block table_filters %}

{% endblock %}

{% block table_buttons %}
<button type="button" onclick="abrirModalNuevoProducto()">
    <i class="fas fa-plus-circle"></i> Nuevo Producto
</button>
{% endblock %}

{% block table_columns %}
<th>Producto</th>
<th>Especie</th>
<th>Precio</th>
<th>Stock</th>
<th>√öltimo Movimiento</th>
<th>Tipo</th>
<th>Gesti√≥n</th>
{% endblock %}

{% block table_rows %}
{% for insumo in insumos %}
<tr data-id="{{ insumo.idInventario }}" data-especie="{{ insumo.especie|default_if_none:'' }}"
    data-tipo="{{ insumo.tipo|default_if_none:'' }}" data-stock="ok"
    data-dosis-ml="{{ insumo.dosis_ml|default_if_none:'' }}" data-peso-kg="{{ insumo.peso_kg|default_if_none:'' }}"
    data-ml-contenedor="{{ insumo.ml_contenedor|default_if_none:'' }}">
    <td>{{ insumo.medicamento }}</td>
    <td>{{ insumo.especie }}</td>
    <td>${{ insumo.precio_venta|floatformat:0 }}</td>
    <td><span class="badge stock-ok">{{ insumo.stock_actual }}</span></td>
    <td>{% if insumo.ultimo_movimiento %}{{ insumo.ultimo_movimiento|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
    <td class="tipo-movimiento-cell" data-id="{{ insumo.idInventario }}">
        {# ‚≠ê CAMBIO AQU√ç: Usar get_tipo_ultimo_movimiento_display en lugar de tipo_ultimo_movimiento #}
        {% if insumo.tipo_ultimo_movimiento %}
            {{ insumo.get_tipo_ultimo_movimiento_display }}
        {% else %}
            -
        {% endif %}
    </td>
    <td>
        <div class="manage-wheel">
            <button type="button" onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display: none;">
                <button type="button" onclick="abrirModalProducto(this, 'view')">
                    <i class="fas fa-eye"></i> Ver detalles
                </button>
                <button type="button" onclick="openModificarStockModal(this)">
                    <i class="bi bi-plus-slash-minus"></i>Modificar stock
                </button>
                <button type="button" onclick="abrirModalProducto(this, 'edit')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" onclick="abrirModalEliminarProducto(this)">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="7">No hay productos en inventario.</td>
</tr>
{% endfor %}
{% endblock %}


{% block modals %}

<!-- Modal: Ver/Editar Detalles Producto -->
<div class="vet-modal-overlay hide" id="modalProducto">
    <div class="vet-custom-modal" style="max-width: 900px; width: 100%;">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>
                    <i class="fas fa-box"></i>
                    <span id="modalProductoTitulo">Detalles del Producto</span>
                </h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                    onclick="closeVetModal('modalProducto')"></i>
            </div>
            <div class="vet-modal-body" style="max-height: 70vh; overflow-y: auto;">

                <!-- IDENTIFICACI√ìN GENERAL -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-tag"></i> Identificaci√≥n General</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Nombre Comercial</label>
                            <p class="field-view fw-bold mb-0" data-field="nombre_comercial">-</p>
                            <input class="field-edit form-control d-none" data-field="nombre_comercial">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="text-muted small">SKU</label>
                            <p class="field-view mb-0" data-field="sku">-</p>
                            <input class="field-edit form-control d-none" data-field="sku" placeholder="C√≥digo SKU">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="text-muted small">Tipo</label>
                            <p class="field-view mb-0" data-field="tipo">-</p>
                            <select class="field-edit form-control d-none" data-field="tipo">
                                <option value="">Selecciona...</option>
                                <option value="Vacuna">Vacuna</option>
                                <option value="Desparasitario">Desparasitario</option>
                                <option value="Antibi√≥tico">Antibi√≥tico</option>
                                <option value="Antiinflamatorio">Antiinflamatorio</option>
                                <option value="Analg√©sico">Analg√©sico</option>
                                <option value="Vitaminas">Vitaminas</option>
                                <option value="Suplemento">Suplemento</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="text-muted small">Especie</label>
                            <p class="field-view mb-0" data-field="especie">-</p>
                            <select class="field-edit form-control d-none" data-field="especie">
                                <option value="">Selecciona...</option>
                                <option value="Canino">Canino</option>
                                <option value="Felino">Felino</option>
                                <option value="Todos">Todos</option>
                            </select>
                        </div>
                        
                        <div class="col-md-12">
                            <label class="text-muted small">Descripci√≥n</label>
                            <p class="field-view mb-0" data-field="descripcion">-</p>
                            <textarea class="field-edit form-control d-none" data-field="descripcion"></textarea>
                        </div>
                    </div>
                </div>

                <!-- INFORMACI√ìN COMERCIAL -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-dollar-sign"></i> Informaci√≥n Comercial</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="text-muted small">Precio Venta</label>
                            <p class="field-view fw-bold mb-0" data-field="precio_venta">-</p>
                            <input type="number" min="0" class="field-edit form-control d-none"
                                data-field="precio_venta">
                        </div>
                    </div>
                </div>
                <!-- INVENTARIO -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-boxes"></i> Inventario</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="text-muted small">Stock Actual</label>
                            <p class="field-view fw-bold mb-0" data-field="stock_actual">-</p>
                            <input type="number" min="0" class="field-edit form-control d-none"
                                data-field="stock_actual">
                        </div>
                        
                        <!-- ‚≠ê METADATA EN RECUADRO A LA DERECHA -->
                        <div class="col-md-8">
                            <div class="metadata-box">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="text-muted small">Fecha de Registro</label>
                                        <p class="mb-0 field-readonly" data-field="fecha_creacion_formatted">-</p>
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small">√öltimo Ingreso</label>
                                        <p class="mb-0 field-readonly" data-field="ultimo_ingreso_formatted">-</p>
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small">√öltimo Movimiento</label>
                                        <p class="mb-0 field-readonly" data-field="ultimo_movimiento_formatted">-</p>
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small">Tipo de Movimiento</label>
                                        <p class="mb-0 field-readonly" data-field="tipo_ultimo_movimiento_display">-</p>
                                    </div>
                                    <div class="col-12">
                                        <label class="text-muted small">Modificado por</label>
                                        <p class="mb-0 field-readonly" data-field="usuario_ultimo_movimiento">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title">
                        <i class="fas fa-syringe"></i> Dosis
                    </h6>

                    <div class="row g-3">
                        <!-- VISTA: Dosis Recomendada -->
                        <div class="col-md-6">
                            <label class="text-muted small">Dosis Recomendada</label>
                            <p class="field-view mb-0" data-field="dosis_formula_view">-</p>
                            
                            <!-- ‚≠ê EDICI√ìN: Input de dosis_ml (individual) -->
                            <div class="field-edit d-none">
                                <div class="input-group">
                                    <input type="number" step="any" class="form-control" data-field="dosis_ml" placeholder="Ej: 0.3">
                                    <span class="input-group-text">ml</span>
                                </div>
                            </div>
                        </div>

                        <!-- ‚≠ê EDICI√ìN SOLAMENTE: Peso -->
                        <div class="col-md-6 field-edit d-none">
                            <label class="text-muted small">Cada</label>
                            <div class="input-group">
                                <input type="number" step="any" class="form-control" data-field="peso_kg" placeholder="Ej: 5">
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>

                        <!-- ML en Contenedor -->
                        <div class="col-md-6">
                            <label class="text-muted small">ML en Contenedor</label>
                            <p class="field-view mb-0" data-field="ml_contenedor_view">-</p>
                            
                            <!-- ‚≠ê EDICI√ìN: Input de ml_contenedor (individual) -->
                            <div class="field-edit d-none">
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" data-field="ml_contenedor" placeholder="Ej: 100">
                                    <span class="input-group-text">ml</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRECAUCIONES Y OTROS -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-exclamation-triangle"></i> Precauciones y Otros
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="text-muted small">Precauciones</label>
                            <p class="field-view mb-0" data-field="precauciones">-</p>
                            <textarea class="field-edit form-control d-none" data-field="precauciones"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="text-muted small">Contraindicaciones</label>
                            <p class="field-view mb-0" data-field="contraindicaciones">-</p>
                            <textarea class="field-edit form-control d-none" data-field="contraindicaciones"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="text-muted small">Efectos Adversos</label>
                            <p class="field-view mb-0" data-field="efectos_adversos">-</p>
                            <textarea class="field-edit form-control d-none" data-field="efectos_adversos"></textarea>
                        </div>
                    </div>
                </div>

                <!-- METADATAS DEL √öLTIMO MOVIMIENTO -->
               
            </div>
            <div class="vet-modal-body" style="border-top:1px solid #eee; text-align:right;">
                <button type="button" class="vet-btn-grey" id="btnEditarProducto" onclick="switchToEditModeProducto()">
                    <i class="bi bi-pencil-fill"></i> Editar
                </button>
                <button type="button" class="vet-btn-grey d-none" id="btnGuardarProductoModal"
                    onclick="guardarProductoEditado()">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
                <button type="button" class="vet-btn-grey error" id="btnEliminarProducto"
                    onclick="abrirModalEliminarProducto(this)">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Modificar Stock -->
<div class="vet-modal-overlay hide" id="modalModificarStock">
    <div class="vet-custom-modal" style="max-width: 400px;">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3><i class="fas fa-boxes"></i> Modificar Stock</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                    onclick="closeVetModal('modalModificarStock')"></i>
            </div>
            <div class="vet-modal-body" style="text-align:center;">
                <div style="margin-bottom: 18px;">
                    <span style="font-size: 1.1rem; color: #333;">
                        Stock actual: <span id="stockActualValor" style="font-weight: 600;">0</span>
                    </span>
                </div>
                <p>Ingresa la cantidad de producto a modificar:</p>
                <div style="display: flex; justify-content: center; margin-bottom: 10px;">
                    <input type="number" id="inputStockOperacion" class="form-control" style="width:150px;"
                        placeholder="Cantidad">
                </div>
                <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom: 10px;">
                    <button type="button" class="vet-btn-grey" onclick="sumarStockInput()">
                        <i class="bi bi-plus-circle"></i> Ingresar
                    </button>
                    <button type="button" class="vet-btn-grey" onclick="restarStockInput()">
                        <i class="bi bi-dash-circle"></i> Restar
                    </button>
                </div>
            </div>
            <div class="vet-modal-body" style="text-align:right;">
                <button type="button" class="vet-btn-grey success" id="btnGuardarStockModal" onclick="guardarStock()">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Editar Producto -->
<div class="vet-modal-overlay hide" id="modalEditarProducto">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>Editar Producto</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                    onclick="closeVetModal('modalEditarProducto')"></i>
            </div>
            <div class="vet-modal-body">
                <p>Formulario para editar el producto.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Eliminar Producto -->
<div class="vet-modal-overlay hide" id="modalEliminarProducto">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #b71c1c;">
                <h3><i class="bi bi-trash3-fill"></i> Eliminar Producto</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;" onclick="closeEliminarProductoModal()"></i>

            </div>
            <div class="vet-modal-body">
                <p id="eliminarProductoMensaje">¬øEst√°s seguro que deseas eliminar este producto?</p>
            </div>
            <div class="vet-modal-body" style="text-align:right;">
                <button type="button" class="vet-btn-grey error" id="btnConfirmarEliminarProducto"
                    onclick="eliminarProductoConfirmado()">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/inventario/crud_inventario.js' %}"></script>
<script>
function guardarProducto() {
    const data = {
        nombre_comercial: document.getElementById('nombre_comercial').value,
        sku: document.getElementById('sku').value,
        tipo: document.getElementById('tipo').value,
        descripcion: document.getElementById('descripcion').value,
        especie: document.getElementById('especie').value,
        precio_venta: document.getElementById('precio_venta').value,
        stock_actual: document.getElementById('stock_actual').value,
        dosis_ml: document.getElementById('dosis_ml').value || null,
        peso_kg: document.getElementById('peso_kg').value || null,
        ml_contenedor: document.getElementById('ml_contenedor').value || null,
        precauciones: document.getElementById('precauciones').value,
        contraindicaciones: document.getElementById('contraindicaciones').value,
        efectos_adversos: document.getElementById('efectos_adversos').value
    };

    // ‚≠ê URL CORREGIDA
    const url = currentProductId 
        ? `/inventario/${currentProductId}/editar/`
        : '/inventario/crear/';

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            
            if (result.debug) {
                console.log('üìä Actualizando metadata con:', result.debug);
                
                if (result.debug.tipo_movimiento_display) {
                    const tipoMovElement = document.getElementById('tipo_movimiento');
                    if (tipoMovElement) {
                        tipoMovElement.textContent = result.debug.tipo_movimiento_display;
                        console.log('‚úÖ Tipo movimiento actualizado:', result.debug.tipo_movimiento_display);
                    }
                }
                
                if (result.debug.ultimo_movimiento) {
                    const fechaMovElement = document.getElementById('ultimo_movimiento');
                    if (fechaMovElement) {
                        fechaMovElement.textContent = result.debug.ultimo_movimiento;
                        console.log('‚úÖ Fecha movimiento actualizada:', result.debug.ultimo_movimiento);
                    }
                }
                
                if (result.debug.usuario) {
                    const usuarioElement = document.getElementById('usuario_ultimo_movimiento');
                    if (usuarioElement) {
                        usuarioElement.textContent = result.debug.usuario;
                        console.log('‚úÖ Usuario actualizado:', result.debug.usuario);
                    }
                }

                const modal = document.getElementById('modalProducto');
                const insumoId = modal.dataset.idinventario;
                
                if (insumoId && result.debug.tipo_movimiento_display) {
                    const tableCells = document.querySelectorAll('.tipo-movimiento-cell');
                    tableCells.forEach(cell => {
                        if (cell.dataset.id === insumoId) {
                            cell.textContent = result.debug.tipo_movimiento_display;
                            console.log('‚úÖ Tipo movimiento en tabla actualizado:', result.debug.tipo_movimiento_display);
                        }
                    });
                }
            }
            
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el producto');
    });
}

// Guardar stock r√°pido
function guardarStock() {
    if (!productoIdStock) return;

    // ‚≠ê URL CORREGIDA
    fetch(`/inventario/${productoIdStock}/modificar-stock/`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ stock_actual: stockActualTemp }),
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log('üì¶ Stock actualizado:', result.debug);
            
            if (result.debug) {
                if (result.debug.tipo_movimiento_display) {
                    const tipoMovElement = document.getElementById('tipo_movimiento');
                    if (tipoMovElement) {
                        tipoMovElement.textContent = result.debug.tipo_movimiento_display;
                    }
                }
                
                if (result.debug.ultimo_movimiento) {
                    const fechaMovElement = document.getElementById('ultimo_movimiento');
                    if (fechaMovElement) {
                        fechaMovElement.textContent = result.debug.ultimo_movimiento;
                    }
                }
                
                if (result.debug.usuario) {
                    const usuarioElement = document.getElementById('usuario_ultimo_movimiento');
                    if (usuarioElement) {
                        usuarioElement.textContent = result.debug.usuario;
                    }
                }

                if (result.debug.tipo_movimiento_display) {
                    const tableCells = document.querySelectorAll('.tipo-movimiento-cell');
                    tableCells.forEach(cell => {
                        if (cell.dataset.id === productoIdStock) {
                            cell.textContent = result.debug.tipo_movimiento_display;
                            console.log('‚úÖ Tipo movimiento en tabla actualizado:', result.debug.tipo_movimiento_display);
                        }
                    });
                }
            }
            
            alert(result.message);
            closeVetModal('modalModificarStock');
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar el stock');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}