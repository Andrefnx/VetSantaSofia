{% extends "partials/base_table.html" %}
{% load static %}

{% block title %}Inventario{% endblock %}

{% block table_title %}
<i class="bi bi-box-seam"></i> Inventario
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/custom/style_inventario.css' %}" type="text/css" media="all">
<style>
/* Estilos para botones de acción de stock */
.btn-stock-action {
    width: 40px !important;
    height: 40px !important;
    padding: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 1.2rem !important;
    border-radius: 6px !important;
}

/* Estilos para las pestañas de estado */
.tabs-estado {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
}

.tab-estado {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    transition: all 0.3s ease;
}

.tab-estado:hover {
    color: #0b4d2d;
    background: rgba(105, 192, 135, 0.1);
}

.tab-estado.active {
    color: #0b4d2d;
    border-bottom-color: #69c087;
    background: rgba(105, 192, 135, 0.1);
}

.tab-estado i {
    margin-right: 0.5rem;
}
</style>
{% endblock %}

{% block table_filters %}
{% endblock %}

{% block table_tabs %}
<!-- Pestañas de estado -->
<div class="tabs-estado" style="margin: 1rem 0; padding: 0 1rem;">
    <button type="button" class="tab-estado {% if estado_actual != 'archivados' %}active{% endif %}" 
            onclick="cambiarEstadoProductos('activos')">
        <i class="fas fa-box-open"></i> Activos
    </button>
    <button type="button" class="tab-estado {% if estado_actual == 'archivados' %}active{% endif %}" 
            onclick="cambiarEstadoProductos('archivados')">
        <i class="fas fa-archive"></i> Archivados
    </button>
</div>
{% endblock %}

{% block table_buttons %}
<button type="button" class="vet-btn vet-btn-primary" onclick="abrirModalNuevoProducto()">
    <i class="fas fa-plus"></i> Nuevo Producto
</button>
{% endblock %}

{% block table_columns %}
<th>Producto</th>
<th>Especie</th>
<th>Precio</th>
<th>Stock</th>
<th>Último Movimiento</th>
<th>Tipo</th>
<th>Gestión</th>
{% endblock %}

{% block table_rows %}
{% for insumo in insumos %}
<tr data-id="{{ insumo.idInventario }}" data-especie="{{ insumo.especie|default_if_none:'' }}" 
    style="cursor: pointer;" 
    onclick="if (event.target.closest('.manage-wheel')) return; const btn = this.querySelector('.manage-options button[onclick*=view]'); if(btn) btn.click();">
    <td>{{ insumo.medicamento }}</td>
    <td>{{ insumo.get_especie_display|default:"-" }}</td>
    <td>${{ insumo.precio_venta|default:0|floatformat:0 }}</td>
    <td>
        <span class="vet-badge {% if insumo.get_stock_nivel == 'alto' %}success{% elif insumo.get_stock_nivel == 'medio' %}warning{% else %}danger{% endif %}">
            {{ insumo.stock_actual }}
        </span>
    </td>
    <td>{{ insumo.ultimo_movimiento|date:"d/m/Y H:i"|default:"-" }}</td>
    <td class="tipo-movimiento-cell" data-id="{{ insumo.idInventario }}">
        {% if insumo.tipo_ultimo_movimiento %}
            {{ insumo.get_tipo_ultimo_movimiento_display }}
        {% else %}
            -
        {% endif %}
    </td>
    <td>
        <div class="manage-wheel">
            <button type="button" onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display: none;">
                {% if user.is_staff or user.is_superuser %}
                    <button type="button" onclick="abrirModalProducto(this, 'view')">
                        <i class="bi bi-eye"></i> Ver
                    </button>
                    {% if not insumo.archivado %}
                    <button type="button" onclick="abrirModalProducto(this, 'edit')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button type="button" onclick="openModificarStockModal(this)">
                        <i class="fas fa-boxes"></i> Stock
                    </button>
                    <button type="button" onclick="openConfigNivelesModal(this)">
                        <i class="fas fa-sliders-h"></i> Niveles
                    </button>
                    <button type="button" onclick="abrirModalEliminarProducto(this)">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    <button type="button" onclick="abrirModalArchivarProducto(this, {{ insumo.idInventario }}, false)">
                        <i class="fas fa-archive"></i> Archivar
                    </button>
                    {% else %}
                    <button type="button" onclick="abrirModalArchivarProducto(this, {{ insumo.idInventario }}, true)">
                        <i class="bi bi-arrow-clockwise"></i> Restaurar
                    </button>
                    {% endif %}
                {% elif user.rol in 'administracion,veterinario' %}
                    <button type="button" onclick="abrirModalProducto(this, 'view')">
                        <i class="bi bi-eye"></i> Ver
                    </button>
                    <button type="button" onclick="openModificarStockModal(this)">
                        <i class="fas fa-boxes"></i> Stock
                    </button>
                    <button type="button" onclick="openConfigNivelesModal(this)">
                        <i class="fas fa-sliders-h"></i> Niveles
                    </button>
                {% else %}
                    <button type="button" onclick="abrirModalProducto(this, 'view')">
                        <i class="bi bi-eye"></i> Ver
                    </button>
                {% endif %}
            </div>
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="7" class="text-center">No hay productos registrados</td>
</tr>
{% endfor %}
{% endblock %}

{% block modals %}

<!-- Modal: Ver/Editar Detalles Producto -->
<div class="vet-modal-overlay hide" id="modalProducto">
    <div class="vet-custom-modal" style="max-width: 1000px; width: 100%;">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>
                    <i class="fas fa-box"></i>
                    <span id="modalProductoTitulo">Detalles del Producto</span>
                </h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;" onclick="closeVetModal('modalProducto')"></i>
            </div>
            
            <div class="vet-modal-body" style="max-height: 70vh; overflow-y: auto;">
                
                <!-- ⭐ PESTAÑAS DE NAVEGACIÓN (Detalles / Historial) -->
                <ul class="nav nav-tabs mb-3" id="modalProductoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-detalles" data-bs-toggle="tab" data-bs-target="#content-detalles" type="button" role="tab">
                            <i class="fas fa-info-circle"></i> Detalles
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-historial" data-bs-toggle="tab" data-bs-target="#content-historial" type="button" role="tab" onclick="cargarHistorialModal()">
                            <i class="fas fa-history"></i> Historial
                        </button>
                    </li>
                </ul>

                <!-- CONTENIDO DE LAS PESTAÑAS -->
                <div class="tab-content" id="modalProductoTabsContent">
                    <!-- PESTAÑA: DETALLES -->
                    <div class="tab-pane fade show active" id="content-detalles" role="tabpanel">
                
                <!-- SECCIÓN: IDENTIFICACIÓN GENERAL -->
                <div class="detail-section">
                    <h4 class="detail-section-title">
                        <i class="fas fa-info-circle"></i> Identificación General
                    </h4>
                    <div class="row">
                        <!-- Nombre Comercial -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nombre Comercial</label>
                            <div class="field-view" data-field="nombre_comercial">-</div>
                            <div class="field-edit d-none" data-field="nombre_comercial">
                                <input type="text" class="form-control" data-field="nombre_comercial" placeholder="Ej: Antibiótico Amoxicilina">
                            </div>
                        </div>

                        <!-- ⭐ MARCA (NUEVO) -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Marca</label>
                            <div class="field-view" data-field="marca">-</div>
                            <div class="field-edit d-none" data-field="marca">
                                <input type="text" class="form-control" data-field="marca" placeholder="Ej: Bayer, Zoetis">
                            </div>
                        </div>

                        <!-- SKU -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">SKU</label>
                            <div class="field-view" data-field="sku">-</div>
                            <div class="field-edit d-none" data-field="sku">
                                <input type="text" class="form-control" data-field="sku" placeholder="Código interno">
                            </div>
                        </div>

                        <!-- Especie -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Especie</label>
                            <div class="field-view" data-field="especie">-</div>
                            <div class="field-edit d-none" data-field="especie">
                                <select class="form-select" data-field="especie">
                                    <option value="">Seleccionar...</option>
                                    <option value="canino">Canino</option>
                                    <option value="felino">Felino</option>
                                    <option value="ambos">Ambos</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tipo -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Tipo</label>
                            <div class="field-view" data-field="tipo">-</div>
                            <div class="field-edit d-none" data-field="tipo">
                                <input type="text" class="form-control" data-field="tipo" placeholder="Ej: Antibiótico, Antiparasitario">
                            </div>
                        </div>

                        <!-- ⭐ FORMATO (NUEVO) -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Formato</label>
                            <div class="field-view" data-field="formato">-</div>
                            <div class="field-edit d-none" data-field="formato">
                                <select class="form-select" data-field="formato" id="formatoSelect">
                                    <option value="">Seleccionar...</option>
                                    <option value="liquido">Líquido</option>
                                    <option value="pastilla">Pastilla</option>
                                    <option value="pipeta">Pipeta</option>
                                    <option value="inyectable">Inyectable</option>
                                    <option value="polvo">Polvo</option>
                                    <option value="crema">Crema</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                        </div>

                        <!-- Descripción -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Descripción</label>
                            <div class="field-view" data-field="descripcion">-</div>
                            <div class="field-edit d-none" data-field="descripcion">
                                <textarea class="form-control" data-field="descripcion" rows="2" placeholder="Descripción del producto"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: INFORMACIÓN COMERCIAL -->
                <div class="detail-section">
                    <h4 class="detail-section-title">
                        <i class="fas fa-dollar-sign"></i> Información Comercial
                    </h4>
                    <div class="row">
                        <!-- Precio Venta -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Precio Venta</label>
                            <div class="field-view" data-field="precio_venta">-</div>
                            <div class="field-edit d-none" data-field="precio_venta">
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" data-field="precio_venta" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <!-- Stock Actual -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Stock Actual</label>
                            <div class="field-view" data-field="stock_actual">-</div>
                            <div class="field-edit d-none" data-field="stock_actual">
                                <input type="number" class="form-control" data-field="stock_actual" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ⭐ SECCIÓN: DOSIS (MEJORADA CON FORMATOS) -->
                <div class="detail-section">
                    <h4 class="detail-section-title">
                        <i class="fas fa-prescription-bottle"></i> Dosis
                    </h4>
                    
                    <!-- VISTA: Dosis Formateada -->
                    <div class="row field-view">
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Dosis Recomendada</label>
                            <div class="field-view" data-field="dosis_formula_view">-</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold" id="labelContenidoEnvase">Contenido del Envase</label>
                            <div class="field-view" data-field="ml_contenedor_view">-</div>
                        </div>
                    </div>

                    <!-- EDICIÓN: Campos según formato -->
                    <div class="field-edit d-none">
                        
                        <!-- PARA LÍQUIDOS E INYECTABLES -->
                        <div class="row campo-dosis campo-dosis-liquido d-none">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Dosis por kg (ml/kg)</label>
                                <input type="number" class="form-control" data-field="dosis_ml" step="0.01" placeholder="0.00">
                                <small class="text-muted">Cantidad de ml por cada kg de peso</small>
                            </div>
                            <div class="col-md-4 mb-3 campo-ml-contenedor">
                                <label class="form-label fw-bold">Contenido del envase (ml)</label>
                                <input type="number" class="form-control" data-field="ml_contenedor" step="0.01" placeholder="0.00">
                                <small class="text-muted">ML que trae 1 frasco/ampolla</small>
                            </div>
                        </div>

                        <!-- PARA PASTILLAS -->
                        <div class="row campo-dosis campo-dosis-pastilla d-none">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Dosis por kg (pastillas/kg)</label>
                                <input type="number" class="form-control" data-field="dosis_ml" step="0.01" placeholder="0.00">
                                <small class="text-muted">Cantidad de pastillas por cada kg de peso</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Pastillas por envase</label>
                                <input type="number" class="form-control" data-field="cantidad_pastillas" placeholder="0">
                                <small class="text-muted">Cantidad de pastillas que trae 1 blister/caja</small>
                            </div>
                        </div>

                        <!-- PARA PIPETAS -->
                        <div class="row campo-dosis campo-dosis-pipeta d-none">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Dosis por kg (pipetas/kg)</label>
                                <input type="number" class="form-control" data-field="dosis_ml" step="0.01" placeholder="0.00">
                                <small class="text-muted">Cantidad de pipetas por cada kg de peso</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Unidades por envase</label>
                                <input type="number" class="form-control" data-field="unidades_pipeta" placeholder="0">
                                <small class="text-muted">Cantidad de pipetas que trae 1 caja</small>
                            </div>
                        </div>

                        <!-- PARA POLVO -->
                        <div class="row campo-dosis campo-dosis-polvo d-none">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Dosis por kg (g/kg)</label>
                                <input type="number" class="form-control" data-field="dosis_ml" step="0.01" placeholder="0.00">
                                <small class="text-muted">Cantidad de gramos por cada kg de peso</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Contenido del envase (g)</label>
                                <input type="number" class="form-control" data-field="ml_contenedor" step="0.01" placeholder="0.00">
                                <small class="text-muted">Gramos que trae 1 sobre/frasco</small>
                            </div>
                        </div>

                        <!-- PARA CREMA -->
                        <div class="row campo-dosis campo-dosis-crema d-none">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Dosis por kg (g/kg)</label>
                                <input type="number" class="form-control" data-field="dosis_ml" step="0.01" placeholder="0.00">
                                <small class="text-muted">Cantidad de gramos por cada kg de peso</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Contenido del envase (g)</label>
                                <input type="number" class="form-control" data-field="ml_contenedor" step="0.01" placeholder="0.00">
                                <small class="text-muted">Gramos que trae 1 tubo/pote</small>
                            </div>
                        </div>

                        <!-- PARA OTRO (FORMATO GENÉRICO) -->
                        <div class="row campo-dosis campo-dosis-otro d-none">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Dosis por kg (unidades/kg)</label>
                                <input type="number" class="form-control" data-field="dosis_ml" step="0.01" placeholder="0.00">
                                <small class="text-muted">Cantidad de unidades por cada kg de peso</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Contenido del envase (unidades)</label>
                                <input type="number" class="form-control" data-field="ml_contenedor" step="0.01" placeholder="0.00">
                                <small class="text-muted">Unidades genéricas que trae 1 envase</small>
                            </div>
                        </div>

                        <!-- PESO DE REFERENCIA (COMÚN) -->
                        <div class="row campo-peso-kg">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Peso Referencia (kg)</label>
                                <input type="number" class="form-control" data-field="peso_kg" step="0.01" placeholder="0.00">
                                <small class="text-muted">Peso del animal para la dosis indicada. Ej: si la dosis es 2ml para 10kg, ingrese 10</small>
                            </div>
                        </div>

                        <!-- ⭐ RANGO DE PESO (NUEVO) -->
                        <div class="row campo-rango-peso">
                            <div class="col-md-12 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" data-field="tiene_rango_peso" id="tieneRangoPeso">
                                    <label class="form-check-label fw-bold" for="tieneRangoPeso">
                                        Tiene rango de peso específico
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3 campo-rango-valores d-none">
                                <label class="form-label">Peso Mínimo (kg)</label>
                                <input type="number" class="form-control" data-field="peso_min_kg" step="0.1" placeholder="0.0">
                            </div>
                            <div class="col-md-4 mb-3 campo-rango-valores d-none">
                                <label class="form-label">Peso Máximo (kg)</label>
                                <input type="number" class="form-control" data-field="peso_max_kg" step="0.1" placeholder="0.0">
                            </div>
                        </div>

                    </div>
                </div>

                <!-- SECCIÓN: PRECAUCIONES -->
                <div class="detail-section">
                    <h4 class="detail-section-title">
                        <i class="fas fa-exclamation-triangle"></i> Precauciones y Contraindicaciones
                    </h4>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Precauciones</label>
                            <div class="field-view" data-field="precauciones">-</div>
                            <div class="field-edit d-none" data-field="precauciones">
                                <textarea class="form-control" data-field="precauciones" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Contraindicaciones</label>
                            <div class="field-view" data-field="contraindicaciones">-</div>
                            <div class="field-edit d-none" data-field="contraindicaciones">
                                <textarea class="form-control" data-field="contraindicaciones" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Efectos Adversos</label>
                            <div class="field-view" data-field="efectos_adversos">-</div>
                            <div class="field-edit d-none" data-field="efectos_adversos">
                                <textarea class="form-control" data-field="efectos_adversos" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: INVENTARIO (METADATA - SOLO LECTURA) -->
                <div class="detail-section">
                    <h4 class="detail-section-title">
                        <i class="fas fa-history"></i> Historial de Inventario
                    </h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Fecha de Registro</label>
                            <div class="field-readonly" data-field="fecha_creacion_formatted">-</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Último Ingreso</label>
                            <div class="field-readonly" data-field="ultimo_ingreso_formatted">-</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Último Movimiento</label>
                            <div class="field-readonly" data-field="ultimo_movimiento_formatted">-</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Tipo Movimiento</label>
                            <div class="field-readonly" data-field="tipo_ultimo_movimiento_display">-</div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Modificado por</label>
                            <div class="field-readonly" data-field="usuario_ultimo_movimiento">-</div>
                        </div>
                    </div>
                </div>

                    </div><!-- FIN: content-detalles -->

                    <!-- ⭐ PESTAÑA: HISTORIAL -->
                    <div class="tab-pane fade" id="content-historial" role="tabpanel">
                        <div id="historial-loader" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando historial...</span>
                            </div>
                            <p class="mt-3 text-muted">Cargando historial del producto...</p>
                        </div>
                        <div id="historial-contenido" style="display: none;">
                            <!-- El contenido se carga dinámicamente con AJAX -->
                        </div>
                    </div>

                </div><!-- FIN: tab-content -->

            </div>

            <!-- Footer con botones -->
            <div class="vet-modal-footer">
                <!-- Botón EDITAR: solo visible en modo VER -->
                <button type="button" class="vet-btn vet-btn-grey" id="btnEditarProducto" onclick="switchToEditModeProducto()">
                    <i class="bi bi-pencil-fill"></i> Editar
                </button>
                
                <!-- Botones GUARDAR y CANCELAR: solo visibles en modo EDICIÓN -->
                <button type="button" class="vet-btn vet-btn-grey" id="btnCancelarProducto" onclick="cancelarEdicionProducto()" style="display: none;">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="vet-btn vet-btn-primary" id="btnGuardarProductoModal" onclick="guardarProducto()" style="display: none;">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmar Eliminación -->
<div class="vet-modal-overlay hide" id="modalEliminarProducto">
    <div class="vet-modal-compact">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #b71c1c;">
                <h3><i class="fas fa-trash-alt"></i> Eliminar Producto</h3>
                <i class="bi bi-x" onclick="closeEliminarProductoModal()"></i>
            </div>
            <div class="vet-modal-body">
                <p id="eliminarProductoMensaje" class="text-center mb-4">¿Estás seguro que deseas eliminar este producto?</p>
                <div style="display: flex; justify-content: center; gap: 10px;">
                    <button type="button" class="vet-btn vet-btn-grey" onclick="closeEliminarProductoModal()">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="vet-btn-delete" id="btnConfirmarEliminarProducto" onclick="eliminarProductoConfirmado()">
                        <i class="bi bi-trash3-fill"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Modificar Stock -->
<div class="vet-modal-overlay hide" id="modalModificarStock">
    <div class="vet-modal-compact">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #10b981;">
                <h2 style="color: white; font-size: 1rem; margin: 0;"><i class="fas fa-boxes"></i> Modificar Stock</h2>
                <i class="bi bi-x vet-close-btn" onclick="closeVetModal('modalModificarStock')"></i>
            </div>
            <div class="vet-modal-body">
                <div class="text-center mb-3">
                    <h5 class="mb-2 fw-bold" style="color: #6b7280;">Stock Actual</h5>
                    <h2 id="stockActualValor" class="mb-0 fw-bold" style="color: #6b7280;">0</h2>
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold">Cantidad</label>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="vet-btn vet-btn-primary btn-stock-action" onclick="restarStockInput()" aria-label="Restar">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="form-control" id="inputStockOperacion" placeholder="0" style="text-align: center;">
                        <button type="button" class="vet-btn vet-btn-primary btn-stock-action" onclick="sumarStockInput()" aria-label="Sumar">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="vet-modal-footer">
                    <button type="button" class="vet-btn vet-btn-grey" onclick="closeVetModal('modalModificarStock')">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="vet-btn vet-btn-primary" onclick="guardarStock()">
                        <i class="bi bi-floppy-fill"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Configurar Niveles de Stock -->
<div class="vet-modal-overlay hide" id="modalConfigNiveles">
    <div class="vet-modal-compact">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #0b4d2d;">
                <h2 style="color: white; font-size: 1rem; margin: 0;"><i class="fas fa-sliders-h"></i> Niveles de stock - <span id="productoNombreNiveles"></span></h2>
                <i class="bi bi-x vet-close-btn" onclick="closeVetModal('modalConfigNiveles')"></i>
            </div>
            <div class="vet-modal-body">
                <input type="hidden" id="idProductoNiveles">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i> 
                        Stock Mínimo (Rojo)
                    </label>
                    <input type="number" class="form-control" id="inputStockMinimo" placeholder="Ej: 10" min="0">
                    <small class="text-muted">Cuando el stock llegue a este nivel o menos, se marcará en rojo</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> 
                        Stock Medio (Naranja)
                    </label>
                    <input type="number" class="form-control" id="inputStockMedio" placeholder="Ej: 20" min="0">
                    <small class="text-muted">Cuando el stock esté entre el mínimo y este nivel, se marcará en naranja</small>
                </div>
                
                <div class="mb-3" style="color: #6b7280; font-size: 0.9rem;">
                    <i class="fas fa-info-circle" style="color: #10b981;"></i>
                    <strong>Stock Alto (Verde):</strong>
                    Se marcará automáticamente cuando el stock supere el nivel medio.
                </div>
                <div class="vet-modal-footer">
                    <button type="button" class="vet-btn vet-btn-grey" onclick="closeVetModal('modalConfigNiveles')">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="vet-btn vet-btn-primary" onclick="guardarNivelesStock()">
                        <i class="bi bi-floppy-fill"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Archivar/Restaurar Producto -->
<div class="vet-modal-overlay hide" id="modalArchivarProducto">
    <div class="vet-modal-compact">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #f59e0b;">
                <h2 style="color: white; font-size: 1rem; margin: 0;"><i class="fas fa-archive"></i> <span id="tituloArchivar">Archivar Producto</span></h2>
                <i class="bi bi-x vet-close-btn" onclick="closeArchivarProductoModal()"></i>
            </div>
            <div class="vet-modal-body">
                <p id="archivarProductoMensaje" class="text-center mb-4">¿Estás seguro que deseas archivar este producto? Podrás restaurarlo desde la pestaña de archivados.</p>
                
                <div class="vet-modal-footer">
                    <button type="button" class="vet-btn vet-btn-grey" onclick="closeArchivarProductoModal()">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="vet-btn vet-btn-primary" id="btnConfirmarArchivarProducto">
                        <i class="fas fa-archive"></i> <span id="btnTextoArchivar">Archivar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/inventario/gestion_wheel.js' %}?v=1765912374"></script>
<script src="{% static 'js/inventario/dosis_calculator.js' %}"></script>
<script src="{% static 'js/inventario/crud_inventario.js' %}?v=13"></script>

<style>
/* Estilos para las pestañas del modal de producto */
#modalProductoTabs {
    border-bottom: 2px solid #e0e0e0;
    margin-bottom: 1.5rem;
}

#modalProductoTabs .nav-link {
    color: #757575;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

#modalProductoTabs .nav-link:hover {
    color: #6b8e6b;
    background: rgba(175, 225, 175, 0.1);
}

#modalProductoTabs .nav-link.active {
    color: #6b8e6b;
    border-bottom-color: #afe1af;
    background: rgba(175, 225, 175, 0.1);
}

#modalProductoTabs .nav-link i {
    font-size: 1.1rem;
}

/* Contenido de las pestañas */
#modalProductoTabsContent .tab-pane {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Spinner de carga */
#historial-loader .spinner-border {
    color: #afe1af !important;
}
</style>

<script>
// ⭐ NUEVA FUNCIONALIDAD: Cargar historial dinámicamente con AJAX
let historialCargado = false; // Para evitar múltiples cargas

function cargarHistorialModal() {
    // Si ya se cargó, no hacer nada
    if (historialCargado) {
        return;
    }
    
    // Obtener el ID del producto actual del modal
    const modal = document.getElementById('modalProducto');
    const productoId = modal.getAttribute('data-objeto-id');
    
    if (!productoId) {
        console.error('No se encontró el ID del producto');
        return;
    }
    
    // Mostrar loader
    document.getElementById('historial-loader').style.display = 'block';
    document.getElementById('historial-contenido').style.display = 'none';
    
    // Llamada AJAX al endpoint de historial
    fetch(`/historial/resumen/inventario/${productoId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            // Insertar el HTML en el contenedor
            document.getElementById('historial-contenido').innerHTML = html;
            
            // Ocultar loader y mostrar contenido
            document.getElementById('historial-loader').style.display = 'none';
            document.getElementById('historial-contenido').style.display = 'block';
            
            // Marcar como cargado
            historialCargado = true;
        })
        .catch(error => {
            console.error('Error al cargar historial:', error);
            document.getElementById('historial-loader').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error al cargar historial:</strong> ${error.message}
                    <br><small>Por favor, recarga la página e intenta nuevamente.</small>
                </div>
            `;
        });
}

// ⭐ MODIFICAR LA FUNCIÓN QUE ABRE EL MODAL PARA GUARDAR EL ID
// Buscar la función que abre el modal y añadirle la siguiente línea:
// document.getElementById('modalProducto').setAttribute('data-objeto-id', insumo.idInventario);
// Esto debe hacerse en el archivo crud_inventario.js donde se cargan los datos del modal

// ⭐ RESETEAR EL ESTADO AL CERRAR EL MODAL
const originalCloseVetModal = window.closeVetModal;
window.closeVetModal = function(modalId) {
    if (modalId === 'modalProducto') {
        // Resetear el flag para que se recargue en la próxima apertura
        historialCargado = false;
        
        // Limpiar el contenido del historial
        document.getElementById('historial-contenido').innerHTML = '';
        
        // Volver a la pestaña de detalles
        document.getElementById('tab-detalles').click();
    }
    
    // Llamar a la función original
    originalCloseVetModal(modalId);
};
</script>
{% endblock %}