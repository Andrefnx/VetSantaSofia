{# Hospitalizaciones canonical - Control de visibilidad por rol #}
{# Contexto esperado: mis_hospitalizaciones (lista de hospitalizaciones del usuario/rol) #}

{% load static %}

{# CONTROL DE VISIBILIDAD POR ROL #}

{% if user.rol == 'administracion' or user.is_superuser %}

    <!-- HOSPITALIZACIONES ADMIN: Listado general #}
    <div class="card vet-card card-round">
        <div class="card-header">
            <div class="card-head-row">
                <div class="card-title">
                    <i class="fas fa-hospital-user me-2"></i>
                    Hospitalizaciones Activas
                </div>
                <div class="card-tools">
                    <a href="{% url 'hospital:hospitalizaciones' %}" class="vet-btn vet-btn-sm">
                        <i class="fa fa-list me-1"></i>
                        Ver Todas
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if mis_hospitalizaciones %}
                <div class="vd-hospitalizaciones-list">
                    {% for hosp in mis_hospitalizaciones|slice:":10" %}
                    <div class="vd-hosp-card mb-3 p-3 border rounded" style="border-left: 4px solid #667eea;">
                        <div class="vd-hosp-header d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <strong>{{ hosp.paciente.nombre }}</strong>
                                    <span class="badge badge-secondary ms-2">{{ hosp.dias_hospitalizacion }} días</span>
                                </h6>
                                <small class="text-muted">
                                    <strong>Veterinario:</strong> {{ hosp.veterinario.nombre }} {{ hosp.veterinario.apellido|default:'' }}<br>
                                    <strong>Ingreso:</strong> {{ hosp.fecha_ingreso|date:"d/m/Y H:i" }}
                                </small>
                            </div>
                            <button type="button" class="btn btn-sm btn-link" onclick="toggleHospitalization(this)" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>

                        <div class="vd-hosp-body" style="display:none;">
                            <hr class="my-2">
                            <div class="mb-2">
                                <h6 class="text-muted mb-1">Paciente</h6>
                                <p class="mb-0">
                                    <strong>{{ hosp.paciente.nombre }}</strong> 
                                    ({{ hosp.paciente.get_especie_display }})
                                    <br><small>Propietario: {{ hosp.paciente.propietario.nombre_completo }}</small>
                                </p>
                            </div>

                            <div class="mb-2">
                                <h6 class="text-muted mb-1">Diagnóstico</h6>
                                <p class="mb-0">{{ hosp.diagnostico|default:"No registrado" }}</p>
                            </div>

                            <div class="mt-2 pt-2 border-top">
                                <a href="{% url 'hospital:detalle' hosp.id %}" class="vet-btn vet-btn-sm">
                                    <i class="fas fa-edit me-1"></i>
                                    Ver Detalles
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% if mis_hospitalizaciones|length > 10 %}
                        <a href="{% url 'hospital:hospitalizaciones' %}" class="vet-btn vet-btn-block">
                            Ver las {{ mis_hospitalizaciones|length }} hospitalizaciones
                        </a>
                    {% endif %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay hospitalizaciones activas</p>
                </div>
            {% endif %}
        </div>
    </div>

{% elif user.rol == 'veterinario' %}

    <!-- HOSPITALIZACIONES VETERINARIO: A su cargo -->
    <div class="card vet-card card-round">
        <div class="card-header">
            <div class="card-head-row">
                <div class="card-title">
                    <i class="fas fa-hospital-user me-2"></i>
                    Mis Hospitalizaciones
                </div>
                <div class="card-tools">
                    <a href="{% url 'hospital:hospitalizaciones' %}" class="vet-btn vet-btn-sm">
                        <i class="fa fa-list me-1"></i>
                        Ver Todas
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {# Cards expandibles para ver detalle completo (versión veterinario con toda la información clínica) #}
            {% if mis_hospitalizaciones %}
                <div class="vd-hospitalizaciones-list">
                    {% for hosp in mis_hospitalizaciones %}
                    <div class="vd-hosp-card mb-3 p-3 border rounded" style="border-left: 4px solid #667eea;">
                        {# Header: Información de ingreso #}
                        <div class="vd-hosp-header d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <strong>{{ hosp.paciente.nombre }}</strong>
                                    <span class="badge badge-secondary ms-2">{{ hosp.dias_hospitalizacion }} días</span>
                                </h6>
                                <small class="text-muted">
                                    Ingreso: {{ hosp.fecha_ingreso|date:"d/m/Y H:i" }}
                                </small>
                            </div>
                            <button type="button" class="btn btn-sm btn-link" onclick="toggleHospitalization(this)" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>

                        {# Body: Detalles del paciente (colapsable) #}
                        <div class="vd-hosp-body" style="display:none;">
                            <hr class="my-2">
                            <div class="mb-2">
                                <h6 class="text-muted mb-1">Paciente</h6>
                                <p class="mb-0">
                                    <strong>{{ hosp.paciente.nombre }}</strong> 
                                    ({{ hosp.paciente.get_especie_display }})
                                    <br><small>Propietario: {{ hosp.paciente.propietario.nombre_completo }}</small>
                                </p>
                            </div>

                            {% if hosp.diagnostico %}
                            <div class="mb-2">
                                <h6 class="text-muted mb-1">Diagnóstico</h6>
                                <p class="mb-0">{{ hosp.diagnostico }}</p>
                            </div>
                            {% endif %}

                            {% if hosp.tratamiento %}
                            <div class="mb-2">
                                <h6 class="text-muted mb-1">Tratamiento</h6>
                                <p class="mb-0">{{ hosp.tratamiento }}</p>
                            </div>
                            {% endif %}

                            {# Vitales: Temperatura, Pulso, Frecuencia Respiratoria #}
                            {% if hosp.temperatura or hosp.pulso or hosp.frecuencia_respiratoria %}
                            <div class="vd-hosp-vitales mt-2 p-2 bg-light rounded">
                                <h6 class="text-muted mb-2">Vitales</h6>
                                <div class="row">
                                    {% if hosp.temperatura %}
                                    <div class="col-md-4">
                                        <small class="text-muted">Temperatura</small>
                                        <p class="mb-0"><strong>{{ hosp.temperatura }}°C</strong></p>
                                    </div>
                                    {% endif %}
                                    {% if hosp.pulso %}
                                    <div class="col-md-4">
                                        <small class="text-muted">Pulso</small>
                                        <p class="mb-0"><strong>{{ hosp.pulso }} lpm</strong></p>
                                    </div>
                                    {% endif %}
                                    {% if hosp.frecuencia_respiratoria %}
                                    <div class="col-md-4">
                                        <small class="text-muted">Respiración</small>
                                        <p class="mb-0"><strong>{{ hosp.frecuencia_respiratoria }} rpm</strong></p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            {# Advertencia si no se actualiza #}
                            {% if hosp.dias_sin_actualizar > 0 %}
                            <div class="alert alert-warning alert-sm mt-2 mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Última actualización hace {{ hosp.dias_sin_actualizar }} día{{ hosp.dias_sin_actualizar|pluralize }}
                            </div>
                            {% endif %}

                            <div class="mt-2 pt-2 border-top">
                                <a href="{% url 'hospital:detalle' hosp.id %}" class="vet-btn vet-btn-sm">
                                    <i class="fas fa-edit me-1"></i>
                                    Actualizar
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No tienes pacientes hospitalizados</p>
                </div>
            {% endif %}
        </div>
    </div>

{% elif user.rol == 'recepcion' %}

    <!-- HOSPITALIZACIONES RECEPCIÓN: Solo estado (sin acciones clínicas) -->
    <div class="card vet-card card-round">
        <div class="card-header">
            <div class="card-head-row">
                <div class="card-title">
                    <i class="fas fa-hospital-user me-2"></i>
                    Pacientes Hospitalizados
                </div>
                <div class="card-tools">
                    <a href="{% url 'hospital:hospitalizaciones' %}" class="vet-btn vet-btn-sm">
                        <i class="fa fa-list me-1"></i>
                        Ver Todos
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if mis_hospitalizaciones %}
                <div class="list-group list-group-flush">
                    {% for hosp in mis_hospitalizaciones %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <strong>{{ hosp.paciente.nombre }}</strong>
                                    <span class="badge badge-info ms-2">{{ hosp.dias_hospitalizacion }}d</span>
                                </h6>
                                <small class="text-muted d-block">
                                    <strong>Propietario:</strong> {{ hosp.paciente.propietario.nombre_completo }}
                                </small>
                                <small class="text-muted d-block">
                                    <strong>Veterinario:</strong> {{ hosp.veterinario.nombre|default:"" }}
                                </small>
                                <small class="text-muted d-block">
                                    <strong>Ingreso:</strong> {{ hosp.fecha_ingreso|date:"d/m/Y" }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay pacientes hospitalizados en este momento</p>
                </div>
            {% endif %}
        </div>
    </div>

{% endif %}

<script>
    function toggleHospitalization(button) {
        const card = button.closest('.vd-hosp-card');
        const body = card.querySelector('.vd-hosp-body');
        const isVisible = body.style.display !== 'none';
        
        body.style.display = isVisible ? 'none' : 'block';
        button.style.opacity = isVisible ? '0.5' : '1';
    }
</script>
