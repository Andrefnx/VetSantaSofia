{# Agenda canonical - Versión única con control de visibilidad por rol #}
{# Contexto esperado: mis_citas (lista de citas del usuario/rol) #}

{% load static %}

{# CONTROL DE VISIBILIDAD POR ROL #}
{% if user.rol == 'administracion' or user.is_superuser %}
    
    <!-- AGENDA ADMIN: Solo resumen (conteos y próximas citas) -->
    <div class="card vet-card card-round">
        <div class="card-header">
            <div class="card-head-row">
                <div class="card-title">
                    <i class="fas fa-calendar-day me-2"></i>
                    Resumen Agenda - {{ hoy|date:"l, d F Y" }}
                </div>
                <div class="card-tools">
                    <a href="{% url 'agenda:agenda' %}" class="vet-btn vet-btn-sm">
                        <i class="fa fa-calendar me-1"></i>
                        Ver Agenda Completa
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {# Resumen de conteos #}
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6 class="text-muted">Total de Citas</h6>
                    <h5>{{ mis_citas|length }}</h5>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted">Pendientes/Confirmadas</h6>
                    <h5>
                        {% with pendientes=mis_citas|dictsort:"estado"|length %}
                            {% if pendientes %}{{ pendientes }}{% else %}0{% endif %}
                        {% endwith %}
                    </h5>
                </div>
            </div>
            
            {# Próximas citas (máximo 5) #}
            {% if mis_citas %}
                <hr>
                <h6 class="mb-3">Próximas Citas</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Paciente</th>
                                <th>Veterinario</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in mis_citas|slice:":5" %}
                            <tr>
                                <td><strong>{{ cita.hora_inicio|time:"H:i" }}</strong></td>
                                <td>{{ cita.paciente.nombre }}</td>
                                <td>{{ cita.veterinario.nombre|default:"N/A" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay citas programadas para hoy</p>
                </div>
            {% endif %}
        </div>
    </div>

{% elif user.rol == 'veterinario' %}

    <!-- AGENDA VETERINARIO: Agenda completa (detalle por hora) -->
    <div class="card vet-card card-round">
        <div class="card-header">
            <div class="card-head-row">
                <div class="card-title">
                    <i class="fas fa-calendar-day me-2"></i>
                    Mi Agenda - {{ hoy|date:"l, d F Y" }}
                </div>
                <div class="card-tools">
                    <a href="{% url 'agenda:agenda' %}" class="vet-btn vet-btn-sm">
                        <i class="fa fa-calendar me-1"></i>
                        Ver Agenda Completa
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {# Tabla canonical de citas (versión completa) #}
            {% if mis_citas %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Hora Inicio</th>
                                <th>Hora Fin</th>
                                <th>Paciente</th>
                                <th>Dueño</th>
                                <th>Teléfono</th>
                                <th>Correo</th>
                                <th>Veterinario</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th class="text-end">Ver Ficha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in mis_citas %}
                            <tr class="{% if cita.estado == 'en_curso' %}table-warning{% elif cita.estado == 'completada' %}table-success{% endif %}">
                                <td><strong>{{ cita.hora_inicio|time:"H:i" }}</strong></td>
                                <td>{{ cita.hora_fin|time:"H:i"|default:"—" }}</td>
                                <td>
                                    <strong>{{ cita.paciente.nombre }}</strong><br>
                                    <small class="text-muted">{{ cita.paciente.get_especie_display }}</small>
                                </td>
                                <td>{{ cita.paciente.propietario.nombre_completo }}</td>
                                <td>{{ cita.paciente.propietario.telefono|default:"—" }}</td>
                                <td>{{ cita.paciente.propietario.correo|default:"—" }}</td>
                                <td>{{ cita.veterinario.nombre }} {{ cita.veterinario.apellido|default:"" }}</td>
                                <td>
                                    <span class="badge badge-secondary">
                                        {% if cita.servicio %}{{ cita.servicio.nombre }}{% else %}{{ cita.get_tipo_display }}{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-{% if cita.estado == 'completada' %}success{% elif cita.estado == 'en_curso' %}warning{% elif cita.estado == 'confirmada' %}info{% elif cita.estado == 'cancelada' %}danger{% else %}secondary{% endif %}">
                                        {{ cita.get_estado_display }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'pacientes:ficha_mascota' cita.paciente.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-file-medical"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No tienes citas programadas para hoy</p>
                </div>
            {% endif %}
        </div>
    </div>

{% elif user.rol == 'recepcion' %}

    <!-- AGENDA RECEPCIÓN: Agenda completa con acciones de agendamiento -->
    <div class="card vet-card card-round">
        <div class="card-header">
            <div class="card-head-row">
                <div class="card-title">
                    <i class="fas fa-calendar-day me-2"></i>
                    Agenda del Día - {{ hoy|date:"l, d F Y" }}
                </div>
                <div class="card-tools">
                    <a href="{% url 'agenda:crear_cita' %}" class="vet-btn vet-btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-calendar-plus me-1"></i>
                        Nueva Cita
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {# Tabla canonical con opciones de recepción #}
            {% if mis_citas %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Hora Inicio</th>
                                <th>Hora Fin</th>
                                <th>Paciente</th>
                                <th>Dueño</th>
                                <th>Teléfono</th>
                                <th>Correo</th>
                                <th>Veterinario</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th class="text-end">Ver Ficha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in mis_citas %}
                            <tr class="{% if cita.estado == 'en_curso' %}table-warning{% elif cita.estado == 'completada' %}table-success{% endif %}">
                                <td><strong>{{ cita.hora_inicio|time:"H:i" }}</strong></td>
                                <td>{{ cita.hora_fin|time:"H:i"|default:"—" }}</td>
                                <td>
                                    <strong>{{ cita.paciente.nombre }}</strong><br>
                                    <small class="text-muted">{{ cita.paciente.get_especie_display }}</small>
                                </td>
                                <td>{{ cita.paciente.propietario.nombre_completo }}</td>
                                <td>{{ cita.paciente.propietario.telefono|default:"—" }}</td>
                                <td>{{ cita.paciente.propietario.correo|default:"—" }}</td>
                                <td>{{ cita.veterinario.nombre }} {{ cita.veterinario.apellido|default:"" }}</td>
                                <td>
                                    <span class="badge badge-secondary">
                                        {% if cita.servicio %}{{ cita.servicio.nombre }}{% else %}{{ cita.get_tipo_display }}{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-{% if cita.estado == 'completada' %}success{% elif cita.estado == 'en_curso' %}warning{% elif cita.estado == 'confirmada' %}info{% elif cita.estado == 'cancelada' %}danger{% else %}secondary{% endif %}">
                                        {{ cita.get_estado_display }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'pacientes:ficha_mascota' cita.paciente.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-file-medical"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No hay citas programadas para hoy</p>
                </div>
            {% endif %}
        </div>
    </div>

{% endif %}
