{% extends "partials/base_table.html" %}
{% load static %}
{% load duracion_filters %}

{% block title %}Servicios Veterinarios{% endblock %}

{% block extra_css %}
{% endblock %}

{% block table_title %}
<i class="fas fa-stethoscope"></i> Servicios Veterinarios
{% endblock %}

{% block table_buttons %}
<button type="button" onclick="abrirModalNuevoServicio()">
    <i class="fas fa-plus-circle"></i> Nuevo Servicio
</button>
{% endblock %}

{% block table_columns %}
<th>Servicio</th>
<th>Categoría</th>
<th>Precio</th>
<th>Duración</th>
<th>Gestión</th>
{% endblock %}

{% block table_rows %}
{% for servicio in servicios %}
<tr data-id="{{ servicio.idServicio }}" 
    data-categoria="{{ servicio.categoria }}"
    data-insumos="{{ servicio.servicioinsumo_set.all|length }}">
    <td>{{ servicio.nombre }}</td>
    <td>{{ servicio.categoria }}</td>
    <td>${{ servicio.precio|floatformat:0 }}</td>
    <td>{{ servicio.duracion|formato_duracion }}</td>
    <td>
        <div class="manage-wheel">
            <button type="button" onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display: none;">
                <button type="button" onclick="abrirModalServicio(this, 'view')">
                    <i class="fas fa-eye"></i> Ver detalles
                </button>
                <button type="button" onclick="abrirModalServicio(this, 'edit')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" onclick="abrirModalEliminarServicio(this)">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="5">No hay servicios registrados.</td>
</tr>
{% endfor %}
{% endblock %}

{% block modals %}


<!-- ===========================
   MODAL SERVICIO
============================= -->
<div class="vet-modal-overlay hide" id="modalServicio">
    <div class="vet-custom-modal" style="max-width: 900px; width: 100%;">
        <div class="vet-modal-content">

            <div class="vet-custom-modal-title">
                <h3>
                    <i class="fas fa-stethoscope"></i>
                    <span id="modalServicioTitulo">Detalles del Servicio</span>
                </h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                   onclick="closeVetModal('modalServicio')"></i>
            </div>

            <div class="vet-modal-body" style="max-height: 70vh; overflow-y: auto;">


                <!-- ===========================
                     IDENTIFICACIÓN GENERAL
                ================================ -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title">
                        <i class="fas fa-tag"></i> Identificación General
                    </h6>
                    <div class="row g-3">

                        <div class="col-md-6">
                            <label class="text-muted small">Nombre del Servicio</label>
                            <p class="field-view fw-bold mb-0" data-field="nombre">-</p>
                            <input class="field-edit form-control d-none" data-field="nombre">
                        </div>

                        <div class="col-md-6">
                            <label class="text-muted small">Categoría</label>
                            <p class="field-view mb-0" data-field="categoria">-</p>
                            <select class="field-edit form-control d-none" data-field="categoria">
                                <option value="">Selecciona...</option>
                                <option value="Consulta general">Consulta general</option>
                                <option value="Vacunación">Vacunación</option>
                                <option value="Cirugía">Cirugía</option>
                                <option value="Control">Control</option>
                                <option value="Urgencia">Urgencia</option>
                                <option value="Procedimiento diagnóstico">Procedimiento diagnóstico</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label class="text-muted small">Descripción</label>
                            <p class="field-view mb-0" data-field="descripcion">-</p>
                            <textarea class="field-edit form-control d-none" data-field="descripcion"></textarea>
                        </div>

                    </div>
                </div>


                <!-- ===========================
                     INFORMACIÓN COMERCIAL
                ================================ -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title">
                        <i class="fas fa-dollar-sign"></i> Información Comercial
                    </h6>
                    <div class="row g-3">

                        <div class="col-md-4">
                            <label class="text-muted small">Precio</label>
                            <p class="field-view fw-bold mb-0" data-field="precio">-</p>
                            <input type="number" min="0" class="field-edit form-control d-none"
                                   data-field="precio">
                        </div>

                        <div class="col-md-4">
                            <label class="text-muted small">Duración</label>
                            <div class="field-view mb-0" data-field="duracion">-</div>

                            <div class="input-group field-edit d-none">
                                <input type="number" min="0" class="form-control field-edit"
                                       data-field="duracion"
                                       placeholder="Ej: 30">
                                <span class="input-group-text">min</span>
                            </div>
                        </div>

                    </div>
                </div>


                <!-- ===========================
                     INSUMOS ASOCIADOS
                ================================ -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title">
                        <i class="fas fa-boxes"></i> Insumos Asociados al Servicio
                    </h6>

                    <!-- Vista -->
                    <div class="field-view" data-field="insumos_list">
                        <ul id="insumosVistaLista" class="mb-0">
                            <!-- JS inserta aquí -->
                        </ul>
                    </div>

                    <!-- Edición -->
                    <div class="field-edit d-none">

                        <div style="display:flex; gap:8px; margin-bottom:10px;">
                            <select id="selectInsumoServicio" class="form-control">
                                <option value="">Agregar Insumo...</option>
                                {% for insumo in insumos %}
                                    <option value="{{ insumo.idInventario }}">{{ insumo.medicamento }}</option>
                                {% endfor %}
                            </select>
                            <button class="vet-btn-grey" type="button" onclick="agregarInsumoAServicio()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <table class="table table-sm" id="tablaInsumosServicio">
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th style="width:90px;">Cant.</th>
                                    <th style="width:40px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS agrega filas -->
                            </tbody>
                        </table>

                    </div>
                </div>



            </div>

            <div class="vet-modal-body" style="border-top:1px solid #eee; text-align:right;">
                <button type="button" class="vet-btn-grey" id="btnEditarServicio"
                        onclick="switchToEditModeServicio()">
                    <i class="bi bi-pencil-fill"></i> Editar
                </button>

                <button type="button" class="vet-btn-grey d-none" id="btnGuardarServicio"
                        onclick="guardarServicioEditado()">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>

                <button type="button" class="vet-btn-grey error" id="btnEliminarServicio"
                        onclick="abrirModalEliminarServicio(this)">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
            </div>

        </div>
    </div>
</div>



<!-- ===========================
     Modal Eliminar Servicio
=============================== -->
<div class="vet-modal-overlay hide" id="modalEliminarServicio">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">

            <div class="vet-custom-modal-title" style="background: #b71c1c;">
                <h3><i class="bi bi-trash3-fill"></i> Eliminar Servicio</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                   onclick="closeEliminarServicioModal()"></i>
            </div>

            <div class="vet-modal-body">
                <p id="eliminarServicioMensaje">¿Estás seguro que deseas eliminar este servicio?</p>
            </div>

            <div class="vet-modal-body" style="text-align:right;">
                <button type="button" class="vet-btn-grey error" id="btnConfirmarEliminarServicio">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
            </div>

        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="{% static 'js/servicios/crud_servicios.js' %}"></script>
{% endblock %}
