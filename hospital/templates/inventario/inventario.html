{% extends "partials/base_table.html" %}
{% load static %}

{% block title %}Inventario{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/style_inventario.css' %}" type="text/css" media="all">

{% endblock %}

{% block table_title %}
<i class="fas fa-boxes"></i> Inventario
{% endblock %}

{% block table_filters %}
<div class="filter-group vet-inventory">
    <!-- Filtro Especie -->
    <div class="vet-custom-select-wrapper">
        <span class="tag_select">Especie</span>
        <div class="vet-custom-select">
            <span class="vet-selected-value placeholder">Todas</span>
            <div class="vet-arrow"></div>
        </div>
        <ul class="vet-custom-select-dropdown">
            <li data-value="">Todas</li>
            <li data-value="canino">Canino</li>
            <li data-value="felino">Felino</li>
        </ul>
        <input type="hidden" id="filterEspecie" value="">
    </div>

    <!-- Filtro Stock -->
    <div class="vet-custom-select-wrapper">
        <span class="tag_select">Stock</span>
        <div class="vet-custom-select">
            <span class="vet-selected-value placeholder">Todos</span>
            <div class="vet-arrow"></div>
        </div>
        <ul class="vet-custom-select-dropdown">
            <li data-value="">Todos</li>
            <li data-value="low">Bajo</li>
            <li data-value="ok">Normal</li>
            <li data-value="high">Alto</li>
        </ul>
        <input type="hidden" id="filterStock" value="">
    </div>

    <!-- Filtro Proveedor -->
    <div class="vet-custom-select-wrapper">
        <span class="tag_select">Proveedor</span>
        <div class="vet-custom-select">
            <span class="vet-selected-value placeholder">Todos</span>
            <div class="vet-arrow"></div>
        </div>
        <ul class="vet-custom-select-dropdown">
            <li data-value="">Todos</li>
            <li data-value="vet pharma">Vet Pharma</li>
            <li data-value="pet supplies">Pet Supplies</li>
        </ul>
        <input type="hidden" id="filterProveedor" value="">
    </div>
</div>
{% endblock %}

{% block table_buttons %}
<button type="button" onclick="abrirModalNuevoProducto()">
    <i class="fas fa-plus-circle"></i> Nuevo Producto
</button>
{% endblock %}

{% block table_columns %}
<th>Producto</th>
<th>Especie</th>
<th>Precio</th>
<th>Stock</th>
<th>Último Ingreso</th>
<th>Último Salida</th>
<th>Proveedor</th>
<th>Gestión</th>
{% endblock %}

{% block table_rows %}
<tr data-especie="felino" data-stock="ok" data-proveedor="vet pharma">
    <td>Revolution Plus</td>
    <td>Felino</td>
    <td>$32.500</td>
    <td><span class="badge stock-ok">10</span></td>
    <td>15/03/2026</td>
    <td>03/11/2025</td>
    <td>Vet Pharma</td>
    <td>
        <div class="manage-wheel">
            <button type="button" onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display: none;">
                <button type="button" onclick="abrirModalProducto(this, 'view')">
                    <i class="fas fa-eye"></i> Ver detalles
                </button>
                <button type="button" onclick="openModificarStockModal(this.closest('tr').querySelector('[data-field=stock_actual]') 
    ? parseInt(this.closest('tr').querySelector('[data-field=stock_actual]').textContent.replace(/\D/g, '')) 
    : parseInt(this.closest('tr').cells[3].textContent.replace(/\D/g, '')) )">
                    <i class="bi bi-plus-slash-minus"></i>Modificar stock
                </button>
                <button type="button" onclick="abrirModalProducto(this, 'edit')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" onclick="abrirModalEliminarProducto(this)">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>

    </td>
</tr>
<tr data-especie="canino" data-stock="low" data-proveedor="pet supplies">
    <td>Bravecto 40-56Kg</td>
    <td>Canino</td>
    <td>$28.000</td>
    <td><span class="badge stock-low">3</span></td>
    <td>02/02/2025</td>
    <td>15/10/2025</td>
    <td>Pet Supplies</td>
    <td>
        <div class="manage-wheel">
            <button onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display: none;">

                <button type="button" onclick="abrirModalProducto(this, 'view')">
                    <i class="fas fa-eye"></i> Ver detalles
                </button>
                <button type="button" onclick="openModificarStockModal(this.closest('tr').querySelector('[data-field=stock_actual]') 
    ? parseInt(this.closest('tr').querySelector('[data-field=stock_actual]').textContent.replace(/\D/g, '')) 
    : parseInt(this.closest('tr').cells[3].textContent.replace(/\D/g, '')) )">
                    <i class="bi bi-plus-slash-minus"></i>Modificar stock
                </button>
                <button type="button" onclick="abrirModalProducto(this, 'edit')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" onclick="abrirModalEliminarProducto(this)">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </td>
</tr>
{% endblock %}


{% block modals %}

<!-- Modal: Nuevo Producto -->
<div class="vet-modal-overlay hide" id="modalNuevoProducto">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>Nuevo Producto</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                    onclick="closeVetModal('modalNuevoProducto')"></i>
            </div>
            <div class="vet-modal-body">
                <p>Formulario para agregar un nuevo producto.</p>
            </div>
        </div>
    </div>
</div>


<!-- Modal: Ver/Editar Detalles Producto -->
<div class="vet-modal-overlay hide" id="modalProducto">
    <div class="vet-custom-modal" style="max-width: 900px; width: 100%;">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>
                    <i class="fas fa-box"></i>
                    <span id="modalProductoTitulo">Detalles del Producto</span>
                </h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                    onclick="closeVetModal('modalProducto')"></i>
            </div>
            <div class="vet-modal-body" style="max-height: 70vh; overflow-y: auto;">

                <!-- IDENTIFICACIÓN GENERAL -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-tag"></i> Identificación General</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Nombre Comercial</label>
                            <p class="field-view fw-bold mb-0" data-field="nombre_comercial">-</p>
                            <input class="field-edit form-control d-none" data-field="nombre_comercial">
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Descripción</label>
                            <p class="field-view mb-0" data-field="descripcion">-</p>
                            <textarea class="field-edit form-control d-none" data-field="descripcion"></textarea>
                        </div>
                    </div>
                </div>
                <!-- PESO ANIMAL Y DOSIS -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-weight"></i> Peso Animal y Dosis</h6>
                    <div class="row g-3">

                        <!-- Vista -->
                        <div class="col-md-12">

                            <div id="pesoDosisList" class="field-view">-</div>
                        </div>

                        <!-- Edición -->
                        <div class="col-md-12 field-edit d-none" id="pesoDosisEdit">

                            <!-- Campos para agregar un rango -->
                            <div class="row g-2 align-items-end mb-2">
                                <div class="col-md-3">
                                    <label>Peso Mínimo (kg)</label>
                                    <input type="number" step="0.1" class="form-control" id="pesoMinTemp">
                                </div>
                                <div class="col-md-3">
                                    <label>Peso Máximo (kg)</label>
                                    <input type="number" step="0.1" class="form-control" id="pesoMaxTemp">
                                </div>
                                <div class="col-md-3">
                                    <label>Dosis (ml)</label>
                                    <input type="number" step="0.1" class="form-control" id="dosisTemp">
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-success w-100" onclick="agregarRangoDosis()">
                                        <i class="bi bi-plus-lg"></i> Agregar
                                    </button>
                                </div>
                            </div>

                            <!-- Lista editable -->
                            <ul id="pesoDosisEditList" class="list-group"></ul>

                        </div>

                    </div>
                </div>

                <!-- INFORMACIÓN COMERCIAL -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-dollar-sign"></i> Información Comercial</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="text-muted small">Precio Compra</label>
                            <p class="field-view fw-bold mb-0" data-field="precio_compra">-</p>
                            <input type="number" min="0" class="field-edit form-control d-none"
                                data-field="precio_compra">
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Precio Venta</label>
                            <p class="field-view fw-bold mb-0" data-field="precio_venta">-</p>
                            <input type="number" min="0" class="field-edit form-control d-none"
                                data-field="precio_venta">
                        </div>

                    </div>
                </div>
                <!-- INVENTARIO -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-boxes"></i> Inventario</h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="text-muted small">Stock Actual</label>
                            <p class="field-view fw-bold mb-0" data-field="stock_actual">-</p>
                            <input type="number" min="0" class="field-edit form-control d-none"
                                data-field="stock_actual">
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Stock Mínimo</label>
                            <p class="field-view mb-0" data-field="stock_minimo">-</p>
                            <input type="number" min="0" class="field-edit form-control d-none"
                                data-field="stock_minimo">
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Stock Máximo</label>
                            <p class="field-view mb-0" data-field="stock_maximo">-</p>
                            <input type="number" min="0" class="field-edit form-control d-none"
                                data-field="stock_maximo">
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Estado Producto</label>
                            <p class="field-view mb-0" id="estado_producto_auto">-</p>
                            <!-- No input aquí, es automático -->
                        </div>
                    </div>
                </div>
                <!-- PROVEEDOR -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-truck"></i> Proveedor</h6>

                    <div class="row g-3">
                        <div class="col-md-6 position-relative">
                            <label class="text-muted small">Proveedor</label>
                            <p class="field-view mb-0" data-field="proveedor">-</p>
                            <select class="field-edit form-control d-none" data-field="proveedor" id="selectProveedorIntegrado"
                                onchange="onProveedorIntegradoChange()">
                                
                                <option value="">Selecciona...</option>
                                <!-- Opciones de proveedores se llenan por JS -->
                                <option value="__nuevo__">+ Agregar nuevo proveedor...</option>
                            </select>
                            <div id="nuevoProveedorWrapper" class="mt-2 d-none">
                                <input type="text" class="form-control mb-1" id="inputNuevoProveedor" placeholder="Nuevo proveedor" onkeydown="if(event.key==='Enter'){agregarNuevoProveedorIntegrado();}">
                                <button type="button" class="vet-btn-grey btn btn-sm w-100" id="btnAgregarProveedor" onclick="agregarNuevoProveedorIntegrado()">Agregar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRECAUCIONES Y OTROS -->
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-exclamation-triangle"></i> Precauciones y Otros
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="text-muted small">Precauciones</label>
                            <p class="field-view mb-0" data-field="precauciones">-</p>
                            <textarea class="field-edit form-control d-none" data-field="precauciones"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="text-muted small">Contraindicaciones</label>
                            <p class="field-view mb-0" data-field="contraindicaciones">-</p>
                            <textarea class="field-edit form-control d-none" data-field="contraindicaciones"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="text-muted small">Efectos Adversos</label>
                            <p class="field-view mb-0" data-field="efectos_adversos">-</p>
                            <textarea class="field-edit form-control d-none" data-field="efectos_adversos"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-body" style="border-top:1px solid #eee; text-align:right;">
                <button type="button" class="vet-btn-grey" id="btnEditarProducto" onclick="switchToEditModeProducto()">
                    <i class="bi bi-pencil-fill"></i> Editar
                </button>
                <button type="button" class="vet-btn-grey d-none" id="btnGuardarProducto"
                    onclick="guardarProductoEditado()">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
                <button type="button" class="vet-btn-grey error" id="btnEliminarProducto"
                    onclick="abrirModalEliminarProducto(this)">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>


            </div>
        </div>
    </div>
</div>

<!-- Modal: Modificar Stock -->
<div class="vet-modal-overlay hide" id="modalModificarStock">
    <div class="vet-custom-modal" style="max-width: 400px;">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3><i class="fas fa-boxes"></i> Modificar Stock</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                    onclick="closeVetModal('modalModificarStock')"></i>
            </div>
            <div class="vet-modal-body" style="text-align:center;">
                <div style="margin-bottom: 18px;">
                    <span style="font-size: 1.1rem; color: #333;">
                        Stock actual: <span id="stockActualValor" style="font-weight: 600;">0</span>
                    </span>
                </div>
                <p>Ingresa la cantidad de producto a modificar:</p>
                <div style="display: flex; justify-content: center; margin-bottom: 10px;">
                    <input type="number" id="inputStockOperacion" class="form-control" style="width:150px;"
                        placeholder="Cantidad">
                </div>
                <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom: 10px;">
                    <button type="button" class="vet-btn-grey" onclick="sumarStockInput()">
                        <i class="bi bi-plus-circle"></i> Ingresar
                    </button>
                    <button type="button" class="vet-btn-grey" onclick="restarStockInput()">
                        <i class="bi bi-dash-circle"></i> Restar
                    </button>
                </div>
            </div>
            <div class="vet-modal-body" style="text-align:right;">
                <button type="button" class="vet-btn-grey success" id="btnGuardarProducto" onclick="guardarStock()">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Editar Producto -->
<div class="vet-modal-overlay hide" id="modalEditarProducto">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>Editar Producto</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                    onclick="closeVetModal('modalEditarProducto')"></i>
            </div>
            <div class="vet-modal-body">
                <p>Formulario para editar el producto.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Eliminar Producto -->
<div class="vet-modal-overlay hide" id="modalEliminarProducto">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #b71c1c;">
                <h3><i class="bi bi-trash3-fill"></i> Eliminar Producto</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;" onclick="closeEliminarProductoModal()"></i>

            </div>
            <div class="vet-modal-body">
                <p id="eliminarProductoMensaje">¿Estás seguro que deseas eliminar este producto?</p>
            </div>
            <div class="vet-modal-body" style="text-align:right;">
                <button type="button" class="vet-btn-grey error" id="btnConfirmarEliminarProducto">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/inventario/crud_inventario.js' %}"></script>
{% endblock %}