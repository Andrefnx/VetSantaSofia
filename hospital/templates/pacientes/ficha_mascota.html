{% extends 'partials/base.html' %}
{% load static %}

{% block title %}Ficha de {{ paciente.nombre }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/base/vet-custom.css' %}">
<link rel="stylesheet" href="{% static 'css/pacientes.css' %}">
{% endblock %}

{% block content %}
<div class="header">
    <h1>
        <i class="fas fa-paw"></i>
        <span class="view-mode">{{ paciente.nombre }}</span>
        <input type="text" class="form-control edit-mode" name="nombre" value="{{ paciente.nombre }}"
            style="display:none; max-width: 300px;">
    </h1>

    <div class="actions-area">

        <!-- Botón Editar (visible solo en modo vista) -->
        <button class="vet-btn vet-btn-primary" id="btnEditarFicha">
            <i class="bi bi-pencil-square"></i> Editar Ficha
        </button>

        <!-- Botones Guardar / Cancelar (ocultos inicialmente) -->
        <div id="btnEditActions" style="display:none;">
            <button class="vet-btn vet-btn-grey" id="btnCancelar">
                <i class="bi bi-x-lg"></i> Cancelar
            </button>
            <button class="vet-btn vet-btn-primary" id="btnGuardar" style="margin-left: 10px;">
                <i class="bi bi-check-lg"></i> Guardar
            </button>
        </div>

    </div>
</div>


<div class="general-container">
    <div class="general-information">
        <div class="section personal-info">
            <h2>Información General</h2>
            <div class="info" id="infoGeneral">
                <div class="info-row">
                    <p><strong>Especie:</strong> <span class="view-mode">{{ paciente.especie }}</span>
                        <select class="form-control edit-mode" name="especie" style="display:none;">
                            <option value="perro" {% if paciente.especie == 'perro' %}selected{% endif %}>Perro</option>
                            <option value="gato" {% if paciente.especie == 'gato' %}selected{% endif %}>Gato</option>
                            <option value="otro" {% if paciente.especie == 'otro' %}selected{% endif %}>Otro</option>
                        </select>
                    </p>
                    <p><strong>Raza:</strong> <span class="view-mode">{{ paciente.raza|default:"No especificada" }}</span>
                        <input type="text" class="form-control edit-mode" name="raza" value="{{ paciente.raza }}" style="display:none;">
                    </p>
                    <p><strong>Color:</strong> <span class="view-mode">{{ paciente.color|default:"No especificado" }}</span>
                        <input type="text" class="form-control edit-mode" name="color" value="{{ paciente.color }}" style="display:none;">
                    </p>
                    <p><strong>Sexo:</strong> 
                        <span class="view-mode">
                            {% if paciente.sexo == 'M' %}Macho{% elif paciente.sexo == 'H' %}Hembra{% else %}{{ paciente.sexo }}{% endif %}
                        </span>
                        <select class="form-control edit-mode" name="sexo" style="display:none;">
                            <option value="M" {% if paciente.sexo == 'M' %}selected{% endif %}>Macho</option>
                            <option value="H" {% if paciente.sexo == 'H' %}selected{% endif %}>Hembra</option>
                        </select>
                    </p>
                </div>
                
                <!-- Sección de Edad con diseño especial -->
                <div class="edad-section">
                    <p><strong>Edad:</strong> <span class="view-mode">{{ paciente.edad_formateada }}</span></p>
                    
                    <div class="edit-mode edad-edit-container" style="display:none;">
                        <div class="edad-option">
                            <label>
                                <input type="radio" name="tipo_edad" value="fecha" {% if paciente.fecha_nacimiento %}checked{% endif %}> 
                                <strong>Fecha de nacimiento</strong>
                            </label>
                            <input type="date" class="form-control" name="fecha_nacimiento" value="{{ paciente.fecha_nacimiento|date:'Y-m-d' }}" id="fechaNacimiento" {% if not paciente.fecha_nacimiento %}style="display:none;"{% endif %}>
                        </div>
                        
                        <div class="edad-option">
                            <label>
                                <input type="radio" name="tipo_edad" value="estimada" {% if not paciente.fecha_nacimiento %}checked{% endif %}> 
                                <strong>Edad estimada</strong>
                            </label>
                            <div id="edadEstimadaInputs" {% if paciente.fecha_nacimiento %}style="display:none;"{% endif %}>
                                <input type="number" class="form-control" name="edad_anos" value="{{ paciente.edad_anos|default:'' }}" placeholder="Años" min="0">
                                <input type="number" class="form-control" name="edad_meses" value="{{ paciente.edad_meses|default:'' }}" placeholder="Meses" min="0" max="11">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-row info-row-full">
                    <p><strong>Microchip:</strong> <span class="view-mode">{{ paciente.microchip|default:"No tiene" }}</span>
                        <input type="text" class="form-control edit-mode" name="microchip" value="{{ paciente.microchip }}" style="display:none;">
                    </p>
                </div>

                <!-- Sección de Observaciones -->
                {% if paciente.observaciones %}
                <div class="info-row">
                    <p><strong>Observaciones:</strong> <span class="view-mode">{{ paciente.observaciones }}</span>
                        <textarea class="form-control edit-mode" name="observaciones"
                            style="display:none;">{{ paciente.observaciones }}</textarea>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="section resumen-clinico">
            <h2>Resumen Clínico</h2>
            <div class="info">
                <div class="info-row">
                    <p><strong>Último peso registrado:</strong> {{ paciente.ultimo_peso_formateado }}</p>
                    <p><strong>Último control:</strong>
                        {% if paciente.fecha_ultimo_control %}
                        {{ paciente.fecha_ultimo_control|date:"d/m/Y H:i" }}
                        {% else %}
                        No registrado
                        {% endif %}
                    </p>
                </div>
                <p><strong>Fecha de registro:</strong> {{ paciente.fecha_registro|date:"d/m/Y" }}</p>
            </div>
        </div>

        <div class="section responsable">
            <h2>Responsable</h2>
            <div class="info">
                <div class="info-row">
                    <div>
                        <p><strong>Dueño:</strong> 
                            <span class="view-mode">{{ paciente.propietario.nombre_completo }}</span>
                        </p>
                        <div class="edit-mode" id="propietarioSelector" style="display:none;">
                            <input type="text" class="form-control" id="buscarPropietario"
                                placeholder="Buscar propietario..." autocomplete="off">
                            <div id="resultadosBusqueda" class="search-results" style="display:none;"></div>
                            <button type="button" class="vet-btn vet-btn-secondary" id="btnNuevoPropietario"
                                style="margin-top: 8px;">
                                <i class="bi bi-plus-circle"></i> Crear nuevo responsable
                            </button>
                        </div>
                        <div id="camposNombrePropietario" class="edit-mode" style="display:none;">
                            <input type="text" class="form-control" name="propietario_nombre_edit" placeholder="Nombre"
                                value="{{ paciente.propietario.nombre }}" style="margin-bottom: 8px;">
                            <input type="text" class="form-control" name="propietario_apellido_edit"
                                placeholder="Apellido" value="{{ paciente.propietario.apellido }}">
                            <input type="hidden" name="propietario_id" value="{{ paciente.propietario.id }}">
                        </div>
                    </div>
                    <p><strong>Teléfono:</strong>
                        <span class="view-mode">{{ paciente.propietario.telefono|default:"No registrado" }}</span>
                        <input type="text" class="form-control edit-mode" name="propietario_telefono"
                            value="{{ paciente.propietario.telefono }}" style="display:none;">
                    </p>
                    <p><strong>Correo Electrónico:</strong>
                        <span class="view-mode">{{ paciente.propietario.email|default:"No registrado" }}</span>
                        <input type="email" class="form-control edit-mode" name="propietario_email"
                            value="{{ paciente.propietario.email }}" style="display:none;">
                    </p>
                </div>
                <p><strong>Dirección:</strong>
                    <span class="view-mode">{{ paciente.propietario.direccion|default:"No registrada" }}</span>
                    <textarea class="form-control edit-mode" name="propietario_direccion"
                        style="display:none;">{{ paciente.propietario.direccion }}</textarea>
                </p>
            </div>
        </div>
    </div>

    <div class="section tabs-section">
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="historial">Historial Clínico</button>
            <button class="tab-btn" data-tab="hosp">Hospitalizaciones</button>
            <button class="tab-btn" data-tab="examenes">Exámenes</button>
            <button class="tab-btn" data-tab="docs">Documentos</button>
        </div>
        <div class="tabs-content">
            <div class="tab-content active" id="historial">
                <div class="historial-clinico">
                    <h3>Historial Clínico</h3>
                </div>

                <div class="timeline" id="timeline">
                    <div class="timeline-item new-event">
                        <button class="vet-btn vet-btn-primary" id="btnNuevaConsulta">
                            <i class="bi bi-plus-lg"></i> Nueva Consulta
                        </button>
                        <button class="vet-btn vet-btn-grey" id="btnAgendarCitaModal" style="margin-left:10px;">
                            <i class="bi bi-calendar-plus"></i> Agendar Cita
                        </button>
                    </div>

                    {% for consulta in consultas %}
                    <div class="timeline-item">
                        <div class="timeline-date">
                            <span class="month">{{ consulta.fecha|date:"M" }}</span>
                            <span class="year">{{ consulta.fecha|date:"Y" }}</span>
                        </div>
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <h3 class="event-title">{{ consulta.diagnostico|default:"Consulta general" }}</h3>
                            <p class="event-subtitle">
                                Veterinario: {{ consulta.veterinario.get_full_name|default:"No especificado" }}<br>
                                {{ consulta.fecha|date:"d/m/Y H:i" }}
                            </p>
                            {% if consulta.notas %}
                            <p class="event-notes">{{ consulta.notas|truncatewords:20 }}</p>
                            {% endif %}
                            <button class="timeline-btn" onclick="verDetalleConsulta({{ consulta.id }})">Ver
                                detalle</button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="timeline-item">
                        <div class="timeline-content" style="text-align: center; padding: 2rem; color: #999;">
                            <i class="bi bi-clipboard2-pulse" style="font-size: 3rem;"></i>
                            <p style="margin-top: 1rem;">No hay consultas registradas</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-content" id="hosp">
                <div class="hospitalizaciones">
                    <h3>Hospitalizaciones</h3>
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Fecha ingreso</th>
                                <th>Fecha alta</th>
                                <th>Motivo</th>
                                <th>Veterinario</th>
                                <th>Estado</th>
                                <th>Notas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hosp in hospitalizaciones %}
                            <tr>
                                <td>{{ hosp.fecha_ingreso|date:"d/m/Y H:i" }}</td>
                                <td>{{ hosp.fecha_alta|date:"d/m/Y H:i"|default:"-" }}</td>
                                <td>{{ hosp.motivo }}</td>
                                <td>{{ hosp.veterinario.get_full_name|default:"-" }}</td>
                                <td>
                                    <span
                                        class="badge bg-{% if hosp.estado == 'activa' %}warning{% elif hosp.estado == 'alta' %}success{% else %}danger{% endif %}">
                                        {{ hosp.get_estado_display }}
                                    </span>
                                </td>
                                <td>{{ hosp.notas|default:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
                                    No hay hospitalizaciones registradas
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="examenes">
                <div class="examenes">
                    <h3>Exámenes</h3>
                    <div style="margin-bottom: 1rem;">
                        <label class="vet-btn vet-btn-primary" style="cursor:pointer;">
                            <i class="bi bi-paperclip"></i> Adjuntar Examen
                            <input type="file" name="adjuntar_examen" style="display:none;"
                                onchange="subirExamen(this, {{ paciente.id }})">
                        </label>
                    </div>
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Veterinario</th>
                                <th>Resultado</th>
                                <th>Documento</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for examen in examenes %}
                            <tr>
                                <td>{{ examen.fecha|date:"d/m/Y" }}</td>
                                <td>{{ examen.tipo }}</td>
                                <td>{{ examen.veterinario.get_full_name|default:"-" }}</td>
                                <td>{{ examen.resultado|truncatewords:10 }}</td>
                                <td>
                                    {% if examen.archivo %}
                                    <a href="{{ examen.archivo.url }}" target="_blank" class="vet-link-exam">
                                        <i class="bi bi-file-earmark-text"></i> Ver archivo
                                    </a>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: #999;">
                                    No hay exámenes registrados
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="docs">
                <div class="documentos">
                    <h3>Documentos</h3>
                    <div style="margin-bottom: 1rem;">
                        <label class="vet-btn vet-btn-primary" style="cursor:pointer;">
                            <i class="bi bi-paperclip"></i> Adjuntar Documento
                            <input type="file" name="adjuntar_documento" style="display:none;"
                                onchange="subirDocumento(this, {{ paciente.id }})">
                        </label>
                    </div>
                    <ul class="list-group">
                        {% for doc in documentos %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ doc.nombre }}</strong>
                                {% if doc.descripcion %}
                                <br><small class="text-muted">{{ doc.descripcion }}</small>
                                {% endif %}
                                <br><small class="text-muted">{{ doc.fecha_subida|date:"d/m/Y H:i" }}</small>
                            </div>
                            <a href="{{ doc.archivo.url }}" target="_blank" class="vet-link-exam">
                                <i class="bi bi-file-earmark-text"></i> Descargar
                            </a>
                        </li>
                        {% empty %}
                        <li class="list-group-item" style="text-align: center; padding: 2rem; color: #999;">
                            No hay documentos adjuntos
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal Detalle Consulta -->
<div id="detalleConsultaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 id="detalleTitulo" style="margin:0;"><i class="bi bi-clipboard2-pulse"></i> Detalle de Consulta</h3>
            <i class="bi bi-x" id="closeDetalleModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <div class="vet-modal-body">
            <div class="row g-3">
                <!-- Columna izquierda: Datos fisiológicos -->
                <div class="col-md-4" id="detalleDatosMascota">
                    <div class="detail-section">
                        <div class="detail-section-title"><i class="bi bi-thermometer-half"></i> Temperatura</div>
                        <p id="detalleTemp">-</p>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><i class="bi bi-speedometer2"></i> Peso</div>
                        <p id="detallePeso">-</p>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><i class="bi bi-heart-pulse"></i> Frec. Cardíaca</div>
                        <p id="detalleFC">-</p>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><i class="bi bi-wind"></i> Frec. Respiratoria</div>
                        <p id="detalleFR">-</p>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><i class="bi bi-droplet-half"></i> Otros</div>
                        <p id="detalleOtros">-</p>
                    </div>
                </div>
                <!-- Columna derecha: Detalles de consulta -->
                <div class="col-md-8" id="detalleContenido">
                    <!-- Aquí se llenarán los detalles dinámicamente -->
                </div>
            </div>
        </div>
        <div class="vet-modal-footer d-flex justify-content-between align-items-center">
            <button id="editarConsultaBtn" class="vet-btn vet-btn-grey" title="Editar consulta">
                <i class="bi bi-pencil-square"></i> Editar consulta
            </button>
            <button class="vet-btn vet-btn-primary" id="btnAgendarCita">
                <i class="bi bi-calendar-plus"></i> Agendar próxima cita
            </button>
        </div>
    </div>
</div>

<!-- Modal Nueva Consulta -->
<div id="nuevaConsultaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-clipboard2-plus"></i> Nueva Consulta</h3>
            <i class="bi bi-x" id="closeNuevaConsultaModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formNuevaConsulta">
            <div class="vet-modal-body">
                <div class="row g-3">
                    <!-- Columna izquierda: Datos fisiológicos -->
                    <div class="col-md-4">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-thermometer-half"></i> Temperatura</div>
                            <input type="text" class="form-control" name="temp" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-speedometer2"></i> Peso</div>
                            <input type="text" class="form-control" name="peso" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-heart-pulse"></i> Frec. Cardíaca</div>
                            <input type="text" class="form-control" name="fc">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-wind"></i> Frec. Respiratoria</div>
                            <input type="text" class="form-control" name="fr">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-droplet-half"></i> Otros</div>
                            <input type="text" class="form-control" name="otros">
                        </div>
                    </div>
                    <!-- Columna derecha: Detalles de consulta -->
                    <div class="col-md-8">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-person-badge"></i> Médico Tratante</div>
                            <input type="text" class="form-control" name="medico"
                                value="{{ user.nombre }} {{ user.apellido }}" readonly style="background:#f3f3f3;">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-calendar-event"></i> Fecha</div>
                            <input type="text" class="form-control" name="fecha" value="{% now 'd/m/Y' %}" readonly
                                style="background:#f3f3f3;">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-clipboard2-check"></i> Diagnóstico</div>
                            <input type="text" class="form-control" name="diagnostico">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-capsule"></i> Tratamiento</div>
                            <input type="text" class="form-control" name="tratamiento">
                        </div>
                        <!-- Exámenes oculto -->
                        <div class="detail-section" style="display:none;">
                            <div class="detail-section-title"><i class="bi bi-file-earmark-medical"></i> Exámenes</div>
                            <input type="text" class="form-control" name="examenes" placeholder="Separar por coma">
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-journal-text"></i> Notas</div>
                            <textarea class="form-control" name="notas"></textarea>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-lightbulb"></i> Recomendaciones</div>
                            <input type="text" class="form-control" name="recomendaciones">
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-between align-items-center">
                <span></span>
                <button type="submit" class="vet-btn vet-btn-primary" id="btnAgendarNuevaCita">
                    <i class="bi bi-calendar-plus"></i> Agendar y guardar en historial
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Agendar Cita -->
<div id="agendarCitaModal" class="vet-modal-overlay hide">
    <div class="vet-custom-modal">
        <div class="vet-custom-modal-title">
            <h3 style="margin:0;"><i class="bi bi-calendar-plus"></i> Agendar Cita</h3>
            <i class="bi bi-x" id="closeAgendarCitaModal" tabindex="0" role="button" aria-label="Cerrar"></i>
        </div>
        <form id="formAgendarCita">
            <div class="vet-modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-calendar-event"></i> Fecha</div>
                            <input type="date" class="form-control" name="fecha" required>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-clock"></i> Hora</div>
                            <input type="time" class="form-control" name="hora" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-list-task"></i> Tipo de Cita</div>
                            <select class="form-control" name="tipo" required>
                                <option value="">Seleccione tipo</option>
                                <option value="hospitalizacion">Hospitalización</option>
                                <option value="consulta">Consulta general</option>
                                <option value="control">Control</option>
                                <option value="vacunacion">Vacunación</option>
                            </select>
                        </div>
                        <div class="detail-section">
                            <div class="detail-section-title"><i class="bi bi-journal-text"></i> Notas</div>
                            <textarea class="form-control" name="notas"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-footer d-flex justify-content-between align-items-center">
                <span></span>
                <button type="submit" class="vet-btn vet-btn-primary">
                    <i class="bi bi-calendar-plus"></i> Agendar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/base/tabs.js' %}"></script>
<script src="{% static 'js/pacientes/historial_medico.js' %}"></script>

<script src="{% static 'js/pacientes/editar_ficha.js' %}"></script>
{% endblock %}