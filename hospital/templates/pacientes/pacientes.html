{% extends "partials/base_table.html" %}
{% load static %}

{% block title %}Pacientes{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/base/tables_base.css' %}?v=4" type="text/css" media="all">
<link rel="stylesheet" href="{% static 'css/base/modals_base.css' %}?v=4" type="text/css" media="all">
{% endblock %}

{% block table_title %}
<i class="fas fa-paw"></i> Pacientes
{% endblock %}

{% block table_filters %}
<div class="filter-group">
    <div class="vet-custom-select-wrapper">
        <span class="tag_select">Especie</span>
        <div class="vet-custom-select">
            <span class="vet-selected-value placeholder">{% if especie_filter == 'canino' %}Canino{% elif especie_filter == 'felino' %}Felino{% else %}Todas{% endif %}</span>
            <div class="vet-arrow"></div>
        </div>
        <ul class="vet-custom-select-dropdown">
            <li data-value="">Todas</li>
            <li data-value="canino">Canino</li>
            <li data-value="felino">Felino</li>
        </ul>
        <input type="hidden" id="filterEspecie" value="{{ especie_filter }}">
    </div>
    <div class="vet-custom-select-wrapper">
        <span class="tag_select">Sexo</span>
        <div class="vet-custom-select">
            <span class="vet-selected-value placeholder">{% if sexo_filter == 'macho' %}Macho{% elif sexo_filter == 'hembra' %}Hembra{% else %}Todos{% endif %}</span>
            <div class="vet-arrow"></div>
        </div>
        <ul class="vet-custom-select-dropdown">
            <li data-value="">Todos</li>
            <li data-value="macho">Macho</li>
            <li data-value="hembra">Hembra</li>
        </ul>
        <input type="hidden" id="filterSexo" value="{{ sexo_filter }}">
    </div>
    <!-- Puedes agregar más filtros aquí -->
</div>
{% endblock %}

{% block table_buttons %}
<button type="button" onclick="abrirModalNuevoPaciente()">
    <i class="fas fa-plus-circle"></i> Nuevo Paciente
</button>
{% endblock %}

{% block table_columns %}
<th>Nombre</th>
<th>Especie</th>
<th>Raza</th>
<th>Edad</th>
<th>Sexo</th>
<th>Propietario</th>
<th>Gestión</th>
{% endblock %}

{% block table_rows %}
{% for mascota in mascotas %}
<tr data-mascota-id="{{ mascota.idMascota }}">
    <td>{{ mascota.nombreMascota }}</td>
    <td>{{ mascota.animal_mascota }}</td>
    <td>{{ mascota.raza_mascota }}</td>
    <td>{{ mascota.edad }} años</td>
    <td>{{ mascota.sexo }}</td>
    <td>{{ mascota.idCliente.nombreCliente }}</td>
    <td>
        <div class="manage-wheel">
            <button type="button" onclick="toggleWheel(this)">
                <i class="fas fa-cog"></i>
            </button>
            <div class="manage-options" style="display: none;">
                <a href="{% url 'ficha_mascota' mascota.idMascota %}">
                    <i class="bi bi-eye"></i> Ver Ficha
                </a>
                <button type="button" onclick="abrirModalPaciente(this, 'edit')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" onclick="abrirModalEliminarPaciente(this)">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="7">No hay pacientes registrados.</td>
</tr>
{% endfor %}
{% endblock %}

{% block modals %}

<!-- Modal: Nuevo Paciente -->
<div class="vet-modal-overlay hide" id="modalNuevoPaciente">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>Nuevo Paciente</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;"
                    onclick="closeVetModal('modalNuevoPaciente')"></i>
            </div>
            <div class="vet-modal-body">
                <form id="addPacienteForm">
                    {% csrf_token %}
                    <div class="detail-section mb-4">
                        <h6 class="detail-section-title"><i class="fas fa-paw"></i> Información de la Mascota</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label>Nombre</label>
                                <input type="text" class="form-control" name="nombre" required>
                            </div>
                            <div class="col-md-6">
                                <label>Especie</label>
                                <select class="form-control" name="especie" required>
                                    <option value="">Selecciona...</option>
                                    <option value="canino">Canino</option>
                                    <option value="felino">Felino</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Raza</label>
                                <input type="text" class="form-control" name="raza">
                            </div>
                            <div class="col-md-6">
                                <label>Edad</label>
                                <input type="number" class="form-control" name="edad">
                            </div>
                            <div class="col-md-6">
                                <label>Sexo</label>
                                <select class="form-control" name="sexo" required>
                                    <option value="">Selecciona...</option>
                                    <option value="macho">Macho</option>
                                    <option value="hembra">Hembra</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Peso (kg)</label>
                                <input type="number" step="0.01" class="form-control" name="peso">
                            </div>
                        </div>
                    </div>
                    <div class="detail-section mb-4">
                        <h6 class="detail-section-title"><i class="fas fa-user"></i> Información del Propietario</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label>RUT</label>
                                <input type="number" class="form-control" name="rutCliente" required>
                            </div>
                            <div class="col-md-6">
                                <label>DV</label>
                                <input type="number" min="0" max="9" class="form-control" name="dvCliente" required>
                            </div>
                            <div class="col-md-12">
                                <label>Nombre Completo</label>
                                <input type="text" class="form-control" name="nombreCliente" required>
                            </div>
                            <div class="col-md-6">
                                <label>Teléfono</label>
                                <input type="tel" class="form-control" name="telCliente">
                            </div>
                            <div class="col-md-6">
                                <label>Email</label>
                                <input type="email" class="form-control" name="emailCliente">
                            </div>
                            <div class="col-md-12">
                                <label>Dirección</label>
                                <input type="text" class="form-control" name="direccion">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="vet-modal-body" style="text-align:right;">
                <button type="button" class="vet-btn-grey success" onclick="saveNewPaciente()">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ver/Editar Paciente -->
<div class="vet-modal-overlay hide" id="modalPaciente">
    <div class="vet-custom-modal" style="max-width: 900px; width: 100%;">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title">
                <h3>
                    <i class="fas fa-paw"></i>
                    <span id="modalPacienteTitulo">Detalles del Paciente</span>
                </h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;" onclick="closePacienteModal()"></i>
            </div>
            <div class="vet-modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-paw"></i> Información de la Mascota</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="text-muted small">Nombre</label>
                            <p class="field-view fw-bold mb-0" data-field="nombre">-</p>
                            <input class="field-edit form-control d-none" data-field="nombre">
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Especie</label>
                            <p class="field-view mb-0" data-field="especie">-</p>
                            <select class="field-edit form-control d-none" data-field="especie">
                                <option value="">Selecciona...</option>
                                <option value="canino">Canino</option>
                                <option value="felino">Felino</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Raza</label>
                            <p class="field-view mb-0" data-field="raza">-</p>
                            <input class="field-edit form-control d-none" data-field="raza">
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Edad</label>
                            <p class="field-view fw-bold mb-0" data-field="edad">-</p>
                            <input class="field-edit form-control d-none" data-field="edad" type="number">
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Sexo</label>
                            <p class="field-view mb-0" data-field="sexo">-</p>
                            <select class="field-edit form-control d-none" data-field="sexo">
                                <option value="">Selecciona...</option>
                                <option value="macho">Macho</option>
                                <option value="hembra">Hembra</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Peso (kg)</label>
                            <p class="field-view mb-0" data-field="peso">-</p>
                            <input class="field-edit form-control d-none" data-field="peso" type="number" step="0.01">
                        </div>
                    </div>
                </div>
                <div class="detail-section mb-4">
                    <h6 class="detail-section-title"><i class="fas fa-user"></i> Información del Propietario</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted small">RUT</label>
                            <p class="field-view fw-bold mb-0" data-field="rutCliente">-</p>
                            <input class="field-edit form-control d-none" data-field="rutCliente" type="number">
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">DV</label>
                            <p class="field-view mb-0" data-field="dvCliente">-</p>
                            <input class="field-edit form-control d-none" data-field="dvCliente" type="number" min="0" max="9">
                        </div>
                        <div class="col-md-12">
                            <label class="text-muted small">Nombre Completo</label>
                            <p class="field-view mb-0" data-field="nombreCliente">-</p>
                            <input class="field-edit form-control d-none" data-field="nombreCliente">
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Teléfono</label>
                            <p class="field-view mb-0" data-field="telCliente">-</p>
                            <input class="field-edit form-control d-none" data-field="telCliente" type="tel">
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Email</label>
                            <p class="field-view mb-0" data-field="emailCliente">-</p>
                            <input class="field-edit form-control d-none" data-field="emailCliente" type="email">
                        </div>
                        <div class="col-md-12">
                            <label class="text-muted small">Dirección</label>
                            <p class="field-view mb-0" data-field="direccion">-</p>
                            <input class="field-edit form-control d-none" data-field="direccion">
                        </div>
                    </div>
                </div>
            </div>
            <div class="vet-modal-body" style="border-top:1px solid #eee; text-align:right;">
                <button type="button" class="vet-btn-grey" id="btnEditarPaciente" onclick="switchToEditModePaciente()">
                    <i class="bi bi-pencil-fill"></i> Editar
                </button>
                <button type="button" class="vet-btn-grey d-none" id="btnGuardarPaciente"
                    onclick="guardarPacienteEditado()">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
                <button type="button" class="vet-btn-grey error" id="btnEliminarPaciente"
                    onclick="abrirModalEliminarPaciente(this)">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Eliminar Paciente -->
<div class="vet-modal-overlay hide" id="modalEliminarPaciente">
    <div class="vet-custom-modal">
        <div class="vet-modal-content">
            <div class="vet-custom-modal-title" style="background: #b71c1c;">
                <h3><i class="bi bi-trash3-fill"></i> Eliminar Paciente</h3>
                <i class="bi bi-x" style="margin-left:auto;cursor:pointer;" onclick="closeEliminarPacienteModal()"></i>
            </div>
            <div class="vet-modal-body">
                <p id="eliminarPacienteMensaje">¿Estás seguro que deseas eliminar este paciente?</p>
            </div>
            <div class="vet-modal-body" style="text-align:right;">
                <button type="button" class="vet-btn-grey error" id="btnConfirmarEliminarPaciente">
                    <i class="bi bi-trash3-fill"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/base/modals_base.js' %}"></script>
<script src="{% static 'js/pacientes/pacientes.js' %}"></script>
{% endblock %}
